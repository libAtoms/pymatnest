<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ns_run &#8212; ns_doc 1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css?v=1476913b" />
    
    <script src="../_static/documentation_options.js?v=29a6c3e3"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">ns_doc 1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ns_run</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ns_run</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">ase</span><span class="o">,</span> <span class="nn">ase.io</span>
<span class="kn">import</span> <span class="nn">ns_rng</span>
<span class="kn">import</span> <span class="nn">stacktrace</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">pick_interconnected_clump</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matscipy.neighbours</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">traceback</span> <span class="kn">import</span> <span class="n">print_exception</span>

<span class="kn">import</span> <span class="nn">check_memory</span>
<span class="kn">from</span> <span class="nn">ase.md.verlet</span> <span class="kn">import</span> <span class="n">VelocityVerlet</span>
<span class="kn">import</span> <span class="nn">importlib</span>

<span class="n">print_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="usage">
<a class="viewcode-back" href="../ns_run.html#ns_run.usage">[docs]</a>
<span class="k">def</span> <span class="nf">usage</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Print help to the standard output about the usage of the code and input parameters. The current list of parameters is the following:</span>

<span class="sd">.. glossary::</span>

<span class="sd">    ``max_volume_per_atom=float``</span>
<span class="sd">       | Maximum volume per atom allowed during the run.</span>
<span class="sd">       | default: 1.0e3</span>

<span class="sd">    ``min_volume_per_atom=float``</span>
<span class="sd">       | Minimum volume per atom allowed during the run.</span>
<span class="sd">       | default: 1.0</span>

<span class="sd">    ``start_species=int int [ float ] [, int int [ float ] ... ]``</span>
<span class="sd">       | MANDATORY (or start_config_file)</span>
<span class="sd">       | Atomic number; multiplicity; [ not recommended: mass (amu) ]. Info repeated for each species, separated by commas, mass is optional and not recommended.</span>

<span class="sd">    ``start_config_file=str``</span>
<span class="sd">       | MANDATORY (or start_species)</span>
<span class="sd">       | Name of file to read in for atom information</span>
<span class="sd">       | default: &#39;&#39;</span>

<span class="sd">    ``keep_atoms_fixed=int ``</span>
<span class="sd">       | Number of atoms to fix in surface simulation. </span>

<span class="sd">    ``apply_Z_wall=[T|F] ``</span>
<span class="sd">       | Whether to have a boundary in the Z direction to keep free particles reaching the other side of &quot;surface&quot; layer due to periodic boundary conditions.</span>
<span class="sd">       | This functionality is not fully tested! Recommended use with MC evaluator and fortran. If constructing a surface layer, make it parallel to the XY plane and set the X dimension with the &quot;wall&quot; taken into account, no atoms should violate the wall restriction initially!!!</span>
<span class="sd">       | If True, the wall is set at 10 angstroms below the top of the simulation cell.</span>

<span class="sd">    ``restart_file=path_to_file``</span>
<span class="sd">       | File for restart configs. Mutually exclusive with ``start_*``, one is required. The file should contain the state of the walkers to continue from along with the restart iteration number. Normally such a file can be the concatenated snapshot files.</span>

<span class="sd">    ``n_walkers=int``</span>
<span class="sd">       | MANDATORY</span>
<span class="sd">       | Total number of walkers, i.e. the size of the live set used. It has to be the multiple of the number of processors used and it also has to be larger than the number of processors.</span>

<span class="sd">    ``n_cull=int``</span>
<span class="sd">       | Number of walkers to kill at each NS iteration. Use of default 1 is strongly recommended.</span>
<span class="sd">       | deafult: 1</span>

<span class="sd">    ``n_extra_walk_per_task=int``</span>
<span class="sd">       | default: 0</span>

<span class="sd">    ``n_iter_times_fraction_killed=int``</span>
<span class="sd">       | MANDATORY</span>
<span class="sd">       | Number of nested sampling iteration cycles performed per walker. Thus the total number of iterations will be ``n_iter_times_fraction_killed`` / ``(n_cull/n_walkers)``. Either this or ``converge_down_to_T`` is required.</span>

<span class="sd">    ``converge_down_to_T=flot``</span>
<span class="sd">       | MANDATORY</span>
<span class="sd">       | temperature down to which Z(T) should be converged.  Either this or ``n_iter_times_fraction_killed`` is required.</span>

<span class="sd">    ``T_estimate_finite_diff_lag=int``</span>
<span class="sd">       | default: 1000</span>
<span class="sd">       | Lag (in iterations) for doing d log Omega / d E finite difference derivative</span>

<span class="sd">    ``min_Emax=float``</span>
<span class="sd">       | Termination condition based on Emax: if this value is reached, the iteration will stop.</span>
<span class="sd">       | No default.</span>

<span class="sd">    ``out_file_prefix=str``</span>
<span class="sd">       | String used as prefix for the different output files.</span>
<span class="sd">       | No default.</span>

<span class="sd">    ``energy_calculator= ( ASE | lammps | internal | fortran)``</span>
<span class="sd">       | Energy calculator.</span>
<span class="sd">       | default: fortran</span>

<span class="sd">    ``n_extra_data=int``</span>
<span class="sd">       | Amount of extra data per atom to pass around.</span>
<span class="sd">       | default: 0</span>

<span class="sd">    ``KEmax_max_T=float``</span>
<span class="sd">       | If &gt; 0, maximum temperature for estimating KEmax.  For constant *P* ensemble 3/2 P Vmax will be used if KEmax_max_T is &lt; 0.</span>
<span class="sd">       | default: -1</span>

<span class="sd">    ``kB=float``</span>
<span class="sd">       | Boltzmann constant</span>
<span class="sd">       | default: 8.6173324e-5 (eV/A)</span>

<span class="sd">    ``start_energy_ceiling_per_atom=float``</span>
<span class="sd">       | Maximum potential energy per atom for initial configurations.  P*Vmax is added to this automatically in case of NpT runs.</span>
<span class="sd">       | default: 1.0e9</span>

<span class="sd">    ``start_energy_ceiling=float``</span>
<span class="sd">       | DEPRECATED: use ``start_energy_ceiling_per_atom``. Maximum potential energy for initial configurations.  P*Vmax is added to this automatically in case of NpT runs.</span>
<span class="sd">       | default: 1.0e9</span>

<span class="sd">    ``random_init_max_n_tries=int``</span>
<span class="sd">       | Maximum number of tries to create initial random atomic configuration</span>
<span class="sd">       | default 100</span>

<span class="sd">    ``n_model_calls_expected=int``</span>
<span class="sd">       | Total number of model calls performed during the random walk, expected by the user. The actual number of model calls performed during runtime can be different: this number is divided up among the processors in case of running parallel, and in order to make sure different processors perform about the same number of calls, it can be increased for some. (It is recommended to use n_model_calls_expected/[number of processors] &gt; 20) Either this or the keyword ``n_model_calls`` is mandatory, but the use of this keyword is strongly recommended. If &lt; 0, value will be set to _sum_ of each type of steps (accounting for atom_traj_len), so ``n_*_steps`` will be setting the _number_ of calls, rather than just the ratios.</span>
<span class="sd">       | default: 0</span>

<span class="sd">    ``n_model_calls=int``</span>
<span class="sd">       | Number of model calls performed during the random walk. This is the actual number of calls performed, ideally the program sets its value depending on n_model_calls_expected and the number of processors used. Either this or the keyword ``n_model_calls_expected`` is mandatory, though the usage of the latter is strongly recommended.</span>
<span class="sd">       | default: 0</span>

<span class="sd">    ``do_good_load_balance=[T | F]``</span>
<span class="sd">       | Whether to do steps in groups with good load balance</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``n_atom_steps=int``</span>
<span class="sd">       | Ratio of atomic trajectories will be determined by ``n_atom_steps``/SUM(``n_*_steps``).</span>
<span class="sd">       | default: 1</span>

<span class="sd">    ``atom_traj_len=int``</span>
<span class="sd">       | Length of atomic trajectory (MD steps or MC sweeps) in each atomic type step.</span>
<span class="sd">       | default: 8</span>

<span class="sd">    ``atom_traj_len_cost_multiplier=int``</span>
<span class="sd">       | Multiplier for cost of an atomic step (set to 1 for MD, TE-HMC, and SP-MC with O(1) cost moves, N for naive SP-MC)</span>
<span class="sd">       | default: 1</span>

<span class="sd">    ``break_up_atom_traj=[T | F]``</span>
<span class="sd">       | Whether to intersperse ``n_atom_steps`` atomic sub-trajectories with other types of steps.</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``n_cell_volume_steps=int``</span>
<span class="sd">       | Ratio of cell volume steps will be determined by ``n_cell_volume_steps``/SUM(``n_*_steps``).</span>
<span class="sd">       | default: 1</span>

<span class="sd">    ``n_cell_shear_steps=int``</span>
<span class="sd">       | Ratio of cell shear steps will be determined by ``n_cell_shear_steps``/SUM(``n_*_steps``).</span>
<span class="sd">       | default: 1</span>

<span class="sd">    ``n_cell_stretch_steps=int``</span>
<span class="sd">       | Ratio of cell stretch steps will be determined by ``n_cell_stretch_steps``/SUM(``n_*_steps``).</span>
<span class="sd">       | default: 1</span>

<span class="sd">    ``n_swap_steps=int``</span>
<span class="sd">       | Ratio of species swap steps will be determined by ``n_swap_steps``/SUM(``n_*_steps``). It has to be set other than zero for a multicomponent system.</span>
<span class="sd">       | default: 0</span>

<span class="sd">    ``swap_max_cluster=int``</span>
<span class="sd">       | Maximum size of interconnected cluster to try to swap.</span>
<span class="sd">       | default: 1</span>

<span class="sd">    ``swap_r_cut=float``</span>
<span class="sd">       | Cutoff radius for defining connected atoms for cluster.</span>
<span class="sd">       | default: 2.5</span>

<span class="sd">    ``swap_cluster_probability_increment=float``</span>
<span class="sd">       | Factor between prob. of picking increasing larger clusters.</span>
<span class="sd">       | default: 0.75</span>

<span class="sd">    ``swap_velo=[T | F]``</span>
<span class="sd">       | If true, swap velocities when swapping atoms, breaking coherence a bit.</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``no_swap_velo_fix_mag_alt=[T | F]``</span>
<span class="sd">       | If true, use alternate method for correcting velocity magnitudes when not swapping velocities.</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``n_semi_grand_steps=int``</span>
<span class="sd">       | Ratio of species type-change steps will be determined by ``n_semi_grand_steps``/SUM(``n_*_steps``). Only makes sense for a multicomponent system.</span>
<span class="sd">       | default: 0</span>

<span class="sd">    ``semi_grand_potentials=Z1 : mu1 [, Z2 : mu2 ...]``</span>
<span class="sd">       | Chemical potentials for semi-grand canonical species-type transmutations</span>
<span class="sd">       | default: &#39;&#39;</span>

<span class="sd">    ``velo_traj_len=int``</span>
<span class="sd">       | Number of MC steps in (optional) explicit velocity MC trajectory.</span>
<span class="sd">       | default: 0</span>

<span class="sd">    ``random_energy_perturbation=float``</span>
<span class="sd">       | default: 1.0e-12</span>

<span class="sd">    ``atom_algorithm=[MC | MD | GMC]``</span>
<span class="sd">       | MANDATORY</span>
<span class="sd">       | Use either Monte Carlo or Molecular dynamics to explore. GMC is an alias for atom_algorithm=MC, MC_atom_Galilean=True.</span>

<span class="sd">    ``MC_atom_velocities=[T | F]``</span>
<span class="sd">       | This keyword is supported only for energy_calculator=fortran.</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``MC_atom_velocities_pre_perturb=[T | F]``</span>
<span class="sd">       | Perturb velocities (rejection free) before MC + velocities walk.</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``MC_atom_step_size=float``</span>
<span class="sd">       | Initial atom move step size in units of (max_volume_per_atom * N_atoms)^(1/3)</span>
<span class="sd">       | default: 1.0</span>

<span class="sd">    ``MC_atom_step_size_max=float``</span>
<span class="sd">       | Maximum atom step size in units of (max_volume_per_atom * N_atoms)^(1/3).</span>
<span class="sd">       | default: 1.0</span>

<span class="sd">    ``MC_atom_uniform_rv=[T | F]``</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``MC_atom_Galilean=[T | F]``</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``GMC_no_reverse=[T | F]``</span>
<span class="sd">       | default: T</span>

<span class="sd">    ``MD_atom_velo_pre_perturb=[T | F]``</span>
<span class="sd">       | Perturb velocities before MD trajectory</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``MD_atom_velo_post_perturb=[T | F]``</span>
<span class="sd">       | Perturb velocities after MD trajectory</span>
<span class="sd">       | default: T</span>

<span class="sd">    ``MD_atom_velo_flip_accept=[T | F]``</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``MD_atom_timestep=float``</span>
<span class="sd">       | default: 0.1 (ASE time units)</span>

<span class="sd">    ``MD_atom_timestep_max=float``</span>
<span class="sd">       | default: 2.0 (ASE time units)</span>

<span class="sd">    ``MD_atom_energy_fuzz=float``</span>
<span class="sd">       | Tolerance for rejecting non-energy conserving trajectories, as fraction of Kinetic Energy</span>
<span class="sd">       | default: 1.0e-2</span>

<span class="sd">    ``MD_atom_reject_energy_violation=[ T | F ]``</span>
<span class="sd">       | Use energy conservation violation (exceeding MD_atom_energy_fuzz * KE) to reject MD trajectories.</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``python_MD=[ T | F ]``</span>
<span class="sd">       | Do MD using python code rather than underlying driver</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``atom_velo_rej_free_fully_randomize=[T | F]``</span>
<span class="sd">       | If true, randomize velocities completely rather than just perturbing.</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``atom_velo_rej_free_perturb_angle=float``</span>
<span class="sd">       | Max angle in radians for random rotations.</span>
<span class="sd">       | default: 0.3</span>

<span class="sd">    ``MC_atom_velo_step_size=float``</span>
<span class="sd">       | default: 50.0</span>

<span class="sd">    ``MC_atom_velo_step_size_max=float``</span>
<span class="sd">       | default: 10000.0</span>

<span class="sd">    ``MC_atom_velo_walk_rej_free=[T | F]``</span>
<span class="sd">       | default: T. If true, use rejection free algorithm for MC_atom_walk</span>

<span class="sd">    ``MC_cell_P=float``</span>
<span class="sd">       | Pressure value to be used. The unit of pressure depends on both the energy calculator and on the potential model used. Note that ASE uses</span>
<span class="sd">       | eV as energy and Angstrom as distance units everywhere, thus this case the pressure in the input have to be eV/Angstrom^3 (in case of using LAMMPS</span>
<span class="sd">       | the lammpslib module will convert the units for lammps to whatever units are set by the potential type)</span>
<span class="sd">       | default: 0.0</span>

<span class="sd">    ``MC_cell_flat_V_prior=[T | F]``</span>
<span class="sd">       | Flat prior for V (use with MC_cell_P=0 and cell moves, requires reweighting configurations when analyzing)</span>
<span class="sd">       | POORLY TESTED, DO NOT TRUST (YET).</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``MC_cell_volume_per_atom_step_size=float``</span>
<span class="sd">       | Initial volume stepsize for volume change.</span>
<span class="sd">       | default: 5% of the maximum allowed volume</span>

<span class="sd">    ``MC_cell_volume_per_atom_step_size_max=float``</span>
<span class="sd">       | Maximum allowed volume step size.</span>
<span class="sd">       | default: 50% of the maximum allowed volume</span>

<span class="sd">    ``MC_cell_volume_per_atom_prob=float``</span>
<span class="sd">       | default: 1.0</span>

<span class="sd">    ``MC_cell_stretch_step_size=float``</span>
<span class="sd">       | default: 0.1</span>

<span class="sd">    ``MC_cell_stretch_step_size_max=float``</span>
<span class="sd">       | default: 1.0</span>

<span class="sd">    ``MC_cell_stretch_prob=float``</span>
<span class="sd">       | default: 1.0</span>

<span class="sd">    ``MC_cell_shear_step_size=float``</span>
<span class="sd">       | default: 0.1, in units of (max_volume_per_atom * N_atoms)^(1/3)</span>

<span class="sd">    ``MC_cell_shear_step_size_max=float``</span>
<span class="sd">       | default: 1.0, in units of (max_volume_per_atom * N_atoms)^(1/3)</span>

<span class="sd">    ``MC_cell_shear_prob=float``</span>
<span class="sd">       | default: 1.0</span>

<span class="sd">    ``MC_cell_min_aspect_ratio=float``</span>
<span class="sd">       | Smallest allowed distance between parallel faces for cell normalised to unit volume. A higher value of ``MC_cell_min_aspect_ratio`` restricts the system to more cube-like cell shapes, while a low value allows the system to become essentially flat. In case of 64 atoms the use of ``MC_cell_min_aspect_ratio`` &lt; 0.65 *does* effect the melting transition.</span>
<span class="sd">       | default: 0.8</span>

<span class="sd">    ``cell_shape_equil_steps=int``</span>
<span class="sd">       | default: 1000</span>

<span class="sd">    ``full_auto_step_sizes=[T | F]``</span>
<span class="sd">       | If true (T), automatically calibrate all sizes by performing additional short explorations, including at the start of run. If false (F), use initial input step sizes and make small adjustments to these during the run.</span>
<span class="sd">       | default: T</span>

<span class="sd">    ``monitor_step_interval_times_fraction_killed=float``</span>
<span class="sd">     | Divided by ``n_cull/n_walkers`` to get actual monitoring interval in iterations, negative for only using last iteration, 0 for no monitoring</span>
<span class="sd">     | default: 1</span>

<span class="sd">    ``adjust_step_interval_times_fraction_killed=float``</span>
<span class="sd">     | Divided by ``n_cull/n_walkers`` to get actual step adjustment interval in iterations, negative for only using last iteration, 0 for no adjust.</span>
<span class="sd">     | default: 1</span>

<span class="sd">    ``MC_adjust_step_factor=float``</span>
<span class="sd">       |  default: 1.1</span>

<span class="sd">    ``MC_adjust_min_rate=float``</span>
<span class="sd">       |  default: 0.25</span>

<span class="sd">    ``MC_adjust_max_rate=float``</span>
<span class="sd">       |  default: 0.75</span>

<span class="sd">    ``GMC_adjust_min_rate=float``</span>
<span class="sd">       |  default: 0.25</span>

<span class="sd">    ``GMC_adjust_max_rate=float``</span>
<span class="sd">       |  default: 0.75</span>

<span class="sd">    ``GMC_dir_perturb_angle=float``</span>
<span class="sd">       |  default: -1.0</span>

<span class="sd">    ``GMC_dir_perturb_angle_during=float``</span>
<span class="sd">       |  default: 0.0</span>

<span class="sd">    ``MD_adjust_step_factor=float``</span>
<span class="sd">       |  default: 1.1</span>

<span class="sd">    ``MD_adjust_min_rate=float``</span>
<span class="sd">       |  default: 0.5</span>

<span class="sd">    ``MD_adjust_max_rate=float``</span>
<span class="sd">       |  default: 0.95</span>

<span class="sd">    ``ASE_calc_module=str``</span>
<span class="sd">       |  MANDATORY if energy_calculator=ASE</span>

<span class="sd">    ``FORTRAN_model=str``</span>
<span class="sd">       |  MANDATORY if energy_calculator=fortran</span>

<span class="sd">    ``FORTRAN_model_params=str``</span>
<span class="sd">       |  parameters (optional) for fortran model</span>

<span class="sd">    ``LAMMPS_fix_gmc=[T | F]``</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``LAMMPS_init_cmds=str``</span>
<span class="sd">       |  MANDATORY if energy_calculator=lammps</span>

<span class="sd">    ``LAMMPS_name=str``</span>
<span class="sd">       |  &#39;&#39;, arch name for lammps shared object file</span>

<span class="sd">    ``LAMMPS_serial=[T | F]``</span>
<span class="sd">       |  default True, lammps library is serial so do not pass COMM_SELF as a communicator</span>

<span class="sd">    ``LAMMPS_header=str``</span>
<span class="sd">       |  lammpslib.py value default, override lammpslib.py header commands for energy_calculator=lammps</span>

<span class="sd">    ``LAMMPS_header_extra=str``</span>
<span class="sd">       |  &#39;&#39;, extra lammpslib.py header commands for energy_calculator=lammps</span>

<span class="sd">    ``LAMMPS_atom_types=str``</span>
<span class="sd">       |  MANDATORY if energy_calculator=lammps</span>
<span class="sd">       |  atomic_symbol1 lammps_type1 [, atomic_symbol2 lammps_type2, ...]</span>
<span class="sd">       |  mapping between atom species and lammps potential types</span>

<span class="sd">    ``config_file_format=str``</span>
<span class="sd">       | File format in which configurations are printed, e.g. for trajectory and snapshot files.</span>
<span class="sd">       | default: extxyz</span>

<span class="sd">    ``rng=( numpy | internal | rngstream )``</span>
<span class="sd">       | Random number generator.</span>
<span class="sd">       | default: numpy</span>

<span class="sd">    ``profile=rank_to_profile``</span>
<span class="sd">       | default: -1</span>

<span class="sd">    ``2D=[ T | F ]``</span>
<span class="sd">       | Perform 2D simulation. Some functionality may be limited with this option!</span>
<span class="sd">       | The 2D area is in the xy plane, the z axis stays constant during the simulation (set its value using the keyword ``Z_cell_axis``).</span>
<span class="sd">       | The maximum allowed volume is still defined as volume in this case!</span>
<span class="sd">       | If constant pressure is set, the p*V term is now p*A*Z_cell_axis, thus set the MC_cell_P parameter multiplied by 1/Z_cell_axis.</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``Z_cell_axis=float``</span>
<span class="sd">       | Only used if 2D=T. Value of the Z cell axis, perpendicular to the area in case of a 2D simulation.</span>
<span class="sd">       | This stays constant during the simulation.</span>
<span class="sd">       | default: 10.0</span>

<span class="sd">    ``debug=int``</span>
<span class="sd">       | Verbosity level used in the output file. The larger its value the more info is printed.</span>
<span class="sd">       | default: 0</span>

<span class="sd">    ``snapshot_interval=int``</span>
<span class="sd">       | Iteration interval at which a snapshot is created: every process prints out its current walkers in extended xyz format. If it is set &lt;=0, no snapshots will be printed except the final positions at the end of the nested sampling run. Note that when new snapshots are printed, the previous set is deleted. The snapshot files are convenient source to see how the sampling progresses, but these are also the basis to restart a sampling! When using restart, the walkers will be read from these files.</span>
<span class="sd">       | default: 10000</span>

<span class="sd">    ``snapshot_time=int``</span>
<span class="sd">       | Max time between snapshots in seconds</span>
<span class="sd">       | default: 3600</span>

<span class="sd">    ``snapshot_per_parallel_task=[ T | F ]``</span>
<span class="sd">       | Save a separate snapshot file for each parallel task.  Faster I/O (in parallel), but less convenient in some cases.</span>
<span class="sd">       | default: T</span>

<span class="sd">    ``snapshot_clean=[ T | F ]``</span>
<span class="sd">       | If true, delete previous iteration snapshot files</span>
<span class="sd">       | default: T</span>

<span class="sd">    ``random_initialise_pos=[ T | F ]``</span>
<span class="sd">       | If true, randomize the initial positions</span>
<span class="sd">       | default: T</span>

<span class="sd">    ``random_initialise_cell=[ T | F ]``</span>
<span class="sd">       | If true, randomize the initial cell (currently by random walk)</span>
<span class="sd">       | default: T</span>

<span class="sd">    ``LAMMPS_molecular_info=[ T | F ]``</span>
<span class="sd">       | If true, create lammps bonds and other molecular MM features from initial atoms config (e.g. can be read from a file)</span>
<span class="sd">       | default: T</span>

<span class="sd">    ``initial_walk_N_walks=int``</span>
<span class="sd">       | number of initial random walks to apply to all walkers</span>
<span class="sd">       | default: &#39;&#39;</span>

<span class="sd">    ``initial_walk_adjust_interval=int``</span>
<span class="sd">       | in initial walks, interval between walks for adjusting step size</span>
<span class="sd">       | default: &#39;&#39;</span>

<span class="sd">    ``initial_walk_Emax_offset_per_atom=float``</span>
<span class="sd">       | offset (per atom) to increase Emax during initial random walk applied to all walkers</span>
<span class="sd">       | default: 1.0</span>

<span class="sd">    ``initial_walk_only=[T | F]``</span>
<span class="sd">       | do initial walk only, then quit</span>
<span class="sd">       | default: F</span>

<span class="sd">    ``traj_interval=int``</span>
<span class="sd">     |  Iteration interval at which the currently culled configuration(s) is/are printed to the trajectory output, in the set format. If it is set &lt;=0, no trajectory files will be printed at all. Useful option for larger runs as the trajectory files can become huge.</span>
<span class="sd">     |  default: 100</span>

<span class="sd">    ``delta_random_seed=int``</span>
<span class="sd">     | Random number seed to be used in the run. If smaller than 0, a seed from /dev/urandom is used.</span>
<span class="sd">     | default: -1</span>

<span class="sd">    ``no_extra_walks_at_all=[ T | F ]``</span>
<span class="sd">     | default: F</span>

<span class="sd">    ``track_configs=[ T | F ]``</span>
<span class="sd">     | Track configrations across all walks/clones.</span>
<span class="sd">     | default: F</span>

<span class="sd">    ``track_configs_write=[ T | F ]``</span>
<span class="sd">     | Write tracked configrations to a file (if false, tracking info will still be in snapshot and traj files)</span>
<span class="sd">     | default: F</span>

<span class="sd">    ``ns_run_analyzers=string``</span>
<span class="sd">     | Analyzers to apply during run.  String consists of semicolon separated pairs of module name and intervals. Module names correspond to analysis modules in NS_PATH/ns_run_analyzers (see there for examples) or elsewhere in PYTHONPATH</span>
<span class="sd">     | Positive interval refers to NS loop, negative to initial walks</span>
<span class="sd">     | default:&#39;&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Usage: </span><span class="si">%s</span><span class="s2"> [ -no_mpi ] &lt; input</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;input:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;max_volume_per_atom=float (1e3)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;min_volume_per_atom=float (1)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;start_species=int int [ float ] [, int int [ float ] ... ] (MANDATORY, this or start_config_file required. atomic_number multiplicity [not recomended: mass (amu)]. Info repeated for each species, separated by commas, mass is optional and not recommended.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;start_config_file=str (MANDATORY, this or start_species required. if set filename to read initial atom information from (instead of creating them)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;keep_atoms_fixed=int (0, no atoms to be fixed)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;apply_Z_wall=[T | F] (F, supported only for fortran MC)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;restart_file=path_to_file (file for restart configs. Mutually exclusive with start_*, one is required)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;n_walkers=int (MANDATORY)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;n_cull=int (1, number of walkers to kill at each NS iteration)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;n_extra_walk_per_task=int (0)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;n_iter_times_fraction_killed=int (MANDATORY, this or converge_down_to_T required)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;converge_down_to_T=float (MANDATORY, this or n_iter_times_fraction_killed required)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;T_estimate_finite_diff_lag=int (1000, lag for doing finite difference in current T estimate</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;min_Emax=float (None.  Termination condition based on Emax)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;out_file_prefix=str (None)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;energy_calculator= ( ASE | lammps | internal | fortran) (fortran)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;n_extra_data=int (0, amount of extra data per atom to pass around)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ns_run_analyzers=str (&#39;&#39;, analyzers to apply during run</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;KEmax_max_T=float (-1, if &gt; 0 maximum temperature for estimating KEmax)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;kB=float (8.6173324e-5, Boltzmann constant)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;start_energy_ceiling_per_atom=float (1.0e9, max potential energy per atom for initial configs.  P*Vmax is added to this automatically)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;start_energy_ceiling=float (DEPRECATED: use start_energy_ceiling_per_atom. 1.0e9, max potential energy for initial configs.  P*Vmax is added to this automatically)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;random_init_max_n_tries=int (100, maximum number of tries for random initial positions under energy ceiling</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;n_model_calls_expected=int (0, one of these is required)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;n_model_calls=int (0, one of these is required)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;do_good_load_balance=[T | F] (F, whether to do steps in groups with good load balance</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;n_atom_steps=int (1, number of atomic trajectories </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;atom_traj_len=int (8, length of atomic trajectory (MD steps or MC sweeps) in each step</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;atom_traj_len_cost_multiplier=int (1, multiplier for cost of an atomic step (set to 1 for MD, TE-HMC, and SP-MC with O(1) cost moves, N for naive SP-MC)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;break_up_atom_traj=[T | F] (F, whether to intersperse n_atom_steps atomic sub-trajectories with other types of steps</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;n_cell_volume_steps=int (1, number of cell MC volume steps )</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;n_cell_shear_steps=int (1, number of cell MC shear steps )</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;n_cell_stretch_steps=int (1, number of cell MC stretch steps )</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;n_swap_steps=int (0, number of atom swaps)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;swap_max_cluster=int (1, maximum size of interconnected cluster to try to swap)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;swap_r_cut=float (2.5, cutoff radius for defining connected atoms for cluster)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;swap_cluster_probability_increment=float (0.75, factor between prob. of picking increasing larger clusters)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;swap_velo=[T | F] (F, if true, swap velocities when swapping atoms, breaking coherence a bit</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;swap_velo_fix_mag_alt=[T | F] (F, if true, use alternate correction for velocity magnitudes when not swapping velocities</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;n_semi_grand_steps=int (0, number of species type changes)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;semi_grand_potentials={ int : float [ , int : float ... ] } (None, chemical potentials for species type changes)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;velo_traj_len=int (0, number of MC sweeps in each velocity MC segement)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;random_energy_perturbation=float (1.0e-12)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;atom_algorithm=[MC | MD | GMC] (MANDATORY)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_atom_velocities=[T | F] (F, supported only for energy_calculator=fortran)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_atom_velocities_pre_perturb=[T | F] (F, Perturb velocities (rejection free) before MC + velocities walk)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_atom_step_size=float (1.0, in units of (max_volume_per_atom * N_atoms)^(1/3) )</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_atom_step_size_max=float (1.0, in units of (max_volume_per_atom * N_atoms)^(1/3) )</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_atom_uniform_rv=[T | F] (F)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_atom_Galilean=[T | F] (F)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;GMC_no_reverse=[T | F] (T)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MD_atom_velo_pre_perturb=[T | F] (F. Perturb velocities before MD trajectory</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MD_atom_velo_post_perturb=[T | F] (T. Perturb velocities after MD trajectory</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MD_atom_velo_flip_accept=[T | F] (F)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MD_atom_timestep=float (0.1, in ASE time units)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MD_atom_timestep_max=float (2.0, in ASE time units)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MD_atom_energy_fuzz=float (1.0e-2. Tolerance for rejecting non-energy conserving trajectories, as fraction of KE)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MD_atom_reject_energy_violation=[ T | F ] (F, use energy conservation violation (exceeding MD_atom_energy_fuzz * KE) to reject MD trajectories)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;atom_velo_rej_free_fully_randomize=[T | F] (F. If true, randomize velocities completely rather than just perturbing.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;atom_velo_rej_free_perturb_angle=float (0.3. Max angle in radians for random rotations.)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_atom_velo_step_size=float (50.0)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_atom_velo_step_size_max=float (10000.0)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_atom_velo_walk_rej_free=[T | F] (T. If true, use rejection free algorithm for MC_atom_walk</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_cell_P=float (0.0)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_cell_flat_V_prior=[T | F] (F). POORLY TESTED, DO NOT TRUST (YET)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_cell_volume_per_atom_step_size=float (5</span><span class="si">% o</span><span class="s2">f the maximum allowed volume)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_cell_volume_per_atom_step_size_max=float (50</span><span class="si">% o</span><span class="s2">f the maximum allowed volume)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_cell_volume_per_atom_prob=float (1.0)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_cell_stretch_step_size=float (0.1)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_cell_stretch_step_size_max=float (1.0)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_cell_stretch_prob=float (1.0)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_cell_shear_step_size=float (0.1 in units of (max_volume_per_atom * N_atoms)^(1/3))</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_cell_shear_step_size_max=float (1.0 in units of (max_volume_per_atom * N_atoms)^(1/3))</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_cell_shear_prob=float (1.0)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_cell_min_aspect_ratio=float (0.8)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cell_shape_equil_steps=int (1000)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;monitor_step_interval_times_fraction_killed=float (1, divided by n_cull/n_walkers to get actual monitoring interval in iterations, negative for only using last iteration, 0 for no monitoring)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;adjust_step_interval_times_fraction_killed=float (5, divided by n_cull/n_walkers to get actual adjustment interval in iterations, negative for only using last iteration, 0 for no adjust)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;full_auto_step_sizes=[T | F] (T) (T. Automatically calibrate all sizes by performing additional short explorations, including at start of run. F. Use initial input step sizes and make small adjustments to step sizes during run.)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_adjust_step_factor=float (1.1)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_adjust_min_rate=float (0.25)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MC_adjust_max_rate=float (0.75)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;GMC_adjust_min_rate=float (0.25)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;GMC_adjust_max_rate=float (0.75)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;GMC_dir_perturb_angle=float (-1.0)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;GMC_dir_perturb_angle_during=float (0.0)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MD_adjust_step_factor=float (1.1)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MD_adjust_min_rate=float (0.5)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MD_adjust_max_rate=float (0.95)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ASE_calc_module=str (MANDATORY if energy_calculator=ASE)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;FORTRAN_model=str (MANDATORY if energy_calculator=fortran)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;FORTRAN_model_params=str (parameters for energy_calculator=fortran)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LAMMPS_fix_gmc=[T | F]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LAMMPS_init_cmds=str (MANDATORY if energy_calculator=lammps)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LAMMPS_name=str (&#39;&#39;, arch name for lammps shared object file)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LAMMPS_serial=[T | F] (T, is lammps library serial)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LAMMPS_header=str (lammpslib.py value default, override lammpslib.py header commands for energy_calculator=lammps)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LAMMPS_header_extra=str (&#39;&#39;, extra lammpslib.py header commands for energy_calculator=lammps)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LAMMPS_atom_types=symbol int [, symbol int ] ... (&#39;&#39;, mapping from atomic symbols to type numbers for LAMMPS ASE interface)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;config_file_format=str (extxyz)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># julia</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;rng=( numpy | internal | rngstream ) (numpy)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># julia</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;profile=rank_to_profile (-1)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;2D=[ T | F ] (F)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Z_cell_axis=float (10.0)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;debug=debug_level (0, &lt;= 0 for no debugging tests/prints)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;snapshot_interval=int (10000, &lt;=0 for no snapshots except final positions)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;snapshot_time=int (3600, &lt;=0 for no time based snapshots)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;snapshot_per_parallel_task=[T | F] (T, if true save separate snapshot file for each parallel task)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;snapshot_clean=[T | F] (T, if true clean previous iter snapshots</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;random_initialise_pos=[T | F] (T, if true randomize the initial positions</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;random_initialise_cell=[T | F] (T, if true randomize the initial cell</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LAMMPS_molecular_info=[T | F] (T, if true create lammps molecular info</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;initial_walk_N_walks=int (0 number of rounds for initial walk) </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;initial_walk_adjust_interval=int (10 interval (in walks) between adjustments of steps during initial walk) </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;initial_walk_Emax_offset_per_atom=float (1.0, offset (per atom) to add to Emax for initial walks) </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;initial_walk_only=[T | F] (F, quit after doing initial walk) </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;traj_interval=int (100, &lt;=0 for no trajectory)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;delta_random_seed=int (-1, &lt; 0 for seed from /dev/urandom)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;no_extra_walks_at_all=[ T | F ] (F)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;track_configs=[ T | F ] (F)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;track_configs_write=[ T | F ] (F)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="excepthook_mpi_abort">
<a class="viewcode-back" href="../ns_run.html#ns_run.excepthook_mpi_abort">[docs]</a>
<span class="k">def</span> <span class="nf">excepthook_mpi_abort</span><span class="p">(</span><span class="n">exctype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span> <span class="n">print_prefix</span><span class="p">,</span><span class="s1">&#39;Uncaught Exception Type:&#39;</span><span class="p">,</span> <span class="n">exctype</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="n">print_prefix</span><span class="p">,</span><span class="s1">&#39;Value:&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="n">print_prefix</span><span class="p">,</span><span class="s1">&#39;Traceback:&#39;</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
    <span class="c1"># print_tb(tb)</span>
    <span class="n">print_exception</span><span class="p">(</span><span class="n">exctype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;Aborting&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Abort</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="exit_error">
<a class="viewcode-back" href="../ns_run.html#ns_run.exit_error">[docs]</a>
<span class="k">def</span> <span class="nf">exit_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">stat</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Abort</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span></div>


<div class="viewcode-block" id="str_to_logical">
<a class="viewcode-back" href="../ns_run.html#ns_run.str_to_logical">[docs]</a>
<span class="k">def</span> <span class="nf">str_to_logical</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="s2">&quot;TRUE&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span> <span class="p">]:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span><span class="p">,</span> <span class="s2">&quot;FALSE&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span> <span class="p">]:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Failed to parse logical</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span></div>


<div class="viewcode-block" id="internal_Vlj">
<a class="viewcode-back" href="../ns_run.html#ns_run.internal_Vlj">[docs]</a>
<span class="k">def</span> <span class="nf">internal_Vlj</span><span class="p">(</span><span class="n">dr_vec</span><span class="p">,</span> <span class="n">Eshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dr_vec</span><span class="o">**-</span><span class="mi">12</span> <span class="o">-</span> <span class="n">dr_vec</span><span class="o">**-</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">Eshift</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dr_vec</span><span class="p">))</span></div>


<span class="c1"># pos is Nx3, l is a scalar box size</span>
<div class="viewcode-block" id="energy_internal_pos">
<a class="viewcode-back" href="../ns_run.html#ns_run.energy_internal_pos">[docs]</a>
<span class="k">def</span> <span class="nf">energy_internal_pos</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="n">n_at</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dr_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">n_at</span><span class="o">*</span><span class="p">(</span><span class="n">n_at</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">offset</span><span class="o">=</span><span class="mi">0</span>
    <span class="c1"># calc relative pos vector</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_at</span><span class="p">):</span>
        <span class="n">dr_list</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="p">(</span><span class="n">n_at</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dr_list</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="p">(</span><span class="n">n_at</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dr_list</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="p">(</span><span class="n">n_at</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="n">n_at</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span>
    <span class="c1"># apply min image</span>
    <span class="n">dr_list</span><span class="p">[:,:]</span> <span class="o">-=</span> <span class="n">l</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">dr_list</span><span class="p">[:,:]</span><span class="o">/</span><span class="n">l</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="c1"># magnitude of vectors</span>
    <span class="n">dr_list_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dr_list</span><span class="o">*</span><span class="n">dr_list</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">internal_Vlj</span><span class="p">(</span><span class="n">dr_list_mag</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dr_list_mag</span> <span class="o">&lt;</span> <span class="n">internal_cutoff</span><span class="p">)],</span><span class="n">Eshift</span><span class="p">))</span></div>


<div class="viewcode-block" id="energy_internal">
<a class="viewcode-back" href="../ns_run.html#ns_run.energy_internal">[docs]</a>
<span class="k">def</span> <span class="nf">energy_internal</span><span class="p">(</span><span class="n">at</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">energy_internal_pos</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(),</span> <span class="n">at</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="eval_energy_PE">
<a class="viewcode-back" href="../ns_run.html#ns_run.eval_energy_PE">[docs]</a>
<span class="k">def</span> <span class="nf">eval_energy_PE</span><span class="p">(</span><span class="n">at</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">do_calc_ASE</span> <span class="ow">or</span> <span class="n">do_calc_lammps</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">do_calc_lammps</span><span class="p">:</span>
            <span class="c1">#NB only MD can make crazy positions, so maybe just do this after MD propagation?</span>
            <span class="n">at</span><span class="o">.</span><span class="n">wrap</span><span class="p">()</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">do_calc_internal</span><span class="p">:</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">energy_internal</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">do_calc_fortran</span><span class="p">:</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">f_MC_MD</span><span class="o">.</span><span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No way to eval_energy_PE()</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">energy</span></div>


<div class="viewcode-block" id="eval_energy_KE">
<a class="viewcode-back" href="../ns_run.html#ns_run.eval_energy_KE">[docs]</a>
<span class="k">def</span> <span class="nf">eval_energy_KE</span><span class="p">(</span><span class="n">at</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s1">&#39;momenta&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s1">&#39;masses&#39;</span><span class="p">):</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_kinetic_energy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">energy</span></div>


<div class="viewcode-block" id="eval_energy_PV">
<a class="viewcode-back" href="../ns_run.html#ns_run.eval_energy_PV">[docs]</a>
<span class="k">def</span> <span class="nf">eval_energy_PV</span><span class="p">(</span><span class="n">at</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_P&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">at</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span></div>


<div class="viewcode-block" id="eval_energy_mu">
<a class="viewcode-back" href="../ns_run.html#ns_run.eval_energy_mu">[docs]</a>
<span class="k">def</span> <span class="nf">eval_energy_mu</span><span class="p">(</span><span class="n">at</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;semi_grand_potentials&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;semi_grand_potentials&#39;</span><span class="p">]</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span> <span class="n">mu</span><span class="p">[</span><span class="n">Z</span><span class="p">]</span> <span class="k">for</span> <span class="n">Z</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">()</span> <span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">energy</span></div>


<div class="viewcode-block" id="eval_energy">
<a class="viewcode-back" href="../ns_run.html#ns_run.eval_energy">[docs]</a>
<span class="k">def</span> <span class="nf">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_KE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_PE</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calls appropriate functions to calculate the potential energy, kinetic energy and the p*V term.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">eval_energy_PV</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="o">+</span> <span class="n">eval_energy_mu</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_PE</span><span class="p">:</span>
        <span class="n">energy</span> <span class="o">+=</span> <span class="n">eval_energy_PE</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_KE</span><span class="p">:</span>
        <span class="n">energy</span> <span class="o">+=</span> <span class="n">eval_energy_KE</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">energy</span></div>


<div class="viewcode-block" id="eval_forces">
<a class="viewcode-back" href="../ns_run.html#ns_run.eval_forces">[docs]</a>
<span class="k">def</span> <span class="nf">eval_forces</span><span class="p">(</span><span class="n">at</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">do_calc_ASE</span> <span class="ow">or</span> <span class="n">do_calc_lammps</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">do_calc_lammps</span><span class="p">:</span>
            <span class="c1">#NB only MD can make crazy positions, so maybe just do this after MD propagation?</span>
            <span class="n">at</span><span class="o">.</span><span class="n">wrap</span><span class="p">()</span>
        <span class="n">forces</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_forces</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">do_calc_internal</span><span class="p">:</span>
        <span class="n">exit_error</span><span class="p">(</span><span class="s1">&#39;no forces for do_calc_internal&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">do_calc_fortran</span><span class="p">:</span>
        <span class="n">forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">at</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>
        <span class="n">f_MC_MD</span><span class="o">.</span><span class="n">eval_forces</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">forces</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No way to eval_forces()</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">forces</span></div>


<div class="viewcode-block" id="propagate_NVE_ASE">
<a class="viewcode-back" href="../ns_run.html#ns_run.propagate_NVE_ASE">[docs]</a>
<span class="k">def</span> <span class="nf">propagate_NVE_ASE</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">):</span>
    <span class="n">at</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">pot</span>

    <span class="c1"># dt is being converted from ASE units to fs</span>
    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#LIVIA</span>
            <span class="kn">from</span> <span class="nn">ase.constraints</span> <span class="kn">import</span> <span class="n">FixAtoms</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">FixAtoms</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">at</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]])</span>
            <span class="n">at</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">vv</span> <span class="o">=</span> <span class="n">VelocityVerlet</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#LIVIA</span>
            <span class="kn">from</span> <span class="nn">ase.constraints</span> <span class="kn">import</span> <span class="n">FixAtoms</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">FixAtoms</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">at</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]])</span>
            <span class="n">at</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">vv</span> <span class="o">=</span> <span class="n">VelocityVerlet</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>

    <span class="n">vv</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">n_steps</span><span class="p">)</span></div>



<div class="viewcode-block" id="propagate_lammps">
<a class="viewcode-back" href="../ns_run.html#ns_run.propagate_lammps">[docs]</a>
<span class="k">def</span> <span class="nf">propagate_lammps</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">algo</span><span class="p">,</span> <span class="n">Emax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pot</span><span class="o">.</span><span class="n">first_propagate</span><span class="p">:</span>
        <span class="n">pot</span><span class="o">.</span><span class="n">first_propagate</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pot</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;unfix 1 &#39;</span><span class="p">)</span>

    <span class="c1"># set appropriate fix</span>
    <span class="k">if</span> <span class="n">algo</span> <span class="o">==</span> <span class="s1">&#39;NVE&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#LIVIA</span>
            <span class="c1">#pot.lmp.command(&#39;group mobile id &gt; &#39; + str(movement_args[&#39;keep_atoms_fixed&#39;]))</span>
            <span class="n">pot</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;fix 1 mobile nve&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pot</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;fix 1 all nve&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">algo</span> <span class="o">==</span> <span class="s1">&#39;GMC&#39;</span><span class="p">:</span>
        <span class="c1"># GMC does not work with fixed atoms # Ray Yang</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;propagate_lammps got algo &#39;</span><span class="si">%s</span><span class="s2">&#39;, which does not work with fixed atoms</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">algo</span><span class="p">)</span>
        <span class="c1"># Hard coded value needed for LAMMPS. Let&#39;s hope our RNG maximum is at</span>
        <span class="c1"># least this large.</span>
        <span class="n">pot</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;fix 1 all ns/gmc </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">900000000</span><span class="p">),</span> <span class="n">Emax</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exit_error</span><span class="p">(</span>
            <span class="s2">&quot;propagate_lammps got algo &#39;</span><span class="si">%s</span><span class="s2">&#39;, neither NVE nor GMC</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">algo</span><span class="p">)</span>

    <span class="c1"># NB maybe not do this every time? Just _after_ MD, since that&#39;s the only</span>
    <span class="c1"># way position can become crazy?</span>
    <span class="n">at</span><span class="o">.</span><span class="n">wrap</span><span class="p">()</span>

    <span class="c1"># do propagation, recover from exception if needed</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">algo</span> <span class="o">==</span> <span class="s1">&#39;NVE&#39;</span><span class="p">:</span>
            <span class="n">pot</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;forces&#39;</span><span class="p">],</span>
                          <span class="n">system_changes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">],</span> <span class="n">n_steps</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pot</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;forces&#39;</span><span class="p">],</span>
                          <span class="n">system_changes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">],</span> <span class="n">n_steps</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
                          <span class="n">dt_not_real_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="c1"># clean up and return failure</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;propagate_lammps got exception &quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">pot</span><span class="o">.</span><span class="n">restart_lammps</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
        <span class="n">pot</span><span class="o">.</span><span class="n">first_propagate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="velo_rv_mag">
<a class="viewcode-back" href="../ns_run.html#ns_run.velo_rv_mag">[docs]</a>
<span class="k">def</span> <span class="nf">velo_rv_mag</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
        <span class="c1">#unit_rv[:,2] = 0.0 # commented out from here, as unit_rv is unknown to this function at this point</span>
        <span class="n">nDOF</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nDOF</span> <span class="o">=</span> <span class="mf">3.0</span>
    <span class="c1"># In 3D rv_mag should have prob distrib p(r) = r^(3N-1).</span>
    <span class="c1"># Using transformation rule p(y) = p(x) |dx/dy|, with p(y) = y^{3N-1} and p(x) = 1,</span>
    <span class="c1">#       one gets dx/dy = y^{3N-1}</span>
    <span class="c1">#                x = y^{3N}</span>
    <span class="c1">#                y = x^{1/3N}</span>
    <span class="k">return</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">nDOF</span><span class="o">*</span><span class="n">n</span><span class="p">))</span></div>



<div class="viewcode-block" id="velo_unit_rv">
<a class="viewcode-back" href="../ns_run.html#ns_run.velo_unit_rv">[docs]</a>
<span class="k">def</span> <span class="nf">velo_unit_rv</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">unit_rv</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">unit_rv</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">unit_rv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unit_rv</span></div>



<div class="viewcode-block" id="gen_random_velo">
<a class="viewcode-back" href="../ns_run.html#ns_run.gen_random_velo">[docs]</a>
<span class="k">def</span> <span class="nf">gen_random_velo</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">,</span> <span class="n">unit_rv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">unit_rv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">unit_rv</span> <span class="o">=</span> <span class="n">velo_unit_rv</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
        <span class="n">unit_rv</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># propose right magnitude of randomness consistent with mobile atoms</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">rv_mag</span> <span class="o">=</span> <span class="n">velo_rv_mag</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">)</span><span class="o">-</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rv_mag</span> <span class="o">=</span> <span class="n">velo_rv_mag</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">))</span>
    <span class="c1">#rv_mag = velo_rv_mag(len(at))</span>

    <span class="c1"># from Baldock thesis Eq. 11.10</span>
    <span class="c1">#     p^{**} = r \mathbf{S} \hat{\mathbf{r}}</span>
    <span class="c1"># and 11.11</span>
    <span class="c1">#     S_{ij} = \delta_{ij} (2 m_i [ E_{lim} - U(q))])^{1/2}</span>
    <span class="c1"># p_i = r (2 m_i)^{1/2} (E-U)^{1/2} \hat{r}_i</span>
    <span class="c1"># v_i = p_i / m_i = r (2/m)^{1/2} (E-U)^{1/2} \hat{r}_i</span>

    <span class="n">masses</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_masses</span><span class="p">()</span>

    <span class="c1"># the &quot;np.sqrt(2.0/np.array([masses,]*3).transpose()) * np.sqrt(KEmax)&quot; is filling it up with the same term</span>
    <span class="n">velocities</span> <span class="o">=</span> <span class="n">rv_mag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">masses</span><span class="p">,]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">KEmax</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit_rv</span>
    <span class="c1"># zero velocities of fixed atoms (these were not taken into account in the nDOF)</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">velocities</span><span class="p">[:</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]]</span><span class="o">=</span><span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">velocities</span></div>



<div class="viewcode-block" id="pairwise">
<a class="viewcode-back" href="../ns_run.html#ns_run.pairwise">[docs]</a>
<span class="k">def</span> <span class="nf">pairwise</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span></div>



<div class="viewcode-block" id="rotate_dir_3N">
<a class="viewcode-back" href="../ns_run.html#ns_run.rotate_dir_3N">[docs]</a>
<span class="k">def</span> <span class="nf">rotate_dir_3N</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">max_ang</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">max_ang</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># apply random rotations</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="mi">3</span><span class="p">),</span> <span class="n">i</span><span class="o">%</span><span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">vec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">]</span>
    <span class="n">rng</span><span class="o">.</span><span class="n">shuffle_in_place</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">((</span><span class="n">ind_1_a</span><span class="p">,</span><span class="n">ind_1_c</span><span class="p">),</span> <span class="p">(</span><span class="n">ind_2_a</span><span class="p">,</span><span class="n">ind_2_c</span><span class="p">))</span> <span class="ow">in</span> <span class="n">pairwise</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="o">-</span><span class="n">max_ang</span><span class="p">,</span><span class="n">max_ang</span><span class="p">)</span>
        <span class="n">c_ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span>
        <span class="n">s_ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span>
        <span class="n">v_1</span> <span class="o">=</span>  <span class="n">vec</span><span class="p">[</span><span class="n">ind_1_a</span><span class="p">,</span><span class="n">ind_1_c</span><span class="p">]</span> <span class="o">*</span> <span class="n">c_ang</span> <span class="o">+</span> <span class="n">vec</span><span class="p">[</span><span class="n">ind_2_a</span><span class="p">,</span><span class="n">ind_2_c</span><span class="p">]</span> <span class="o">*</span> <span class="n">s_ang</span>
        <span class="n">v_2</span> <span class="o">=</span> <span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="n">ind_1_a</span><span class="p">,</span><span class="n">ind_1_c</span><span class="p">]</span> <span class="o">*</span> <span class="n">s_ang</span> <span class="o">+</span> <span class="n">vec</span><span class="p">[</span><span class="n">ind_2_a</span><span class="p">,</span><span class="n">ind_2_c</span><span class="p">]</span> <span class="o">*</span> <span class="n">c_ang</span>
        <span class="n">vec</span><span class="p">[</span><span class="n">ind_1_a</span><span class="p">,</span><span class="n">ind_1_c</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_1</span>
        <span class="n">vec</span><span class="p">[</span><span class="n">ind_2_a</span><span class="p">,</span><span class="n">ind_2_c</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_2</span></div>


<div class="viewcode-block" id="rotate_dir_3N_2D">
<a class="viewcode-back" href="../ns_run.html#ns_run.rotate_dir_3N_2D">[docs]</a>
<span class="k">def</span> <span class="nf">rotate_dir_3N_2D</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">max_ang</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">max_ang</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># apply random rotations</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">vec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">]</span>
    <span class="n">rng</span><span class="o">.</span><span class="n">shuffle_in_place</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">((</span><span class="n">ind_1_a</span><span class="p">,</span><span class="n">ind_1_c</span><span class="p">),</span> <span class="p">(</span><span class="n">ind_2_a</span><span class="p">,</span><span class="n">ind_2_c</span><span class="p">))</span> <span class="ow">in</span> <span class="n">pairwise</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="o">-</span><span class="n">max_ang</span><span class="p">,</span><span class="n">max_ang</span><span class="p">)</span>
        <span class="n">c_ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span>
        <span class="n">s_ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span>
        <span class="n">v_1</span> <span class="o">=</span>  <span class="n">vec</span><span class="p">[</span><span class="n">ind_1_a</span><span class="p">,</span><span class="n">ind_1_c</span><span class="p">]</span> <span class="o">*</span> <span class="n">c_ang</span> <span class="o">+</span> <span class="n">vec</span><span class="p">[</span><span class="n">ind_2_a</span><span class="p">,</span><span class="n">ind_2_c</span><span class="p">]</span> <span class="o">*</span> <span class="n">s_ang</span>
        <span class="n">v_2</span> <span class="o">=</span> <span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="n">ind_1_a</span><span class="p">,</span><span class="n">ind_1_c</span><span class="p">]</span> <span class="o">*</span> <span class="n">s_ang</span> <span class="o">+</span> <span class="n">vec</span><span class="p">[</span><span class="n">ind_2_a</span><span class="p">,</span><span class="n">ind_2_c</span><span class="p">]</span> <span class="o">*</span> <span class="n">c_ang</span>
        <span class="n">vec</span><span class="p">[</span><span class="n">ind_1_a</span><span class="p">,</span><span class="n">ind_1_c</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_1</span>
        <span class="n">vec</span><span class="p">[</span><span class="n">ind_2_a</span><span class="p">,</span><span class="n">ind_2_c</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_2</span></div>



<div class="viewcode-block" id="rej_free_perturb_velo">
<a class="viewcode-back" href="../ns_run.html#ns_run.rej_free_perturb_velo">[docs]</a>
<span class="k">def</span> <span class="nf">rej_free_perturb_velo</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="c1">#DOC</span>
<span class="c1">#DOC ``rej_free_perturb_velo``</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s1">&#39;momenta&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s1">&#39;masses&#39;</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="n">KEmax_use</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">Emax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">initial_KE</span> <span class="o">=</span> <span class="n">eval_energy_KE</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
        <span class="n">KEmax_use</span> <span class="o">=</span> <span class="n">Emax</span> <span class="o">-</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">initial_KE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">KEmax</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Emax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">KEmax_use</span> <span class="o">=</span> <span class="n">KEmax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">KEmax_use</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">KEmax_use</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">KEmax_use</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;rej_free_perturb_velo() called with Emax and KEmax both None</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>

    <span class="n">orig_KE</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_kinetic_energy</span><span class="p">()</span>
    <span class="c1">#DOC \item if atom\_velo\_rej\_free\_fully\_randomize, pick random velocities consistent with Emax</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_velo_rej_free_fully_randomize&#39;</span><span class="p">]:</span>
        <span class="c1"># randomize completely, fixed atoms are taken care of</span>
        <span class="n">at</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="n">gen_random_velo</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">KEmax_use</span><span class="p">))</span>  

    <span class="c1">#DOC \item else perturb velocities</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># perturb</span>
        <span class="n">velo</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_velocities</span><span class="p">()</span>

        <span class="n">velo_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">velo</span><span class="p">)</span>
        <span class="c1">#DOC \item if current velocity=0, can&#39;t rescale, so pick random velocities consistent with Emax</span>
        <span class="k">if</span> <span class="n">velo_mag</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="c1"># generate random velocities, fixed atoms are taken care of</span>
            <span class="n">at</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="n">gen_random_velo</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">KEmax_use</span><span class="p">))</span>  

        <span class="c1">#DOC \item else, pick new random magnitude consistent with Emax, random rotation of current direction with angle uniform in +/- atom\_velo\_rej\_free\_perturb\_angle</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># using default settings we will do this. </span>
            <span class="c1"># pick new random magnitude - count on dimensionality to make change small</span>
            <span class="c1"># WARNING: check this for variable masses</span>

            <span class="n">sqrt_masses_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">get_masses</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">scaled_vel</span> <span class="o">=</span> <span class="n">gen_random_velo</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">KEmax_use</span><span class="p">,</span> <span class="n">velo</span><span class="o">/</span><span class="n">velo_mag</span><span class="p">)</span> <span class="o">*</span> <span class="n">sqrt_masses_2D</span>

            <span class="k">if</span> <span class="n">rotate</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
                    <span class="n">rotate_dir_3N_2D</span><span class="p">(</span><span class="n">scaled_vel</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_velo_rej_free_perturb_angle&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># this is the new line</span>
                        <span class="n">rotate_dir_3N</span><span class="p">(</span><span class="n">scaled_vel</span><span class="p">[</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]:,</span> <span class="p">:],</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_velo_rej_free_perturb_angle&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rotate_dir_3N</span><span class="p">(</span><span class="n">scaled_vel</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_velo_rej_free_perturb_angle&#39;</span><span class="p">])</span>

            <span class="n">at</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="n">scaled_vel</span> <span class="o">/</span> <span class="n">sqrt_masses_2D</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># for surface simulations</span>
                <span class="n">random_velo</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_velocities</span><span class="p">()</span>
                <span class="n">random_velo</span><span class="p">[:</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">at</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="n">random_velo</span><span class="p">)</span>

    <span class="n">new_KE</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_kinetic_energy</span><span class="p">()</span>

    <span class="c1"># rej_free_perturb_velo expects at.info[&#39;ns_energy&#39;] to be set correctly initially</span>
    <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">new_KE</span><span class="o">-</span><span class="n">orig_KE</span></div>



<div class="viewcode-block" id="do_MC_atom_velo_walk">
<a class="viewcode-back" href="../ns_run.html#ns_run.do_MC_atom_velo_walk">[docs]</a>
<span class="k">def</span> <span class="nf">do_MC_atom_velo_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">nD</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">):</span>
<span class="c1">#DOC</span>
<span class="c1">#DOC ``do\_MC\_atom\_velo\_walk``</span>

    <span class="c1">#DOC \item Else if MC\_atom\_velo\_walk\_rej\_free</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velo_walk_rej_free&#39;</span><span class="p">]:</span>
        <span class="c1">#DOC \item call rej\_free\_perturb\_velo()</span>
            <span class="n">rej_free_perturb_velo</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
    <span class="c1">#DOC \item else do MC pertubation to velocities</span>

    <span class="n">n_steps</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;velo_traj_len&#39;</span><span class="p">]</span>
    <span class="n">step_size</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velo_step_size&#39;</span><span class="p">]</span>

    <span class="n">n_try</span> <span class="o">=</span> <span class="n">n_steps</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>

    <span class="n">initial_KE</span> <span class="o">=</span> <span class="n">eval_energy_KE</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="n">KEmax_use</span> <span class="o">=</span> <span class="n">Emax</span> <span class="o">-</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">initial_KE</span><span class="p">)</span> <span class="c1"># expecting ns_energy = KE + PE (+PV)</span>
    <span class="k">if</span> <span class="n">KEmax</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">KEmax</span> <span class="o">&lt;</span> <span class="n">KEmax_use</span><span class="p">:</span>
        <span class="n">KEmax_use</span> <span class="o">=</span> <span class="n">KEmax</span>

    <span class="k">if</span> <span class="n">do_calc_fortran</span><span class="p">:</span>
        <span class="p">(</span><span class="n">n_try</span><span class="p">,</span> <span class="n">n_accept</span><span class="p">,</span> <span class="n">final_KE</span><span class="p">)</span> <span class="o">=</span> <span class="n">f_MC_MD</span><span class="o">.</span><span class="n">MC_atom_walk_velo</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">nD</span><span class="p">,</span> <span class="n">KEmax_use</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">final_KE</span><span class="o">-</span><span class="n">initial_KE</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">masses</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_masses</span><span class="p">()</span>
        <span class="n">velocities</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_velocities</span><span class="p">()</span>
        <span class="n">KE</span> <span class="o">=</span> <span class="n">initial_KE</span>
        <span class="n">n_accept</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i_step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
            <span class="n">at_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">)))</span>
            <span class="n">rng</span><span class="o">.</span><span class="n">shuffle_in_place</span><span class="p">(</span><span class="n">at_list</span><span class="p">)</span>
            <span class="n">d_vel</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">step_size</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># for surface simulations</span>
                <span class="n">d_vel</span><span class="p">[:</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i_at</span> <span class="ow">in</span> <span class="n">at_list</span><span class="p">:</span>
                <span class="n">d_KE</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">masses</span><span class="p">[</span><span class="n">i_at</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">velocities</span><span class="p">[</span><span class="n">i_at</span><span class="p">,:]</span><span class="o">+</span><span class="n">d_vel</span><span class="p">[</span><span class="n">i_at</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">velocities</span><span class="p">[</span><span class="n">i_at</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">KE</span> <span class="o">+</span> <span class="n">d_KE</span> <span class="o">&lt;</span> <span class="n">KEmax_use</span><span class="p">:</span>
                    <span class="n">velocities</span><span class="p">[</span><span class="n">i_at</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">d_vel</span><span class="p">[</span><span class="n">i_at</span><span class="p">,:]</span>
                    <span class="n">KE</span> <span class="o">+=</span> <span class="n">d_KE</span>
                    <span class="n">n_accept</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">at</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="n">velocities</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">KE</span><span class="o">-</span><span class="n">initial_KE</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;MC_atom_velo&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">n_try</span><span class="p">,</span> <span class="n">n_accept</span><span class="p">)}</span></div>



<div class="viewcode-block" id="do_MD_atom_walk">
<a class="viewcode-back" href="../ns_run.html#ns_run.do_MD_atom_walk">[docs]</a>
<span class="k">def</span> <span class="nf">do_MD_atom_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">):</span>
<span class="c1">#DOC</span>
<span class="c1">#DOC ``do_MD_atom_walk``</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot; perform MD walk on the configuration &quot;&quot;&quot;</span>
    <span class="n">orig_E</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span>
    <span class="n">nD</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
       <span class="n">nD</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">orig_E</span> <span class="o">&gt;=</span> <span class="n">Emax</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;: WARNING: orig_E =&quot;</span><span class="p">,</span> <span class="n">orig_E</span><span class="p">,</span> <span class="s2">&quot; &gt;= Emax =&quot;</span><span class="p">,</span> <span class="n">Emax</span><span class="p">)</span>

    <span class="c1">#DOC \item if MD\_atom\_velo\_pre\_perturb, call do\_MC\_atom\_velo\_walk() for magnitude and rotation</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_velo_pre_perturb&#39;</span><span class="p">]:</span>
        <span class="n">do_MC_atom_velo_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">nD</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">)</span>

    <span class="n">pre_MD_pos</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
    <span class="n">pre_MD_velo</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_velocities</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pre_MD_extra_data</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">pre_MD_E</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span>

    <span class="c1">#DOC \item propagate in time atom\_traj\_len time steps of length MD\_atom\_timestep</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;python_MD&#39;</span><span class="p">]:</span>
        <span class="n">forces</span> <span class="o">=</span> <span class="n">eval_forces</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
        <span class="n">final_E</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">timestep</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_timestep&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len&#39;</span><span class="p">]):</span>
            <span class="n">at</span><span class="o">.</span><span class="n">set_momenta</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">get_momenta</span><span class="p">()</span><span class="o">+</span><span class="n">forces</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">timestep</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span><span class="o">+</span><span class="n">at</span><span class="o">.</span><span class="n">get_momenta</span><span class="p">()</span><span class="o">*</span><span class="n">timestep</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">forces</span> <span class="o">=</span> <span class="n">eval_forces</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">final_E</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">Emax</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">at</span><span class="o">.</span><span class="n">set_momenta</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">get_momenta</span><span class="p">()</span><span class="o">+</span><span class="n">forces</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">timestep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">final_E</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># didn&#39;t abort due to exception in eval_forces()</span>
            <span class="n">final_E</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">do_calc_ASE</span><span class="p">:</span>
            <span class="n">propagate_NVE_ASE</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_timestep&#39;</span><span class="p">],</span> <span class="n">n_steps</span><span class="o">=</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len&#39;</span><span class="p">])</span>
            <span class="n">final_E</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">do_calc_lammps</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">propagate_lammps</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_timestep&#39;</span><span class="p">],</span> <span class="n">n_steps</span><span class="o">=</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len&#39;</span><span class="p">],</span> <span class="n">algo</span><span class="o">=</span><span class="s1">&#39;NVE&#39;</span><span class="p">):</span>
                <span class="n">final_E</span> <span class="o">=</span> <span class="n">pot</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_PE</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># propagate returned success == False</span>
                <span class="n">final_E</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">Emax</span><span class="p">)</span>
                <span class="c1">## print(&quot;error in propagate_lammps NVE, setting final_E = 2*abs(Emax) =&quot; , final_E)</span>

        <span class="k">elif</span> <span class="n">do_calc_fortran</span><span class="p">:</span>
            <span class="c1"># Fortran MD code does not support fixed atoms # Ray Yang</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;do_MD_atom_walk() called with keep_atoms_fixed &gt; 0, but no way to do that with fortran code</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">final_E</span> <span class="o">=</span> <span class="n">f_MC_MD</span><span class="o">.</span><span class="n">MD_atom_NVE_walk</span><span class="p">(</span>
                <span class="n">at</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len&#39;</span><span class="p">],</span>
                <span class="n">timestep</span><span class="o">=</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_timestep&#39;</span><span class="p">],</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">])</span>
            <span class="n">final_E</span> <span class="o">+=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_PE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_KE</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Need some non-ASE, non-fortran, non-lammps way of doing MD</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">reject_fuzz</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">final_KE</span> <span class="o">=</span> <span class="n">eval_energy_KE</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="c1">#DOC \item If MD\_atom\_reject\_energy\_violation is set, accept/reject entire move on E deviating by less than MD\_atom\_energy\_fuzz times kinetic energy</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">final_E</span><span class="o">-</span><span class="n">pre_MD_E</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_energy_fuzz&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">final_KE</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_reject_energy_violation&#39;</span><span class="p">]:</span>
            <span class="n">reject_fuzz</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># else:</span>
            <span class="c1"># print(print_prefix, &quot;: WARNING: MD energy deviation &gt; fuzz*final_KE. Pre-MD, post-MD, difference, final_KE &quot;, pre_MD_E, final_E, final_E-pre_MD_E, final_KE)</span>

    <span class="c1">#DOC \item accept/reject entire move on E &lt; Emax and KE &lt; KEmax</span>
    <span class="n">reject_Emax</span> <span class="o">=</span> <span class="p">(</span><span class="n">final_E</span> <span class="o">&gt;=</span> <span class="n">Emax</span><span class="p">)</span>
    <span class="n">reject_KEmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">KEmax</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">final_KE</span> <span class="o">&gt;=</span> <span class="n">KEmax</span><span class="p">)</span>

    <span class="c1">#DOC \item if reject</span>
    <span class="k">if</span> <span class="n">reject_fuzz</span> <span class="ow">or</span> <span class="n">reject_Emax</span> <span class="ow">or</span> <span class="n">reject_KEmax</span><span class="p">:</span>  <span class="c1"># reject</span>
        <span class="c1">#DOC \item set positions, velocities, energy back to value before perturbation (maybe should be after?)</span>
        <span class="c1"># print(print_prefix, &quot;: WARNING: reject MD traj Emax &quot;, Emax, &quot; initial E &quot;, orig_E, &quot; velo perturbed E &quot;, pre_MD_E, &quot; final E &quot;,final_E, &quot; KEmax &quot;, KEmax, &quot; KE &quot;, final_KE)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">pre_MD_pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_velo_flip_accept&#39;</span><span class="p">]:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="n">pre_MD_velo</span><span class="p">)</span>  <span class="c1"># TODO: should we be redundant in zeroing?</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="o">-</span><span class="n">pre_MD_velo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">pre_MD_extra_data</span>
        <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pre_MD_E</span>
        <span class="n">n_accept</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">#DOC \item else</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># accept</span>
        <span class="c1">#DOC \item flip velocities if MD\_atom\_velo\_flip\_accept</span>
        <span class="c1"># remember to reverse velocities on acceptance to preserve detailed</span>
        <span class="c1"># balance, since velocity is (sometimes) being perturbed, not completely</span>
        <span class="c1"># randomized</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_velo_flip_accept&#39;</span><span class="p">]:</span>
            <span class="c1"># TODO: negative of 0 is 0</span>
            <span class="n">at</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="o">-</span><span class="n">at</span><span class="o">.</span><span class="n">get_velocities</span><span class="p">())</span>  <span class="c1"># is there a faster way of doing this in ASE?  Can you do at.velocities?</span>
        <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_E</span>
        <span class="n">n_accept</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1">#DOC \item if MD\_atom\_velo\_post\_perturb, call do\_MC\_atom\_velo\_walk() for magnitude and rotation</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_velo_post_perturb&#39;</span><span class="p">]:</span>
        <span class="n">do_MC_atom_velo_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">nD</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;MD_atom&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_accept</span><span class="p">)}</span></div>



<div class="viewcode-block" id="do_MC_atom_walk">
<a class="viewcode-back" href="../ns_run.html#ns_run.do_MC_atom_walk">[docs]</a>
<span class="k">def</span> <span class="nf">do_MC_atom_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">):</span>
<span class="c1">#DOC</span>
<span class="c1">#DOC ``do_MC_atom_walk``</span>

    <span class="n">n_steps</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len&#39;</span><span class="p">]</span>
    <span class="n">step_size</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_step_size&#39;</span><span class="p">]</span>
    <span class="n">step_size_velo</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velo_step_size&#39;</span><span class="p">]</span>
    <span class="n">n_try</span> <span class="o">=</span> <span class="n">n_steps</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">)</span><span class="o">-</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">])</span> <span class="c1"># does this do anything? actual n_try is set within fortran code </span>
    <span class="n">n_accept</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">n_accept_velo</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">nD</span><span class="o">=</span><span class="mi">3</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
       <span class="n">nD</span><span class="o">=</span><span class="mi">2</span>

    <span class="c1">#DOC \item if MC\_atom\_velocities and MC\_atom\_velocities\_pre\_perturb, call do\_MC\_atom\_velo\_walk() to perturb velocities, magnitude and and rotation</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velocities&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velocities_pre_perturb&#39;</span><span class="p">]:</span>
        <span class="n">do_MC_atom_velo_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">nD</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_Galilean&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_dir_perturb_angle&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="c1"># completely random orientation, magnitude 1</span>
            <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">][:,:]</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">][:</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">],:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">])</span> <span class="c1"># what is this line doing?</span>

        <span class="k">elif</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_dir_perturb_angle&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="c1"># apply random rotations</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rotate_dir_3N</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">][</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]:,:],</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_dir_perturb_angle&#39;</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">rotate_dir_3N</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">],</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_dir_perturb_angle&#39;</span><span class="p">])</span>

    <span class="c1">#DOC \item if using fortran calculator and not reproducible</span>
    <span class="k">if</span> <span class="n">do_calc_fortran</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;reproducible&#39;</span><span class="p">]:</span>
        <span class="c1">#DOC \item call fortran MC code f\_MC\_MD.MC\_atom\_walk</span>
        <span class="n">at</span><span class="o">.</span><span class="n">wrap</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]):</span> 
            <span class="n">pp</span><span class="o">=</span><span class="n">at</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">pp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">&gt;</span><span class="mf">0.00001</span> <span class="ow">and</span> <span class="n">nD</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span> <span class="c1">#LIVIA</span>
                <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Not a 2D system anymore</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
 
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velocities&#39;</span><span class="p">]:</span>
            <span class="p">(</span><span class="n">n_try</span><span class="p">,</span> <span class="n">n_accept</span><span class="p">,</span> <span class="n">n_accept_velo</span><span class="p">,</span> <span class="n">final_E</span><span class="p">)</span> <span class="o">=</span> <span class="n">f_MC_MD</span><span class="o">.</span><span class="n">MC_atom_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">Emax</span><span class="o">-</span><span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_PE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_KE</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">nD</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">],</span> <span class="n">KEmax</span><span class="p">,</span> <span class="n">step_size_velo</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_E</span> <span class="o">+</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_PE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_KE</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_Galilean&#39;</span><span class="p">]:</span>
                <span class="p">(</span><span class="n">n_try</span><span class="p">,</span> <span class="n">n_accept</span><span class="p">,</span> <span class="n">final_E</span><span class="p">)</span> <span class="o">=</span> <span class="n">f_MC_MD</span><span class="o">.</span><span class="n">GMC_atom_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">Emax</span><span class="o">-</span><span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_PE</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">no_reverse</span><span class="o">=</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_no_reverse&#39;</span><span class="p">],</span> <span class="n">pert_ang</span><span class="o">=</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_dir_perturb_angle_during&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># fixed atoms MC works by including the number of atoms to be kept fixed - LIVIA</span>
                <span class="p">(</span><span class="n">n_try</span><span class="p">,</span> <span class="n">n_accept</span><span class="p">,</span> <span class="n">final_E</span><span class="p">)</span> <span class="o">=</span> <span class="n">f_MC_MD</span><span class="o">.</span><span class="n">MC_atom_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">Emax</span><span class="o">-</span><span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_PE</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">nD</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">],</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;wall_dist&#39;</span><span class="p">])</span>
            <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_E</span> <span class="o">+</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_PE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_KE</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="n">do_calc_lammps</span> <span class="ow">and</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_Galilean&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_fix_gmc&#39;</span><span class="p">]):</span>
        <span class="n">orig_pos</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]):</span> 
            <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">orig_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">&gt;</span><span class="mf">0.00001</span><span class="p">):</span> <span class="c1">#LIVIA</span>
                <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Not a 2D system anymore</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">orig_energy</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span>
        <span class="n">extra_term</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_PE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_KE</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">propagate_lammps</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="s1">&#39;GMC&#39;</span><span class="p">,</span> <span class="n">Emax</span><span class="o">=</span><span class="n">Emax</span><span class="o">-</span><span class="n">extra_term</span> <span class="p">):</span>
            <span class="n">energy1</span> <span class="o">=</span> <span class="n">pot</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">extra_term</span>
            <span class="k">if</span> <span class="n">energy1</span> <span class="o">&lt;</span> <span class="n">Emax</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy1</span>
                <span class="n">n_accept</span> <span class="o">=</span> <span class="n">n_steps</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_energy</span>
                <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">orig_pos</span><span class="p">)</span>
                <span class="n">n_accept</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># got an exception, reject traj</span>
            <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_energy</span>
            <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">orig_pos</span><span class="p">)</span>
            <span class="n">n_accept</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#DOC \item else</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#DOC \item do python MC</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velocities&#39;</span><span class="p">]:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;MC_atom_velocities only supported for FORTRAN calculator</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">dz</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="c1">#DOC \item if MC_atom_Galilean</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_Galilean&#39;</span><span class="p">]:</span>
            <span class="c1">#DOC \item go Galilean MC in python</span>

            <span class="n">do_no_reverse</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_no_reverse&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">do_no_reverse</span><span class="p">:</span>
                <span class="n">last_good_pos</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_reverse</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">n_reflect</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
            <span class="n">d_pos</span> <span class="o">=</span> <span class="n">step_size</span><span class="o">*</span><span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i_MC_step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">do_no_reverse</span><span class="p">:</span>
                    <span class="n">last_good_pos</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
                    <span class="n">last_good_d_pos</span> <span class="o">=</span> <span class="n">d_pos</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="c1"># perturb direction if needed</span>
                <span class="n">rotate_dir_3N</span><span class="p">(</span><span class="n">d_pos</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_dir_perturb_angle_during&#39;</span><span class="p">])</span>

                <span class="c1"># step and evaluate</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="n">d_pos</span>
                <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
                <span class="n">cur_E_is_correct</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">E</span> <span class="o">&gt;=</span> <span class="n">Emax</span><span class="p">:</span> <span class="c1"># reflect</span>
                    <span class="n">Fhat</span> <span class="o">=</span> <span class="n">eval_forces</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
                    <span class="n">Fhat</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Fhat</span><span class="p">)</span>
                    <span class="n">d_pos</span> <span class="o">-=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">Fhat</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Fhat</span><span class="o">*</span><span class="n">d_pos</span><span class="p">)</span>

                    <span class="n">n_reflect</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">do_no_reverse</span><span class="p">:</span> <span class="c1"># do reflection step and check for reverse</span>
                        <span class="c1"># step on reflected traj and evaluate</span>
                        <span class="n">pos</span> <span class="o">+=</span> <span class="n">d_pos</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                        <span class="n">E</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
                        <span class="n">cur_E_is_correct</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="n">E</span> <span class="o">&gt;=</span> <span class="n">Emax</span><span class="p">:</span> <span class="c1"># reverse</span>
                            <span class="n">pos</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">last_good_pos</span>
                            <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                            <span class="n">cur_E_is_correct</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">d_pos</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">last_good_d_pos</span>
                            <span class="n">n_reflect</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="n">n_reverse</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">do_no_reverse</span><span class="p">:</span> <span class="c1"># accept/reject</span>
                <span class="n">n_try</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">E</span> <span class="o">&lt;</span> <span class="n">Emax</span><span class="p">:</span> <span class="c1"># accept</span>
                    <span class="c1"># save new E, pos, direction</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">E</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">][:,:]</span> <span class="o">=</span> <span class="n">d_pos</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d_pos</span><span class="p">)</span>
                    <span class="n">n_accept</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># reject</span>
                    <span class="c1"># E and GMC_direction in at were never overwritten, no need to restore, but do need to reverse dir</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">last_good_pos</span><span class="p">)</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>
                    <span class="n">n_accept</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n_reverse</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cur_E_is_correct</span><span class="p">:</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">E</span>
                <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">][:,:]</span> <span class="o">=</span> <span class="n">d_pos</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d_pos</span><span class="p">)</span>
                <span class="n">n_try</span> <span class="o">=</span> <span class="n">n_reflect</span> <span class="o">+</span> <span class="n">n_reverse</span>
                <span class="n">n_accept</span> <span class="o">=</span> <span class="n">n_reflect</span>

        <span class="c1">#DOC \item else</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#DOC \item loop atom\_traj\_len times</span>
            <span class="k">for</span> <span class="n">i_MC_step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
                <span class="c1">#DOC \item loop over atoms in random order</span>
                <span class="n">at_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">)))</span>
                <span class="n">rng</span><span class="o">.</span><span class="n">shuffle_in_place</span><span class="p">(</span><span class="n">at_list</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i_at</span> <span class="ow">in</span> <span class="n">at_list</span><span class="p">:</span>
                    <span class="c1">#DOC \item propose single atom move</span>
                    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_uniform_rv&#39;</span><span class="p">]:</span>
                        <span class="n">dx</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="o">-</span><span class="n">step_size</span><span class="p">,</span><span class="n">step_size</span><span class="p">)</span>
                        <span class="n">dy</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="o">-</span><span class="n">step_size</span><span class="p">,</span><span class="n">step_size</span><span class="p">)</span>
                        <span class="n">dz</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
                            <span class="n">dz</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="o">-</span><span class="n">step_size</span><span class="p">,</span><span class="n">step_size</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dx</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">step_size</span><span class="p">)</span>
                        <span class="n">dy</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">step_size</span><span class="p">)</span>
                        <span class="n">dz</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
                            <span class="n">dz</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">step_size</span><span class="p">)</span>
                    <span class="n">orig_energy</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span>
                    <span class="n">orig_pos</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">orig_extra_data</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">new_pos</span> <span class="o">=</span> <span class="n">orig_pos</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">new_pos</span><span class="p">[</span><span class="n">i_at</span><span class="p">,:]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span><span class="n">dz</span><span class="p">)</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">new_pos</span><span class="p">)</span>
                    <span class="c1">#DOC \item accept/reject on E &lt; Emax</span>
                    <span class="n">energy</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">energy</span> <span class="o">&gt;=</span> <span class="n">Emax</span><span class="p">:</span>
                        <span class="c1"># reject move</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">orig_pos</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_extra_data</span>
                        <span class="n">energy</span> <span class="o">=</span> <span class="n">orig_energy</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">n_accept</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">n_accept_velo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;MC_atom_velo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_try</span><span class="p">,</span> <span class="n">n_accept_velo</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;MC_atom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_try</span><span class="p">,</span> <span class="n">n_accept</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="propose_volume_step">
<a class="viewcode-back" href="../ns_run.html#ns_run.propose_volume_step">[docs]</a>
<span class="k">def</span> <span class="nf">propose_volume_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">flat_V_prior</span><span class="p">):</span>
    <span class="n">dV</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">step_size</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">))</span>
    <span class="n">orig_V</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span>
    <span class="n">new_V</span> <span class="o">=</span> <span class="n">orig_V</span><span class="o">+</span><span class="n">dV</span>
    <span class="k">if</span> <span class="n">new_V</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># negative number cannot be raised to fractional power, so this is only to avoid fatal error during the run</span>
        <span class="n">new_V</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">new_V</span><span class="p">)</span>
        <span class="c1"># print(&quot;Warning, the step_size for volume change might be too big, resulted in negative new volume&quot;, step_size, dV, orig_V+dV)</span>
    <span class="c1">#print(&quot;TRANSFORM&quot;, new_V, orig_V, dV, step_size, len(at))</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">new_V</span><span class="o">/</span><span class="n">orig_V</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flat_V_prior</span><span class="p">:</span>
        <span class="n">p_accept</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p_accept</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="n">new_V</span><span class="o">/</span><span class="n">orig_V</span><span class="p">)</span><span class="o">**</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">p_accept</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span></div>


<div class="viewcode-block" id="propose_area_step">
<a class="viewcode-back" href="../ns_run.html#ns_run.propose_area_step">[docs]</a>
<span class="k">def</span> <span class="nf">propose_area_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">flat_V_prior</span><span class="p">):</span>
    <span class="n">dA</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">step_size</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">))</span>
    <span class="n">orig_cell</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()</span>
    <span class="n">orig_A</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span> <span class="o">/</span> <span class="n">orig_cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">new_A</span> <span class="o">=</span> <span class="n">orig_A</span><span class="o">+</span><span class="n">dA</span>
    <span class="k">if</span> <span class="n">new_A</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># negative number cannot be raised to fractional power, so this is only to avoid fatal error during the run</span>
        <span class="n">new_A</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">new_A</span><span class="p">)</span>
        <span class="c1"># print(&quot;Warning, the step_size for volume change might be too big, resulted in negative new volume&quot;, step_size, dV, orig_V+dV)</span>
    <span class="c1">#print(&quot;TRANSFORM&quot;, new_V, orig_V, dV, step_size, len(at))</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">new_A</span><span class="o">/</span><span class="n">orig_A</span><span class="p">)</span>
    <span class="n">transform</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># no change in the Z direction</span>
    <span class="k">if</span> <span class="n">flat_V_prior</span><span class="p">:</span>
        <span class="n">p_accept</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p_accept</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="n">new_A</span><span class="o">/</span><span class="n">orig_A</span><span class="p">)</span><span class="o">**</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">p_accept</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span></div>


<div class="viewcode-block" id="propose_shear_step">
<a class="viewcode-back" href="../ns_run.html#ns_run.propose_shear_step">[docs]</a>
<span class="k">def</span> <span class="nf">propose_shear_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">step_size</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
       <span class="c1"># pick random vector</span>
       <span class="n">rnd_vec_ind</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
       <span class="c1"># turn other two into orthonormal pair</span>
       <span class="n">other_vec_ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
       <span class="n">other_vec_ind</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rnd_vec_ind</span><span class="p">)</span>
       <span class="n">orig_cell</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()</span>
       <span class="n">v1</span> <span class="o">=</span> <span class="n">orig_cell</span><span class="p">[</span><span class="n">other_vec_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
       <span class="n">v1</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">v1</span><span class="p">))</span>
       <span class="c1">#pick random magnitude</span>
       <span class="n">rv1</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">step_size</span><span class="p">)</span>
       <span class="c1"># create new cell and transformation matrix</span>
       <span class="n">new_cell</span> <span class="o">=</span> <span class="n">orig_cell</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
       <span class="n">new_cell</span><span class="p">[</span><span class="n">rnd_vec_ind</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">rv1</span><span class="o">*</span><span class="n">v1</span>

   <span class="k">else</span><span class="p">:</span>
       <span class="c1"># pick random vector</span>
       <span class="n">rnd_vec_ind</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
       <span class="c1"># turn other two into orthonormal pair</span>
       <span class="n">other_vec_ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
       <span class="n">other_vec_ind</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rnd_vec_ind</span><span class="p">)</span>
       <span class="n">orig_cell</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()</span>
       <span class="n">v1</span> <span class="o">=</span> <span class="n">orig_cell</span><span class="p">[</span><span class="n">other_vec_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
       <span class="n">v2</span> <span class="o">=</span> <span class="n">orig_cell</span><span class="p">[</span><span class="n">other_vec_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
       <span class="n">v1</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">v1</span><span class="p">))</span>
       <span class="n">v2</span> <span class="o">-=</span> <span class="n">v1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">)</span>
       <span class="n">v2</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span><span class="n">v2</span><span class="p">))</span>
       <span class="c1"># pick random magnitudes</span>
       <span class="n">rv1</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">step_size</span><span class="p">)</span>
       <span class="n">rv2</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">step_size</span><span class="p">)</span>
       <span class="c1"># create new cell and transformation matrix</span>
       <span class="n">new_cell</span> <span class="o">=</span> <span class="n">orig_cell</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
       <span class="n">new_cell</span><span class="p">[</span><span class="n">rnd_vec_ind</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">rv1</span><span class="o">*</span><span class="n">v1</span> <span class="o">+</span> <span class="n">rv2</span><span class="o">*</span><span class="n">v2</span>
   <span class="n">transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">orig_cell</span><span class="p">),</span> <span class="n">new_cell</span><span class="p">)</span>
   <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span></div>


<div class="viewcode-block" id="propose_stretch_step">
<a class="viewcode-back" href="../ns_run.html#ns_run.propose_stretch_step">[docs]</a>
<span class="k">def</span> <span class="nf">propose_stretch_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">step_size</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
        <span class="n">rnd_v1_ind</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rnd_v2_ind</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rnd_v1_ind</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">rnd_v2_ind</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rnd_v1_ind</span> <span class="o">==</span> <span class="n">rnd_v2_ind</span><span class="p">:</span>
            <span class="n">rnd_v2_ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">rnd_v2_ind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span>

    <span class="n">rv</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">step_size</span><span class="p">)</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">transform</span><span class="p">[</span><span class="n">rnd_v1_ind</span><span class="p">,</span><span class="n">rnd_v1_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
    <span class="n">transform</span><span class="p">[</span><span class="n">rnd_v2_ind</span><span class="p">,</span><span class="n">rnd_v2_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">rv</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span></div>


<div class="viewcode-block" id="min_aspect_ratio">
<a class="viewcode-back" href="../ns_run.html#ns_run.min_aspect_ratio">[docs]</a>
<span class="k">def</span> <span class="nf">min_aspect_ratio</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
    <span class="n">min_aspect_ratio</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span>
    <span class="n">nD</span><span class="o">=</span><span class="mi">3</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
        <span class="c1"># in 2D, do not check the Z direction</span>
        <span class="n">nD</span><span class="o">=</span><span class="mi">2</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nD</span><span class="p">):</span>
        <span class="n">vi</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">vnorm_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">cell</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">3</span><span class="p">,:],</span><span class="n">cell</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">%</span><span class="mi">3</span><span class="p">,:])</span>
        <span class="n">vnorm_hat</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vnorm_hat</span><span class="p">,</span><span class="n">vnorm_hat</span><span class="p">))</span>
        <span class="n">min_aspect_ratio</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_aspect_ratio</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vnorm_hat</span><span class="p">,</span><span class="n">vi</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
        <span class="c1"># in 2D divide by the square root of area</span>
        <span class="n">min_aspect_ratio</span> <span class="o">/=</span> <span class="p">(</span><span class="n">vol</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,:],</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])))</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_aspect_ratio</span> <span class="o">/=</span> <span class="n">vol</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">min_aspect_ratio</span></div>


<div class="viewcode-block" id="do_cell_step">
<a class="viewcode-back" href="../ns_run.html#ns_run.do_cell_step">[docs]</a>
<span class="k">def</span> <span class="nf">do_cell_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">p_accept</span><span class="p">,</span> <span class="n">transform</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">p_accept</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="ow">and</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">p_accept</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># save old config and apply transformation</span>
    <span class="n">orig_cell</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()</span>
    <span class="n">new_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">orig_cell</span><span class="p">,</span><span class="n">transform</span><span class="p">)</span>
    <span class="n">new_vol</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">new_cell</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">new_cell</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">new_cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])))</span>

    <span class="c1"># check size and shape constraints</span>
    <span class="k">if</span> <span class="n">new_vol</span> <span class="o">&gt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;max_volume_per_atom&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="ow">or</span> <span class="n">new_vol</span> <span class="o">&lt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;min_volume_per_atom&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">min_aspect_ratio</span><span class="p">(</span><span class="n">new_vol</span><span class="p">,</span> <span class="n">new_cell</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_min_aspect_ratio&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># orig_cell already saved previous value</span>
    <span class="n">orig_pos</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">extra_data</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># set new positions and velocities</span>
    <span class="n">at</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">new_cell</span><span class="p">,</span> <span class="n">scale_atoms</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">Emax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># calculate new energy</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_energy</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;eval_energy got exception &quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">new_energy</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">Emax</span><span class="p">)</span>
        <span class="c1">#print(&quot;error in eval_energy setting new_energy = 2*abs(Emax)=&quot; , new_energy)</span>

    <span class="c1"># accept or reject</span>
    <span class="k">if</span> <span class="n">new_energy</span> <span class="o">&lt;</span> <span class="n">Emax</span><span class="p">:</span> <span class="c1"># accept</span>
        <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_energy</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># reject and revert</span>
        <span class="n">at</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">orig_cell</span><span class="p">,</span><span class="n">scale_atoms</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">orig_pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_data</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="do_cell_shape_walk">
<a class="viewcode-back" href="../ns_run.html#ns_run.do_cell_shape_walk">[docs]</a>
<span class="k">def</span> <span class="nf">do_cell_shape_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">):</span>
    <span class="n">possible_moves</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;MC_cell_shear&#39;</span><span class="p">:</span> <span class="n">propose_shear_step</span><span class="p">,</span>
        <span class="s1">&#39;MC_cell_stretch&#39;</span><span class="p">:</span> <span class="n">propose_stretch_step</span> <span class="p">}</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">possible_moves</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;cell_shape_equil_steps&#39;</span><span class="p">]):</span>
        <span class="n">rng</span><span class="o">.</span><span class="n">shuffle_in_place</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">propose_step_func</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="p">(</span><span class="n">p_accept</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span> <span class="o">=</span> <span class="n">propose_step_func</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_step_size&quot;</span><span class="p">])</span>
            <span class="n">do_cell_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">p_accept</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span></div>


<div class="viewcode-block" id="do_MC_semi_grand_step">
<a class="viewcode-back" href="../ns_run.html#ns_run.do_MC_semi_grand_step">[docs]</a>
<span class="k">def</span> <span class="nf">do_MC_semi_grand_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">Z_list</span>

    <span class="n">Z</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">()</span>
    <span class="n">n_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;semi_grand_potentials&#39;</span><span class="p">])</span>
    <span class="n">at_i</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">))</span>
    <span class="n">type_i</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_types</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">Z_list</span><span class="p">[</span><span class="n">type_i</span><span class="p">]</span> <span class="o">==</span> <span class="n">Z</span><span class="p">[</span><span class="n">at_i</span><span class="p">]:</span>
        <span class="n">type_i</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_types</span><span class="p">)</span>
    <span class="n">Z_new</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">Z_new</span><span class="p">[</span><span class="n">at_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_list</span><span class="p">[</span><span class="n">type_i</span><span class="p">]</span>
    <span class="n">at</span><span class="o">.</span><span class="n">set_atomic_numbers</span><span class="p">(</span><span class="n">Z_new</span><span class="p">)</span>

    <span class="n">new_energy</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="n">new_KE</span> <span class="o">=</span> <span class="n">eval_energy_KE</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new_energy</span> <span class="o">&lt;</span> <span class="n">Emax</span> <span class="ow">and</span> <span class="p">(</span><span class="n">KEmax</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">new_KE</span> <span class="o">&lt;</span> <span class="n">KEmax</span><span class="p">):</span> <span class="c1"># accept</span>
        <span class="c1"># update energy</span>
        <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_energy</span>
        <span class="n">n_accept</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># undo</span>
        <span class="n">at</span><span class="o">.</span><span class="n">set_atomic_numbers</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="n">n_accept</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;MC_semi_grand&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_accept</span><span class="p">)</span> <span class="p">})</span></div>


<div class="viewcode-block" id="do_MC_swap_step">
<a class="viewcode-back" href="../ns_run.html#ns_run.do_MC_swap_step">[docs]</a>
<span class="k">def</span> <span class="nf">do_MC_swap_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">):</span>
<span class="c1">#DOC</span>
<span class="c1">#DOC ``do_MC_swap_step``</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">()</span>

    <span class="c1">#DOC \item return if all atomic numbers are identical</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Z</span><span class="p">[:]</span> <span class="o">==</span> <span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="c1"># don&#39;t try to swap when all atoms are the same</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{})</span>

    <span class="n">r_cut</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_r_cut&#39;</span><span class="p">]</span>
    <span class="c1">#DOC \item randomly pick a desired cluster size</span>
    <span class="n">cluster_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_probs&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">cluster_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="p">(</span><span class="n">i_list</span><span class="p">,</span> <span class="n">j_list</span><span class="p">)</span> <span class="o">=</span> <span class="n">matscipy</span><span class="o">.</span><span class="n">neighbours</span><span class="o">.</span><span class="n">neighbour_list</span><span class="p">(</span><span class="s1">&#39;ij&#39;</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">r_cut</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">j_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1">#DOC \item pick two clusters with distinct atomic numbers, backing off to smaller clusters on failure to find appropriate larger clusters, but always pick at least a pair of atoms to swap</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">c1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">c2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="n">c1</span><span class="p">]</span> <span class="o">==</span> <span class="n">Z</span><span class="p">[</span><span class="n">c2</span><span class="p">])):</span>
        <span class="c1"># print(print_prefix, &quot;: do_MC_swap try to find cluster &quot;, cluster_size)</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">pick_interconnected_clump</span><span class="o">.</span><span class="n">pick_interconnected</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="n">i_list</span><span class="p">,</span> <span class="n">j_list</span><span class="p">,</span> <span class="n">cluster_size</span><span class="p">,</span> <span class="n">r_cut</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">pick_interconnected_clump</span><span class="o">.</span><span class="n">pick_interconnected</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="n">i_list</span><span class="p">,</span> <span class="n">j_list</span><span class="p">,</span> <span class="n">cluster_size</span><span class="p">,</span> <span class="n">r_cut</span><span class="p">)</span>
        <span class="c1"># print(print_prefix, &quot;: do_MC_swap got &quot;, c1, c2)</span>
        <span class="c1"># decrement cluster size</span>
        <span class="n">cluster_size</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">cluster_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cluster_size</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># failed to find appropriate</span>
    <span class="k">if</span> <span class="n">c1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">c2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="n">c1</span><span class="p">]</span> <span class="o">==</span> <span class="n">Z</span><span class="p">[</span><span class="n">c2</span><span class="p">]):</span>
        <span class="c1"># print(print_prefix, &quot;: do_MC_swap giving up on cluster &quot;,c1,c2)</span>
        <span class="c1"># return 1 for number of model calls so walk will finish, even if no clusters are ever found</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># print(print_prefix, &quot;: do_MC_swap trying cluster&quot;, c1, c2)</span>
    <span class="n">p_1_orig</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">c1</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">p_2_orig</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">c2</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">at</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">c1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">p_2_orig</span>
    <span class="n">at</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">c2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">p_1_orig</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_velo&#39;</span><span class="p">]:</span>
        <span class="c1"># TODO: don&#39;t do this for the time being, but we should be able to modify this</span>
        <span class="c1"># If we just swap particles by swapping positions, velocities will follow to the new position, and so will effectively be swapped</span>
        <span class="c1"># Therefore, if we _don&#39;t_ want to actually swap velocities, we have to (apparently) swap them</span>
        <span class="n">velocities</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_velocities</span><span class="p">()</span>
        <span class="n">v_1_orig</span> <span class="o">=</span> <span class="n">velocities</span><span class="p">[</span><span class="n">c1</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">v_2_orig</span> <span class="o">=</span> <span class="n">velocities</span><span class="p">[</span><span class="n">c2</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;no_swap_velo_fix_mag_alt&#39;</span><span class="p">]:</span>
            <span class="c1"># make velocity have the same direction, but magnitude from the previous velocity of the other particle so local KE and momentum are preserved</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_1_orig</span><span class="p">)</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_2_orig</span><span class="p">)</span>
            <span class="n">velocities</span><span class="p">[</span><span class="n">c1</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_2_orig</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">n1</span><span class="o">/</span><span class="n">n2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">velocities</span><span class="p">[</span><span class="n">c2</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_1_orig</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">n2</span><span class="o">/</span><span class="n">n1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># this will be executed (unnecessarily) even if all masses are the same</span>
            <span class="c1"># make velocity have same direction, and magnitude rescaled to keep local kinetic energy the same</span>
            <span class="n">masses</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_masses</span><span class="p">()</span>
            <span class="n">velocities</span><span class="p">[</span><span class="n">c1</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_2_orig</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">masses</span><span class="p">[</span><span class="n">c2</span><span class="p">]</span><span class="o">/</span><span class="n">masses</span><span class="p">[</span><span class="n">c1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">velocities</span><span class="p">[</span><span class="n">c2</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_1_orig</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">masses</span><span class="p">[</span><span class="n">c1</span><span class="p">]</span><span class="o">/</span><span class="n">masses</span><span class="p">[</span><span class="n">c2</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">at</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="n">velocities</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">extra_data_1_orig</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">][</span><span class="n">c1</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">extra_data_2_orig</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">][</span><span class="n">c2</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">][</span><span class="n">c1</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_data_2_orig</span>
        <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">][</span><span class="n">c2</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_data_1_orig</span>

    <span class="c1">#DOC \item accept swap if energy &lt; Emax</span>
    <span class="n">new_energy</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="n">new_KE</span> <span class="o">=</span> <span class="n">eval_energy_KE</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">new_energy</span> <span class="o">&lt;</span> <span class="n">Emax</span> <span class="ow">and</span> <span class="p">(</span><span class="n">KEmax</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">new_KE</span> <span class="o">&lt;</span> <span class="n">KEmax</span><span class="p">):</span> <span class="c1"># accept</span>
        <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_energy</span>
        <span class="n">accept_n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># reject</span>
        <span class="n">at</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">c1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">p_1_orig</span>
        <span class="n">at</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">c2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">p_2_orig</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_velo&#39;</span><span class="p">]:</span>
            <span class="n">velocities</span><span class="p">[</span><span class="n">c1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">v_1_orig</span>
            <span class="n">velocities</span><span class="p">[</span><span class="n">c2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">v_2_orig</span>
            <span class="n">at</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="n">velocities</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">][</span><span class="n">c1</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_data_1_orig</span>
            <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">][</span><span class="n">c2</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_data_2_orig</span>
        <span class="n">accept_n</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{(</span><span class="s1">&#39;MC_swap_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">c1</span><span class="p">))</span> <span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">accept_n</span><span class="p">)</span> <span class="p">})</span></div>


<div class="viewcode-block" id="do_MC_cell_volume_step">
<a class="viewcode-back" href="../ns_run.html#ns_run.do_MC_cell_volume_step">[docs]</a>
<span class="k">def</span> <span class="nf">do_MC_cell_volume_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">):</span>
<span class="c1">#DOC</span>
<span class="c1">#DOC ``do_MC_cell_volume_step``</span>
    <span class="n">step_rv</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">step_rv</span> <span class="o">&gt;</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_volume_per_atom_prob&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
        <span class="p">(</span><span class="n">p_accept</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span> <span class="o">=</span> <span class="n">propose_area_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_volume_per_atom_step_size&#39;</span><span class="p">],</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_flat_V_prior&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">(</span><span class="n">p_accept</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span> <span class="o">=</span> <span class="n">propose_volume_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_volume_per_atom_step_size&#39;</span><span class="p">],</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_flat_V_prior&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">do_cell_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">p_accept</span><span class="p">,</span> <span class="n">transform</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;MC_cell_volume_per_atom&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;MC_cell_volume_per_atom&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">})</span></div>


<div class="viewcode-block" id="do_MC_cell_shear_step">
<a class="viewcode-back" href="../ns_run.html#ns_run.do_MC_cell_shear_step">[docs]</a>
<span class="k">def</span> <span class="nf">do_MC_cell_shear_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">):</span>
<span class="c1">#DOC</span>
<span class="c1">#DOC ``do_MC_cell_shear_step``</span>
    <span class="n">step_rv</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">step_rv</span> <span class="o">&gt;</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_shear_prob&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{})</span>
    <span class="p">(</span><span class="n">p_accept</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span> <span class="o">=</span> <span class="n">propose_shear_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_shear_step_size&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">do_cell_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">p_accept</span><span class="p">,</span> <span class="n">transform</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;MC_cell_shear&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;MC_cell_shear&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">})</span></div>


<div class="viewcode-block" id="do_MC_cell_stretch_step">
<a class="viewcode-back" href="../ns_run.html#ns_run.do_MC_cell_stretch_step">[docs]</a>
<span class="k">def</span> <span class="nf">do_MC_cell_stretch_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">):</span>
<span class="c1">#DOC</span>
<span class="c1">#DOC ``do_MC_cell_stretch_step``</span>
    <span class="n">step_rv</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">step_rv</span> <span class="o">&gt;</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_stretch_prob&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{})</span>
    <span class="p">(</span><span class="n">p_accept</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span> <span class="o">=</span> <span class="n">propose_stretch_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_stretch_step_size&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">do_cell_step</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">p_accept</span><span class="p">,</span> <span class="n">transform</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;MC_cell_stretch&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;MC_cell_stretch&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">})</span></div>



<div class="viewcode-block" id="do_atom_walk">
<a class="viewcode-back" href="../ns_run.html#ns_run.do_atom_walk">[docs]</a>
<span class="k">def</span> <span class="nf">do_atom_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">):</span>
<span class="c1">#DOC</span>
<span class="c1">#DOC ``do_atom_walk``</span>
    <span class="n">n_reps</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps_per_call&#39;</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#DOC \item loop n\_atom\_steps\_per\_call times, calling do\_MC\_atom\_walk() or do\_MD\_atom\_walk()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_reps</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MC&#39;</span><span class="p">:</span>
            <span class="n">accumulate_stats</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">do_MC_atom_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MD&#39;</span><span class="p">:</span>
            <span class="n">accumulate_stats</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">do_MD_atom_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;do_atom_walk got unknown &#39;atom_algorithm&#39; = &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_algorithm&#39;</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">n_reps</span><span class="o">*</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len_cost_multiplier&#39;</span><span class="p">],</span> <span class="n">out</span><span class="p">)</span></div>


<div class="viewcode-block" id="rand_perturb_energy">
<a class="viewcode-back" href="../ns_run.html#ns_run.rand_perturb_energy">[docs]</a>
<span class="k">def</span> <span class="nf">rand_perturb_energy</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">perturbation</span><span class="p">,</span> <span class="n">Emax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">Emax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">energy</span> <span class="o">+=</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">*</span><span class="n">perturbation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">energy</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">*</span><span class="n">perturbation</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">pert</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">*</span><span class="n">perturbation</span>
            <span class="n">n_tries</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">energy</span><span class="o">+</span><span class="n">pert</span> <span class="o">&gt;=</span> <span class="n">Emax</span> <span class="ow">and</span> <span class="n">n_tries</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">pert</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">*</span><span class="n">perturbation</span>
                <span class="n">n_tries</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">energy</span><span class="o">+</span><span class="n">pert</span> <span class="o">&gt;=</span> <span class="n">Emax</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;WARNING: failed to do random energy perturbation below Emax &quot;</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">Emax</span><span class="p">)</span>
            <span class="n">energy</span> <span class="o">+=</span> <span class="n">pert</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pert</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">*</span><span class="n">perturbation</span>
            <span class="n">n_tries</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">energy</span><span class="o">*</span><span class="n">pert</span> <span class="o">&gt;=</span> <span class="n">Emax</span> <span class="ow">and</span> <span class="n">n_tries</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">pert</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">*</span><span class="n">perturbation</span>
                <span class="n">n_tries</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">energy</span><span class="o">*</span><span class="n">pert</span> <span class="o">&gt;=</span> <span class="n">Emax</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;WARNING: failed to do random energy perturbation below Emax &quot;</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">Emax</span><span class="p">)</span>
            <span class="n">energy</span> <span class="o">*=</span> <span class="n">pert</span>

    <span class="k">return</span> <span class="n">energy</span></div>


<span class="c1">####################################################################################################</span>

<div class="viewcode-block" id="add_to_list">
<a class="viewcode-back" href="../ns_run.html#ns_run.add_to_list">[docs]</a>
<span class="k">def</span> <span class="nf">add_to_list</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">costs</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">walk_len_avail</span><span class="p">,</span> <span class="n">first_free_slot</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">walk_len_avail</span><span class="p">,</span> <span class="n">first_free_slot</span><span class="p">)</span>

    <span class="n">n_steps_r</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">walk_len_avail</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">costs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nums</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">costs</span><span class="o">*</span><span class="n">nums</span><span class="p">)))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">costs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">n_steps_r_fract</span> <span class="o">=</span> <span class="n">n_steps_r</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">n_steps_r</span><span class="p">)</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rv</span> <span class="o">&lt;</span> <span class="n">n_steps_r_fract</span><span class="p">:</span>
        <span class="n">n_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">n_steps_r</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">n_steps_r</span><span class="p">))</span>

    <span class="nb">list</span><span class="p">[</span><span class="n">first_free_slot</span><span class="p">:</span><span class="n">first_free_slot</span><span class="o">+</span><span class="n">n_steps</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="n">n_steps</span>
    <span class="n">first_free_slot</span> <span class="o">+=</span> <span class="n">n_steps</span>
    <span class="n">walk_len_avail</span> <span class="o">-=</span> <span class="n">n_steps</span><span class="o">*</span><span class="n">costs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">walk_len_avail</span><span class="p">,</span> <span class="n">first_free_slot</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_list">
<a class="viewcode-back" href="../ns_run.html#ns_run.create_list">[docs]</a>
<span class="k">def</span> <span class="nf">create_list</span><span class="p">(</span><span class="n">costs</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">walk_len</span><span class="p">):</span>

    <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">walk_len_avail</span> <span class="o">=</span> <span class="n">walk_len</span>
    <span class="n">first_free_slot</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">costs</span><span class="p">)):</span>
        <span class="p">(</span><span class="n">walk_len_avail</span><span class="p">,</span> <span class="n">first_free_slot</span><span class="p">)</span> <span class="o">=</span> <span class="n">add_to_list</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">costs</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">walk_len_avail</span><span class="p">,</span> <span class="n">first_free_slot</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span></div>


<span class="c1">####################################################################################################</span>

<div class="viewcode-block" id="walk_single_walker">
<a class="viewcode-back" href="../ns_run.html#ns_run.walk_single_walker">[docs]</a>
<span class="k">def</span> <span class="nf">walk_single_walker</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Do random walk on a single atoms object.&quot;&quot;&quot;</span>
<span class="c1">#DOC</span>
<span class="c1">#DOC ``walk_single_walker``</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_good_load_balance&#39;</span><span class="p">]:</span>
        <span class="n">possible_moves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">do_atom_walk</span><span class="p">,</span>
                                   <span class="n">do_MC_cell_volume_step</span><span class="p">,</span>
                                   <span class="n">do_MC_cell_shear_step</span><span class="p">,</span>
                                   <span class="n">do_MC_cell_stretch_step</span><span class="p">,</span>
                                   <span class="n">do_MC_swap_step</span><span class="p">,</span>
                                   <span class="n">do_MC_semi_grand_step</span><span class="p">])</span>
        <span class="n">nums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps_n_calls&#39;</span><span class="p">],</span>
                         <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_volume_steps&#39;</span><span class="p">],</span>
                         <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_shear_steps&#39;</span><span class="p">],</span>
                         <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_stretch_steps&#39;</span><span class="p">],</span>
                         <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_swap_steps&#39;</span><span class="p">],</span>
                         <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_semi_grand_steps&#39;</span><span class="p">]])</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len_cost_multiplier&#39;</span><span class="p">],</span>
                          <span class="mi">1</span><span class="p">,</span>
                          <span class="mi">1</span><span class="p">,</span>
                          <span class="mi">1</span><span class="p">,</span>
                          <span class="mi">1</span><span class="p">,</span>
                          <span class="mi">1</span><span class="p">])</span>

        <span class="nb">list</span> <span class="o">=</span> <span class="n">create_list</span><span class="p">(</span><span class="n">costs</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">move_i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
            <span class="p">(</span><span class="n">t_n_model_calls</span><span class="p">,</span> <span class="n">t_out</span><span class="p">)</span> <span class="o">=</span> <span class="n">possible_moves</span><span class="p">[</span><span class="n">move_i</span><span class="p">](</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span>
                                                              <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">)</span>
            <span class="n">accumulate_stats</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">t_out</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#DOC \item create list</span>
                            <span class="c1">#DOC \item do\_atom\_walk :math:`*` n\_atom\_step\_n\_calls</span>
        <span class="n">possible_moves</span> <span class="o">=</span> <span class="p">([</span><span class="n">do_atom_walk</span><span class="p">]</span> <span class="o">*</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps_n_calls&#39;</span><span class="p">]</span> <span class="o">+</span>
                            <span class="c1">#DOC \item do\_cell\_volume\_step :math:`*` n\_cell\_volume\_steps</span>
                          <span class="p">[</span><span class="n">do_MC_cell_volume_step</span><span class="p">]</span> <span class="o">*</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_volume_steps&#39;</span><span class="p">]</span> <span class="o">+</span>
                            <span class="c1">#DOC \item do\_cell\_shear\_step :math:`*` n\_cell\_shear\_steps</span>
                          <span class="p">[</span><span class="n">do_MC_cell_shear_step</span><span class="p">]</span> <span class="o">*</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_shear_steps&#39;</span><span class="p">]</span> <span class="o">+</span>
                            <span class="c1">#DOC \item do\_cell\_stretch\_step :math:`*` n\_cell\_stretch\_steps</span>
                          <span class="p">[</span><span class="n">do_MC_cell_stretch_step</span><span class="p">]</span> <span class="o">*</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_stretch_steps&#39;</span><span class="p">]</span> <span class="o">+</span>
                            <span class="c1">#DOC \item do\_swap\_step :math:`*` n\_swap\_steps</span>
                          <span class="p">[</span><span class="n">do_MC_swap_step</span><span class="p">]</span> <span class="o">*</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_swap_steps&#39;</span><span class="p">]</span> <span class="o">+</span>
                            <span class="c1">#DOC \item do\_semi\_grand\_step :math:`*` n\_semi\_grand\_steps</span>
                          <span class="p">[</span><span class="n">do_MC_semi_grand_step</span><span class="p">]</span> <span class="o">*</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_semi_grand_steps&#39;</span><span class="p">])</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">n_model_calls_used</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#DOC \item loop while n\_model\_calls\_used &lt; n\_model\_calls</span>
        <span class="k">while</span> <span class="n">n_model_calls_used</span> <span class="o">&lt;</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">]:</span>
            <span class="c1">#DOC \item pick random item from list</span>
            <span class="n">move</span> <span class="o">=</span> <span class="n">possible_moves</span><span class="p">[</span><span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible_moves</span><span class="p">))]</span>
            <span class="c1">#DOC \item do move</span>
            <span class="p">(</span><span class="n">t_n_model_calls</span><span class="p">,</span> <span class="n">t_out</span><span class="p">)</span> <span class="o">=</span> <span class="n">move</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">)</span>
            <span class="n">n_model_calls_used</span> <span class="o">+=</span> <span class="n">t_n_model_calls</span>
            <span class="n">accumulate_stats</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">t_out</span><span class="p">)</span>

    <span class="c1">#DOC \item perturb final energy by random\_energy\_perturbation</span>
    <span class="c1"># perturb final energy</span>
    <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand_perturb_energy</span><span class="p">(</span>
        <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">],</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_energy_perturbation&#39;</span><span class="p">],</span> <span class="n">Emax</span><span class="p">)</span>

    <span class="c1"># DEBUG print(&quot;walk_single_walker end &quot;, eval_energy(at, do_PE=False),</span>
    <span class="c1"># eval_energy(at) #DEBUG)</span>

    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="max_energy">
<a class="viewcode-back" href="../ns_run.html#ns_run.max_energy">[docs]</a>
<span class="k">def</span> <span class="nf">max_energy</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">kinetic_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect the current energies of the walkers from all the processes and</span>
<span class="sd">    chooses the right number of highest energies to be culled&quot;&quot;&quot;</span>
    <span class="c1"># do local max</span>
    <span class="k">if</span> <span class="n">kinetic_only</span><span class="p">:</span>
        <span class="n">energies_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">eval_energy_KE</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">energies_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
    <span class="n">volumes_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">at</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">energies_loc</span><span class="p">))</span> <span class="p">)</span>
        <span class="n">volumes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">volumes_loc</span><span class="p">))</span> <span class="p">)</span>
        <span class="c1"># comm.barrier() #BARRIER</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">Allgather</span><span class="p">(</span> <span class="p">[</span> <span class="n">energies_loc</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">DOUBLE</span> <span class="p">],</span> <span class="p">[</span> <span class="n">energies</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">DOUBLE</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">energies</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">Allgather</span><span class="p">(</span> <span class="p">[</span> <span class="n">volumes_loc</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">DOUBLE</span> <span class="p">],</span> <span class="p">[</span> <span class="n">volumes</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">DOUBLE</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">volumes</span> <span class="o">=</span> <span class="n">volumes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">energies_loc</span>
        <span class="n">volumes</span> <span class="o">=</span> <span class="n">volumes_loc</span>

    <span class="c1"># n is n_cull</span>
    <span class="n">Emax_ind</span> <span class="o">=</span> <span class="n">energies</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Emax</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="n">Emax_ind</span><span class="p">]</span>
    <span class="n">Vmax</span> <span class="o">=</span> <span class="n">volumes</span><span class="p">[</span><span class="n">Emax_ind</span><span class="p">]</span>
    <span class="c1"># WARNING: assumes that each node has equal number of walkers</span>
    <span class="n">rank_of_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Emax_ind</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">walkers</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ind_of_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">Emax_ind</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">walkers</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">Emax</span><span class="p">,</span> <span class="n">Vmax</span><span class="p">,</span> <span class="n">rank_of_max</span><span class="p">,</span> <span class="n">ind_of_max</span><span class="p">)</span></div>


<span class="c1"># WARNING: full_auto_set_stepsizes shouldn&#39;t really depend on walk_stats from a real walk, since it does all its own pilot walks</span>
<span class="c1"># right now it uses this data structure to figure out what kind of steps actually occur, but it should probably get this</span>
<span class="c1"># information right from movement_args, rather than relying on what happened to have happened in the real walks</span>
<div class="viewcode-block" id="full_auto_set_stepsizes">
<a class="viewcode-back" href="../ns_run.html#ns_run.full_auto_set_stepsizes">[docs]</a>
<span class="k">def</span> <span class="nf">full_auto_set_stepsizes</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="n">walk_stats</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">,</span> <span class="n">size_n_proc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Automatically set all step sizes. Returns the time (in seconds) taken for the routine to run.&quot;&quot;&quot;</span>
<span class="c1">#DOC</span>
<span class="c1">#DOC ``full_auto_set_stepsizes``</span>
    <span class="c1">#DOC \item Step sizes for each (H)MC move are set via a loop which performs additional exploration moves, calibrating each step size to obtain an acceptance rate inside a specified range.</span>

    <span class="k">global</span> <span class="n">print_prefix</span>

    <span class="n">orig_prefix</span> <span class="o">=</span> <span class="n">print_prefix</span>
    <span class="n">print_prefix</span> <span class="o">=</span> <span class="s2">&quot;full_auto&quot;</span>
    <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">print_prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">print_prefix</span><span class="p">)</span>

    <span class="n">full_auto_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">n_samples_per_move_type</span><span class="o">=</span><span class="mi">200</span> <span class="c1"># total number of (H)MC moves used to set each step length</span>

    <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">walk_n_walkers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n_samples_per_move_type</span><span class="p">)</span><span class="o">/</span><span class="n">size_n_proc</span><span class="p">))</span>
        <span class="c1"># in each trial we will evolve walk_n_walkers configurations</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">walk_n_walkers</span> <span class="o">=</span> <span class="n">n_samples_per_move_type</span>
    <span class="c1">#DOC \item The routine is MPI parallelised, so that the wall time goes as 1/num\_of\_processes</span>

    <span class="n">key_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">walk_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Identify move types that are being used</span>
        <span class="c1"># Not all processes may have used the same move types</span>
        <span class="n">key_ints</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;MD_atom&quot;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;MC_atom&quot;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;MC_atom_velo&quot;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;MC_cell_shear&quot;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;MC_cell_stretch&quot;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;MC_cell_volume_per_atom&quot;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">key</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MC_swap&quot;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">key_ints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">key_flags</span> <span class="o">=</span>  <span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">key_ints</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)])</span>

        <span class="n">totalkeys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">key_flags</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">Allreduce</span><span class="p">([</span><span class="n">key_flags</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">INT</span><span class="p">],</span> <span class="p">[</span><span class="n">totalkeys</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">INT</span><span class="p">],</span> <span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>

        <span class="n">key_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">totalkeys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;MD_atom&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;MC_atom&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;MC_atom_velo&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;MC_cell_shear&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">4</span><span class="p">):</span>
                    <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;MC_cell_stretch&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">5</span><span class="p">):</span>
                    <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;MC_cell_volume_per_atom&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">6</span><span class="p">):</span>
                    <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;MC_swap_&quot;</span><span class="p">)</span>

    <span class="c1">#DOC \item For each (H)MC move type the following is performed</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">:</span>

        <span class="c1">#DOC \item Set &#39;&#39;movement\_args&#39;&#39; parameters so that only one (H)MC call is made at a time</span>
        <span class="c1"># reprogram n_atom_steps_n_calls, n_cell_volume_steps, n_cell_shear_steps, n_cell_stretch_steps, n_swap_steps according to key</span>
        <span class="c1"># possible key values:</span>
        <span class="c1"># MD_atom # atoms HMC</span>
        <span class="c1"># MC_atom # MC atom sweeps</span>
        <span class="c1"># MC_atom_velo # MC velocity sweeps</span>
        <span class="c1"># MC_cell_shear # cell shear move</span>
        <span class="c1"># MC_cell_stretch # cell stretch move</span>
        <span class="c1"># MC_cell_volume_per_atom # volume move</span>

        <span class="n">exploration_movement_args</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">movement_args</span><span class="p">)</span>
        <span class="c1"># turn all step types off to begin with</span>
        <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps_n_calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_volume_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_shear_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_stretch_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_swap_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_semi_grand_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velocities&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>

        <span class="n">nD</span><span class="o">=</span><span class="mi">3</span>
        <span class="k">if</span> <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
           <span class="n">nD</span><span class="o">=</span><span class="mi">2</span>

        <span class="c1"># check that the total number of attempts for this key is not zero</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">walk_stats</span><span class="p">:</span>
            <span class="p">(</span><span class="n">n_try</span><span class="p">,</span> <span class="n">n_accept</span><span class="p">)</span> <span class="o">=</span> <span class="n">walk_stats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_try</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">n_try_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">n_try_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">n_try</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
            <span class="n">comm</span><span class="o">.</span><span class="n">Allreduce</span><span class="p">([</span><span class="n">n_try_s</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">INT</span><span class="p">],</span> <span class="p">[</span><span class="n">n_try_g</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">INT</span><span class="p">],</span> <span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_try_g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_try</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">n_try_g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">continue</span> <span class="c1"># skip this key - it is not used</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">==</span><span class="s2">&quot;MD_atom&quot;</span> <span class="ow">or</span> <span class="n">key</span><span class="o">==</span><span class="s2">&quot;MC_atom&quot;</span><span class="p">):</span>
            <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps_n_calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># one call to do_atom_walk per walk_single_walker call</span>

            <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps_per_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># do_atom_walk makes one do_MC_walk/do_MD_walk per call</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;MC_atom&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_Galilean&#39;</span><span class="p">]:</span>
                <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="c1"># 1 atom sweep per do_MC_walk call</span>
                <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len_cost_multiplier&#39;</span><span class="p">]</span>
                <span class="c1"># The do_atom_walk routine reports that it has performed</span>
                <span class="c1"># #model_calls = the number of complete MC sweeps performed,</span>
                <span class="c1"># rather than single point evaluations.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len_cost_multiplier&#39;</span><span class="p">]</span>
                <span class="c1"># The do_atom_walk routine reports that it has performed</span>
                <span class="c1"># #model_calls = number of single point evaluations (time steps)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">key</span><span class="o">==</span><span class="s2">&quot;MC_atom_velo&quot;</span><span class="p">):</span>
            <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;velo_traj_len&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velo_walk_rej_free&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
            <span class="c1"># one velocities sweep</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">key</span><span class="o">==</span><span class="s2">&quot;MC_cell_shear&quot;</span><span class="p">):</span>
            <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_shear_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># one call to do_MC_cell_shear_step per walk_single_walker call</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">key</span><span class="o">==</span><span class="s2">&quot;MC_cell_stretch&quot;</span><span class="p">):</span>
            <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_stretch_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># one call to do_MC_cell_stretch_step per walk_single_walker call</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">key</span><span class="o">==</span><span class="s2">&quot;MC_cell_volume_per_atom&quot;</span><span class="p">):</span>
            <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_volume_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># one call to do_MC_cell_volume_step per walk_single_walker call</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">key</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MC_swap&quot;</span><span class="p">):</span>
            <span class="c1"># skip swap moves, since they have no step size</span>
            <span class="k">break</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;full_auto_set_stepsizes got key &#39;</span><span class="si">%s</span><span class="s2">&#39;, unkown to this routine</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1">#DOC \item Min and max acceptance rates are copied from parameters MC\_adjust\_min\_rate / MD\_adjust\_min\_rate and MC\_adjust\_max\_rate / MD\_adjust\_max\_rate</span>

        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;MC&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;MC_atom_step_size&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_Galilean&#39;</span><span class="p">]:</span>
                <span class="n">min_rate</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_adjust_min_rate&#39;</span><span class="p">]</span>
                <span class="n">max_rate</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_adjust_max_rate&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">min_rate</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_adjust_min_rate&#39;</span><span class="p">]</span>
                <span class="n">max_rate</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_adjust_max_rate&#39;</span><span class="p">]</span>
            <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;step_size&quot;</span>
        <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;MD&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">min_rate</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_adjust_min_rate&#39;</span><span class="p">]</span>
            <span class="n">max_rate</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_adjust_max_rate&#39;</span><span class="p">]</span>
            <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;timestep&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;full_auto_set_stepsizes got key &#39;</span><span class="si">%s</span><span class="s2">&#39;, neither MC nor MD</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="n">first_walker</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">walkers</span><span class="p">))</span> <span class="c1"># random starting point for config selection</span>
        <span class="n">first_time</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># we will make at least two tries. Logical flag ensures this.</span>

        <span class="n">steplength_store</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span>
        <span class="c1"># protects against possible future bugs that would be hard to detect</span>


        <span class="c1">#DOC \item Step size calibration loop:</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># clear acceptance / trial stats for new step size</span>
            <span class="n">stats_cumul</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># clear acceptance / trial stats for new step size</span>
            <span class="c1">#DOC \item Repeat the following 200/num\_of\_MPI\_processes times:</span>
                <span class="c1">#DOC \item Copy a configuration from the live set (each MPI process chooses a different configuration)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">first_walker</span><span class="p">,</span><span class="n">first_walker</span> <span class="o">+</span> <span class="n">walk_n_walkers</span><span class="p">):</span>

                <span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">walkers</span><span class="p">)</span> <span class="c1"># cycle through walkers array</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># copy config k into buffer &quot;buf&quot; for walking (walkers array unchanged)</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">calc</span> <span class="c1"># copy calculator</span>

                <span class="c1">#DOC \item Each MPI processes performs one (H)MC move on its cloned configuration</span>
                <span class="c1"># build up stats from walkers</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">key</span><span class="o">==</span><span class="s2">&quot;MC_atom_velo&quot;</span><span class="p">):</span>
                    <span class="n">stats</span> <span class="o">=</span> <span class="n">walk_single_walker</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">exploration_movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stats</span> <span class="o">=</span> <span class="n">do_MC_atom_velo_walk</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">exploration_movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">nD</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">)</span>

                  <span class="c1">#DOC     running statistics for the number of accepted/rejected moves on each process are recorded</span>
                <span class="n">accumulate_stats</span><span class="p">(</span><span class="n">stats_cumul</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span>

            <span class="n">first_walker</span> <span class="o">=</span> <span class="n">first_walker</span> <span class="o">+</span> <span class="n">walk_n_walkers</span> <span class="c1"># cycle through local samples</span>
            <span class="p">(</span><span class="n">n_try</span><span class="p">,</span> <span class="n">n_accept</span><span class="p">)</span> <span class="o">=</span> <span class="n">stats_cumul</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">n_try_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">n_try</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
                <span class="n">n_accept_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">n_accept</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
                <span class="n">n_try_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">n_accept_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="c1"># comm.barrier() #BARRIER</span>
                <span class="n">comm</span><span class="o">.</span><span class="n">Allreduce</span><span class="p">([</span><span class="n">n_try_s</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">INT</span><span class="p">],</span> <span class="p">[</span><span class="n">n_try_g</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">INT</span><span class="p">],</span> <span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
                <span class="n">comm</span><span class="o">.</span><span class="n">Allreduce</span><span class="p">([</span><span class="n">n_accept_s</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">INT</span><span class="p">],</span> <span class="p">[</span><span class="n">n_accept_g</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">INT</span><span class="p">],</span> <span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
                <span class="n">n_try</span> <span class="o">=</span> <span class="n">n_try_g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">n_accept</span> <span class="o">=</span> <span class="n">n_accept_g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_accept</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">n_try</span><span class="p">)</span>
            <span class="c1">#DOC \item The total number of accepted/rejected moves for this step size (summed across all MPI processes) are estabilshed</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span> <span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;trial stepsize and accept rate for </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%e</span><span class="s2"> , </span><span class="si">%f</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">],</span> <span class="n">rate</span><span class="p">,</span> <span class="n">n_try</span><span class="p">))</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="o">&gt;</span><span class="n">min_rate</span> <span class="ow">and</span> <span class="n">rate</span><span class="o">&lt;</span><span class="n">max_rate</span><span class="p">):</span>
                <span class="c1">#DOC \item If the total acceptance rate is within the desired range, return this stepsize</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;full_auto_set_stepsizes adjusted </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]))</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span> <span class="ow">not</span> <span class="n">first_time</span> <span class="p">):</span> <span class="c1"># dodge this the first time round</span>
                    <span class="c1"># Check whether rate and rate_store are on different sides</span>
                    <span class="c1"># of interval</span>
                    <span class="k">if</span> <span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span><span class="n">rate_store</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_rate</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span><span class="n">rate_store</span><span class="p">)</span><span class="o">&gt;</span><span class="n">max_rate</span><span class="p">)):</span>
                        <span class="c1">#DOC \item If this is NOT the first time the loop has been performed for this (H)MC move AND we previously obtained an acceptance rate on one side of the desired range, and now find an acceptance rate on the other side of the desired range</span>
                            <span class="c1">#DOC \item Return the step size that gave an acceptance rate closest to the middle of the desired range.</span>

                        <span class="c1"># check which gives a accept_rate closer to centre of acceptable window</span>
                        <span class="c1"># and take that</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">min_rate</span><span class="o">+</span><span class="n">max_rate</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rate</span><span class="o">-</span><span class="n">target</span><span class="p">)</span><span class="o">&lt;</span><span class="nb">abs</span><span class="p">(</span><span class="n">rate_store</span><span class="o">-</span><span class="n">target</span><span class="p">)):</span>
                            <span class="c1"># take current step length</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                                <span class="nb">print</span><span class="p">(</span> <span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;full_auto_set_stepsizes adjusted </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span> <span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]))</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># take saved step length</span>
                            <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">steplength_store</span>
                            <span class="n">exploration_movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">steplength_store</span>
                            <span class="n">rate</span> <span class="o">=</span> <span class="n">rate_store</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                                <span class="nb">print</span><span class="p">(</span> <span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;full_auto_set_stepsizes adjusted </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]))</span>
                            <span class="k">break</span>

                <span class="k">else</span><span class="p">:</span> <span class="c1"># this is the first time</span>
                    <span class="n">first_time</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1">#DOC \item Store step length and acceptance rate</span>
                <span class="c1"># save current step length and acceptance rate</span>
                <span class="n">steplength_store</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span>
                <span class="n">rate_store</span> <span class="o">=</span> <span class="n">rate</span>

                <span class="c1">#DOC \item update step length, by :math:`*` or :math:`/` by MC\_adjust\_step\_factor, to improve acceptance rate</span>
                <span class="c1">#update step length</span>
                <span class="nb">dir</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">rate</span> <span class="o">&lt;</span> <span class="n">min_rate</span><span class="p">:</span>
                    <span class="n">exp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                    <span class="nb">dir</span> <span class="o">=</span> <span class="s2">&quot;down&quot;</span>
                <span class="k">elif</span> <span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">max_rate</span><span class="p">:</span>
                    <span class="n">exp</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="nb">dir</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exp</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># try to adjust</span>
                <span class="k">if</span> <span class="nb">dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span> <span class="o">*=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_adjust_step_factor&#39;</span><span class="p">]</span><span class="o">**</span><span class="n">exp</span>
                    <span class="n">exploration_movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span> <span class="o">*=</span> <span class="n">exploration_movement_args</span><span class="p">[</span><span class="s1">&#39;MC_adjust_step_factor&#39;</span><span class="p">]</span><span class="o">**</span><span class="n">exp</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span> <span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;new trial step size for </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]))</span>

                <span class="c1">#DOC \item Check that step size is not larger than max allowed value (specified by user), and also that step size is not smaller than 10\ :sup:`-20`\ (useful for detecting errors).</span>
                <span class="c1"># if exceeded maximum, cap change</span>
                <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="o">+</span><span class="s2">&quot;_max&quot;</span><span class="p">]:</span>
                    <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="o">+</span><span class="s2">&quot;_max&quot;</span><span class="p">]</span>
                    <span class="n">exploration_movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">exploration_movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="o">+</span><span class="s2">&quot;_max&quot;</span><span class="p">]</span>
                <span class="c1"># Error check:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0e-20</span><span class="p">):</span>
                    <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;full_auto_set_stepsizes got &#39;</span><span class="si">%s</span><span class="s2">&#39;_&#39;</span><span class="si">%s</span><span class="s2">&#39; = &#39;</span><span class="si">%e</span><span class="s2">&#39;: too small. Is everything correct?</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]),</span> <span class="mi">25</span><span class="p">)</span>

                <span class="c1"># if was already at max and didn&#39;t really change, break</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span> <span class="o">==</span> <span class="n">steplength_store</span><span class="p">):</span>
                    <span class="nb">dir</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span> <span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;full_auto_set_stepsizes adjusted </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]))</span>
                    <span class="k">break</span>

    <span class="c1">#DOC \item Return step sizes and time taken for routine to run</span>

    <span class="n">print_prefix</span> <span class="o">=</span> <span class="n">orig_prefix</span>

    <span class="n">full_auto_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">full_auto_end_time</span> <span class="o">-</span> <span class="n">full_auto_start_time</span>
    <span class="k">return</span> <span class="n">duration</span></div>


<div class="viewcode-block" id="adjust_step_sizes">
<a class="viewcode-back" href="../ns_run.html#ns_run.adjust_step_sizes">[docs]</a>
<span class="k">def</span> <span class="nf">adjust_step_sizes</span><span class="p">(</span><span class="n">walk_stats</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">do_print_rate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">monitor_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adjust step size to keep the acceptance ratio at the desired level.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">walk_stats</span><span class="p">:</span>
        <span class="p">(</span><span class="n">n_try</span><span class="p">,</span> <span class="n">n_accept</span><span class="p">)</span> <span class="o">=</span> <span class="n">walk_stats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_try_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">n_try</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
            <span class="n">n_accept_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">n_accept</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
            <span class="n">n_try_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">n_accept_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="c1"># comm.barrier() #BARRIER</span>
            <span class="n">comm</span><span class="o">.</span><span class="n">Allreduce</span><span class="p">([</span><span class="n">n_try_s</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">INT</span><span class="p">],</span> <span class="p">[</span><span class="n">n_try_g</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">INT</span><span class="p">],</span> <span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
            <span class="n">comm</span><span class="o">.</span><span class="n">Allreduce</span><span class="p">([</span><span class="n">n_accept_s</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">INT</span><span class="p">],</span> <span class="p">[</span><span class="n">n_accept_g</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">INT</span><span class="p">],</span> <span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
            <span class="n">n_try</span> <span class="o">=</span> <span class="n">n_try_g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n_accept</span> <span class="o">=</span> <span class="n">n_accept_g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">n_try</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_accept</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">n_try</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">do_print_rate</span> <span class="ow">and</span> <span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;accept rate for </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%f</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">n_try</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">monitor_only</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;MC&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;MC_atom_step_size&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_Galilean&#39;</span><span class="p">]:</span>
                    <span class="n">min_rate</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_adjust_min_rate&#39;</span><span class="p">]</span>
                    <span class="n">max_rate</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_adjust_max_rate&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">min_rate</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_adjust_min_rate&#39;</span><span class="p">]</span>
                    <span class="n">max_rate</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_adjust_max_rate&#39;</span><span class="p">]</span>
                <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;step_size&quot;</span>
            <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;MD&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">min_rate</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_adjust_min_rate&#39;</span><span class="p">]</span>
                <span class="n">max_rate</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_adjust_max_rate&#39;</span><span class="p">]</span>
                <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;timestep&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;WARNING: adjust_step_size got key &#39;</span><span class="si">%s</span><span class="s2">&#39;, neither MC nor MD</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">movement_args</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="nb">dir</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">rate</span> <span class="o">&lt;</span> <span class="n">min_rate</span><span class="p">:</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                <span class="nb">dir</span> <span class="o">=</span> <span class="s2">&quot;down&quot;</span>
            <span class="k">elif</span> <span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">max_rate</span><span class="p">:</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="nb">dir</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span>

            <span class="n">orig_value</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># try to adjust</span>
                <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span> <span class="o">*=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_adjust_step_factor&#39;</span><span class="p">]</span><span class="o">**</span><span class="n">exp</span>
                <span class="c1"># if exceeded maximum, cap change</span>
                <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="o">+</span><span class="s2">&quot;_max&quot;</span><span class="p">]:</span>
                    <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="o">+</span><span class="s2">&quot;_max&quot;</span><span class="p">]</span>

            <span class="c1"># if was already at max and didn&#39;t really change, unset dir</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span> <span class="o">==</span> <span class="n">orig_value</span><span class="p">:</span>
                <span class="nb">dir</span><span class="o">=</span><span class="kc">None</span>

            <span class="k">if</span> <span class="nb">dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span> <span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;adjust_step_sizes adjusted </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">suffix</span><span class="p">]))</span></div>



<div class="viewcode-block" id="zero_stats">
<a class="viewcode-back" href="../ns_run.html#ns_run.zero_stats">[docs]</a>
<span class="k">def</span> <span class="nf">zero_stats</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">movement_args</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(.*)_(step_size|timestep)$&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="accumulate_stats">
<a class="viewcode-back" href="../ns_run.html#ns_run.accumulate_stats">[docs]</a>
<span class="k">def</span> <span class="nf">accumulate_stats</span><span class="p">(</span><span class="n">d_cumul</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d_cumul</span><span class="p">:</span>
            <span class="n">d_cumul</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">i1</span><span class="o">+</span><span class="n">i2</span> <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">d_cumul</span><span class="p">[</span><span class="n">key</span><span class="p">])])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d_cumul</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>



<span class="c1"># figure out n_steps to walk on each iteration to get correct expected number</span>
<div class="viewcode-block" id="set_n_from_expected">
<a class="viewcode-back" href="../ns_run.html#ns_run.set_n_from_expected">[docs]</a>
<span class="k">def</span> <span class="nf">set_n_from_expected</span><span class="p">(</span><span class="n">prop</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">prop</span><span class="o">+</span><span class="s1">&#39;_expected&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Got both &quot;</span><span class="o">+</span><span class="n">prop</span><span class="o">+</span><span class="s2">&quot; and &quot;</span><span class="o">+</span><span class="n">prop</span><span class="o">+</span><span class="s2">&quot;_expected, conflict</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Calculating </span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">_expected=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">prop</span><span class="o">+</span><span class="s1">&#39;_expected&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">max_n_cull_per_task</span><span class="o">*</span><span class="n">size</span> <span class="o">==</span> <span class="n">n_cull</span> <span class="ow">and</span> <span class="n">n_extra_walk_per_task</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># no extra walkers</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">prop</span><span class="o">+</span><span class="s1">&#39;_expected&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;No extra walkers (n_cull mod n_tasks == 0), trivial, so average n_walks at kill is 1, and </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">_expected&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">prop</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># f_c = n_c/n_t [ fraction of total that are culled (and walked once)]</span>
            <span class="c1"># f_e = n_e/(n_t-n_c) [fraction of ones that aren&#39;t culled that are also walked ]</span>

            <span class="c1"># n(1) &lt;- f_c n_t + (1-f_c)*(1-f_e) n(1)</span>
            <span class="c1"># n(l &gt;= 2) &lt;- (1-f_c)(1-f_e) n(l) + (1-f_c) f_e n(l-1)</span>

            <span class="c1"># f = (1-f_c)f_e / (f_c+f_e - f_c f_e)</span>

            <span class="c1"># n(1)/n_t = f_c/(1-(1-f_c)(1-f_e)) = f_c/(f_c+f_e-f_c f_e)</span>
            <span class="c1"># n(l &gt;= 2)/n_t = f n(l-1) = f^(l-1) n(1)/n_t</span>
            <span class="c1"># n_walks = n(1)/n_t + sum_{l=2}^\infty l n(l)/n_t</span>
            <span class="c1">#         = n(1)/n_t (1 + sum_{l=2}^\infty l f^{l-1})</span>
            <span class="c1">#         = n(1)/n_t (1 + \sum{l=1}^\infty (l+1) f^l)</span>
            <span class="c1">#         = n(1)/n_t (1 + \sum f^l + sum l f^l)</span>
            <span class="c1">#         = n(1)/n_t (1 + f/(1-f) + f/(1-f)**2</span>

            <span class="n">f_cull</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_cull</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">])</span>
            <span class="n">f_extra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="p">(</span><span class="n">max_n_cull_per_task</span><span class="o">*</span><span class="n">size</span><span class="o">-</span><span class="n">n_cull</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_extra_walk_per_task</span><span class="o">*</span><span class="n">size</span> <span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">n_cull</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">f_cull</span><span class="p">)</span><span class="o">*</span><span class="n">f_extra</span><span class="o">/</span><span class="p">(</span><span class="n">f_cull</span><span class="o">+</span><span class="n">f_extra</span><span class="o">-</span><span class="n">f_cull</span><span class="o">*</span><span class="n">f_extra</span><span class="p">)</span>

            <span class="n">n_walks</span> <span class="o">=</span> <span class="n">f_cull</span><span class="o">/</span><span class="p">(</span><span class="n">f_cull</span><span class="o">+</span><span class="n">f_extra</span><span class="o">-</span><span class="n">f_cull</span><span class="o">*</span><span class="n">f_extra</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">f</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">f</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;f_cull&quot;</span> <span class="p">,</span><span class="n">f_cull</span><span class="p">,</span><span class="s2">&quot;f_extra&quot;</span><span class="p">,</span> <span class="n">f_extra</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Calculated average n_walks at kill = &quot;</span><span class="p">,</span><span class="n">n_walks</span><span class="p">,</span> <span class="s2">&quot; from f_cull &quot;</span><span class="p">,</span><span class="n">f_cull</span><span class="p">,</span><span class="s2">&quot; f_extra (due to otherwise idle processors doing walks and explicitly requested extra walks) &quot;</span><span class="p">,</span><span class="n">f_extra</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_walks</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;WARNING: got average n_walks &lt; 1, but will always do at least 1 walk, so effective </span><span class="si">%s</span><span class="s2">_expected will be higher than requested&quot;</span> <span class="o">%</span> <span class="n">prop</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Setting </span><span class="si">%s</span><span class="s2"> = ceiling(</span><span class="si">%s</span><span class="s2">_expected/n_walks)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">prop</span><span class="p">))</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="n">prop</span><span class="o">+</span><span class="s1">&#39;_expected&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">n_walks</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;WARNING: using absolute number of &quot;</span><span class="o">+</span><span class="n">prop</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Final value of </span><span class="si">%s</span><span class="s2">=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="n">prop</span><span class="p">]))</span></div>


<div class="viewcode-block" id="additive_init_config">
<a class="viewcode-back" href="../ns_run.html#ns_run.additive_init_config">[docs]</a>
<span class="k">def</span> <span class="nf">additive_init_config</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">Emax</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">do_calc_lammps</span><span class="p">:</span>
        <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;python additive_init_config doesn&#39;t work with LAMMPS, since it varies list of atoms</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i_at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">)):</span>
        <span class="n">at_new</span> <span class="o">=</span> <span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i_at</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">do_calc_ASE</span> <span class="ow">or</span> <span class="n">do_calc_lammps</span><span class="p">:</span>
            <span class="n">at_new</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">calc</span>
        <span class="n">at_new</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i_at</span><span class="o">+</span><span class="mi">1</span><span class="p">,:])</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i_try</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">pos</span><span class="p">[</span><span class="n">i_at</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">at_new</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(),</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">))</span>
            <span class="n">at_new</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i_at</span><span class="o">+</span><span class="mi">1</span><span class="p">,:])</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span> <span class="c1"># zero the Z coordiates in a 2D simulation</span>
                 <span class="n">temp_at</span><span class="o">=</span><span class="n">at_new</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
                 <span class="n">temp_at</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                 <span class="n">at_new</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">temp_at</span><span class="p">)</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at_new</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">energy</span> <span class="o">&lt;</span> <span class="n">Emax</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Failed 10 times to insert atom </span><span class="si">%d</span><span class="s2"> with Emax </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i_at</span><span class="p">,</span> <span class="n">Emax</span><span class="p">),</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">energy</span></div>


<div class="viewcode-block" id="save_snapshot">
<a class="viewcode-back" href="../ns_run.html#ns_run.save_snapshot">[docs]</a>
<span class="k">def</span> <span class="nf">save_snapshot</span><span class="p">(</span><span class="n">snapshot_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the current walker configurations&#39; as a snapshot in the file ``out_file_prefix.iter.rank.config_file_format``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span> <span class="c1"># if parallel, ensure that we are always in sync, so snapshots are always a consistent set</span>

    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_per_parallel_task&#39;</span><span class="p">]:</span>
        <span class="n">rank_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rank</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rank_id</span> <span class="o">=</span> <span class="s2">&quot;ALL&quot;</span>

    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_per_parallel_task&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">snapshot_io</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;snapshot.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">snapshot_id</span><span class="p">,</span> <span class="n">rank_id</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">]),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">snapshot_io</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;snapshot.</span><span class="si">%d</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">snapshot_id</span><span class="p">,</span> <span class="n">rank_id</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">]),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="n">root_walkers_write_t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span>
            <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;iter&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">snapshot_id</span>
            <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">snapshot_io</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;root walkers write time &quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">root_walkers_write_t0</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_per_parallel_task&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># gather other walkers to do I/O on master task</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># I/O on master task</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
                    <span class="n">remote_walkers_recv_t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">remote_walkers</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;save_snapshot remote walkers recv time &quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">remote_walkers_recv_t0</span><span class="p">)</span>
                    <span class="n">remote_walkers_write_t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">remote_walkers</span><span class="p">:</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;iter&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">snapshot_id</span>
                        <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">snapshot_io</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;save_snapshot remote walkers write time &quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">remote_walkers_write_t0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># not master task</span>
                <span class="n">comm</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_per_parallel_task&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">snapshot_io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="clean_prev_snapshot">
<a class="viewcode-back" href="../ns_run.html#ns_run.clean_prev_snapshot">[docs]</a>
<span class="k">def</span> <span class="nf">clean_prev_snapshot</span><span class="p">(</span><span class="nb">iter</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_clean&#39;</span><span class="p">]:</span>
        <span class="n">snapshot_file</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;snapshot.</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">iter</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">snapshot_file</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;: WARNING: Failed to delete &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">snapshot_file</span><span class="p">)</span></div>



<div class="viewcode-block" id="do_ns_loop">
<a class="viewcode-back" href="../ns_run.html#ns_run.do_ns_loop">[docs]</a>
<span class="k">def</span> <span class="nf">do_ns_loop</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the main nested sampling loop, doing the iterations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">print_prefix</span>
    <span class="k">global</span> <span class="n">cur_config_ind</span>

    <span class="c1"># cant keep atoms fixed and change the simulation cell at the moment</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_volume_steps&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;cant keep atoms fixed and change the simulation cell</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>

    <span class="n">nD</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># dimensionality of the system</span>
    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>  <span class="c1"># simulate a 2D system only</span>
        <span class="n">nD</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">energy_io</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># tell returns the current stream position</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                <span class="n">nExtraDOF</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nExtraDOF</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_atoms</span><span class="o">-</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">nD</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nExtraDOF</span> <span class="o">=</span> <span class="n">n_atoms</span><span class="o">*</span><span class="n">nD</span>
            <span class="n">energy_io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">],</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_cull&#39;</span><span class="p">],</span> <span class="n">nExtraDOF</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_flat_V_prior&#39;</span><span class="p">],</span> <span class="n">n_atoms</span><span class="p">))</span>

    <span class="c1">## print(print_prefix, &quot;: random state &quot;, np.random.get_state())</span>
    <span class="c1">## if rank == 0:</span>
        <span class="c1">## print(print_prefix, &quot;: common random state &quot;, common_random_state)</span>

    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_walks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">:</span>
        <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;KEmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEmax</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_P&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: initial enthalpy &quot;</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">],</span> <span class="s2">&quot; PE &quot;</span><span class="p">,</span> <span class="n">eval_energy_PE</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="s2">&quot; KE &quot;</span><span class="p">,</span> <span class="n">eval_energy_KE</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="s2">&quot; PV &quot;</span><span class="p">,</span> <span class="n">eval_energy_PV</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="s2">&quot; mu &quot;</span><span class="p">,</span> <span class="n">eval_energy_mu</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="s2">&quot; vol &quot;</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">get_volume</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: initial enthalpy &quot;</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">],</span> <span class="s2">&quot; PE &quot;</span><span class="p">,</span> <span class="n">eval_energy_PE</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="s2">&quot; KE &quot;</span><span class="p">,</span> <span class="n">eval_energy_KE</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="s2">&quot; mu &quot;</span><span class="p">,</span> <span class="n">eval_energy_mu</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="s2">&quot; vol &quot;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">get_volume</span><span class="p">())</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="c1"># stats for purpose of adjusting step size</span>
    <span class="n">walk_stats_adjust</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># stats for purpose of monitoring acceptance rates</span>
    <span class="n">walk_stats_monitor</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">zero_stats</span><span class="p">(</span><span class="n">walk_stats_adjust</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">)</span>
    <span class="n">zero_stats</span><span class="p">(</span><span class="n">walk_stats_monitor</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">)</span>

    <span class="n">initial_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">prev_time</span> <span class="o">=</span> <span class="n">initial_time</span>
    <span class="n">step_size_setting_duration</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">total_step_size_setting_duration</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">Emax_of_step</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Emax_save</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i_ns_step_save</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">traj_walker_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">E_dump_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">E_dump_list_times</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># to avoid errors of unassigned values, if in case of a restart the final number of iter is the same as the starting, stop.</span>
    <span class="k">if</span> <span class="n">start_first_iter</span> <span class="o">==</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_iter&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Increase the n_iter_times_fraction_killed variable in the input if you want NS cycles to be performed.&quot;</span><span class="p">)</span>
        <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;starting iteration and the total number of required iterations are the same,hence no NS cycles will be performed</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>

    <span class="n">last_log_X_n</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">i_range_mod_n_cull</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_cull&#39;</span><span class="p">]))</span>
    <span class="n">i_range_plus_1_mod_n_cull</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_cull&#39;</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_cull&#39;</span><span class="p">])</span>
    <span class="n">log_X_n_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">i_range_mod_n_cull</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">i_range_mod_n_cull</span><span class="p">)</span>
    <span class="n">log_X_n_term_cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">log_X_n_term</span><span class="p">)</span>
    <span class="n">log_X_n_term_cumsum_modified</span> <span class="o">=</span> <span class="n">log_X_n_term_cumsum</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">i_range_plus_1_mod_n_cull</span><span class="p">)</span>
    <span class="n">log_X_n_term_sum</span> <span class="o">=</span> <span class="n">log_X_n_term_cumsum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;converge_down_to_T&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">converge_down_to_beta</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;kB&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;converge_down_to_T&#39;</span><span class="p">])</span>
        <span class="n">log_Z_term_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NINF</span>

    <span class="n">prev_snapshot_iter</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pprev_snapshot_iter</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">last_snapshot_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># for estimating current temperature from d log Omega / d E</span>
    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;T_estimate_finite_diff_lag&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_cull&#39;</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">Emax_history</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;T_estimate_finite_diff_lag&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">ns_analyzers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ns_analyzer</span><span class="p">,</span> <span class="n">ns_analyzer_interval</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ns_analyzers</span><span class="p">:</span>
            <span class="n">ns_analyzer</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;NS_loop start&quot;</span><span class="p">)</span>

    <span class="c1"># START MAIN LOOP</span>
    <span class="n">i_ns_step</span> <span class="o">=</span> <span class="n">start_first_iter</span>
    <span class="k">while</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_iter&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i_ns_step</span> <span class="o">&lt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_iter&#39;</span><span class="p">]:</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">5</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i_ns_step</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eval_energy</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                                             <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">]))</span>

        <span class="n">check_memory</span><span class="o">.</span><span class="n">check_memory</span><span class="p">(</span><span class="s2">&quot;start_ns_main_loop&quot;</span><span class="p">)</span>
        <span class="n">print_prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> NS </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;INFO: 10 config_ind &quot;</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind&#39;</span><span class="p">],</span> <span class="s2">&quot; from &quot;</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;from_config_ind&#39;</span><span class="p">],</span> <span class="s2">&quot; at &quot;</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind_time&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;adjust_step_interval&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">zero_stats</span><span class="p">(</span><span class="n">walk_stats_adjust</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;monitor_step_interval&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">zero_stats</span><span class="p">(</span><span class="n">walk_stats_monitor</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_TE START 00 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_PE START 01 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_KE</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_X START 02 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">at</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>

        <span class="c1"># get list of highest energy configs</span>
        <span class="p">(</span><span class="n">Emax</span><span class="p">,</span> <span class="n">Vmax</span><span class="p">,</span> <span class="n">cull_rank</span><span class="p">,</span> <span class="n">cull_ind</span><span class="p">)</span> <span class="o">=</span> <span class="n">max_energy</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="n">n_cull</span><span class="p">)</span>
        <span class="n">Emax_next</span> <span class="o">=</span> <span class="n">Emax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">Emax_of_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Emax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Emax_of_step</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;: WARNING: energy above Emax &quot;</span><span class="p">,</span> <span class="n">Emax_of_step</span><span class="p">,</span> <span class="s2">&quot; bad energies: &quot;</span><span class="p">,</span> <span class="n">Emax</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Emax</span> <span class="o">&gt;</span> <span class="n">Emax_of_step</span><span class="p">)],</span> <span class="n">cull_rank</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Emax</span> <span class="o">&gt;</span> <span class="n">Emax_of_step</span><span class="p">)],</span> <span class="n">cull_ind</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Emax</span> <span class="o">&gt;</span> <span class="n">Emax_of_step</span><span class="p">)])</span>
            <span class="c1"># comm.barrier()</span>
            <span class="c1"># exit_error(&quot;Energy above Emax\n&quot;, 5)</span>

        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i_ns_step</span> <span class="o">&gt;</span> <span class="n">start_first_iter</span> <span class="ow">and</span> <span class="n">Emax_next</span> <span class="o">&gt;=</span> <span class="n">Emax_of_step</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Emax not decreasing &quot;</span><span class="p">,</span> <span class="n">Emax_of_step</span><span class="p">,</span> <span class="n">Emax_next</span><span class="p">)</span>
        <span class="n">Emax_of_step</span> <span class="o">=</span> <span class="n">Emax_next</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;min_Emax&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Emax_of_step</span> <span class="o">&lt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;min_Emax&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># if the termination was set by a minimum energy, and it is reached, stop.</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Leaving loop because Emax=&quot;</span><span class="p">,</span> <span class="n">Emax_of_step</span><span class="p">,</span> <span class="s2">&quot; &lt; min_Emax =&quot;</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;min_Emax&#39;</span><span class="p">])</span>
            <span class="n">i_ns_step</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># add one so outside loop when one is subtracted to get real last iteration it&#39;s still correct</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">output_this_iter</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_time</span> <span class="o">&gt;</span> <span class="n">prev_time</span><span class="o">+</span><span class="mi">60</span> <span class="ow">or</span> <span class="n">i_ns_step</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i_ns_step</span> <span class="o">==</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_iter&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_iter&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_ns_step</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_iter&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_this_iter</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;converge_down_to_T&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># see ns_analyse.py calc_log_a() for math</span>
            <span class="n">log_a</span> <span class="o">=</span> <span class="n">log_X_n_term_sum</span><span class="o">*</span><span class="n">i_ns_step</span> <span class="o">+</span> <span class="n">log_X_n_term_cumsum_modified</span>
            <span class="c1"># DEBUG if rank == 0:</span>
                <span class="c1"># DEBUG for ii in range(len(log_a)):</span>
                    <span class="c1"># DEBUG print i_ns_step, &quot;log_a, beta, Es, beta*Es &quot;, log_a[ii], beta, Emax[ii], beta*Emax[ii]</span>
            <span class="n">log_Z_term_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">log_Z_term_max</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">log_a</span> <span class="o">-</span> <span class="n">converge_down_to_beta</span> <span class="o">*</span> <span class="n">Emax</span><span class="p">))</span>
            <span class="n">log_Z_term_last</span> <span class="o">=</span> <span class="n">log_a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">converge_down_to_beta</span><span class="o">*</span><span class="n">Emax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">output_this_iter</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;log_Z_term max &quot;</span><span class="p">,</span> <span class="n">log_Z_term_max</span><span class="p">,</span> <span class="s2">&quot;last &quot;</span><span class="p">,</span> <span class="n">log_Z_term_last</span><span class="p">,</span> <span class="s2">&quot;diff &quot;</span><span class="p">,</span> <span class="n">log_Z_term_max</span><span class="o">-</span><span class="n">log_Z_term_last</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">log_Z_term_last</span> <span class="o">&lt;</span> <span class="n">log_Z_term_max</span> <span class="o">-</span> <span class="mf">10.0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;Leaving loop because Z(</span><span class="si">%f</span><span class="s2">) is converged&quot;</span> <span class="o">%</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;converge_down_to_T&#39;</span><span class="p">])</span>
                <span class="n">i_ns_step</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># add one so outside loop when one is subtracted to get real last iteration it&#39;s still correct</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;T_estimate_finite_diff_lag&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Emax_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Emax_of_step</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_this_iter</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;T_estimate_finite_diff_lag&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Emax_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">beta_estimate</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Emax_history</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">log_alpha</span><span class="o">/</span><span class="p">(</span><span class="n">Emax_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Emax_history</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">T_estimate</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;kB&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">beta_estimate</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">T_estimate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i_ns_step</span><span class="p">,</span> <span class="s2">&quot;Emax_of_step &quot;</span><span class="p">,</span> <span class="n">Emax_of_step</span><span class="p">,</span> <span class="s2">&quot;T_estimate &quot;</span><span class="p">,</span> <span class="n">T_estimate</span><span class="p">,</span> <span class="s2">&quot; loop time &quot;</span><span class="p">,</span> <span class="n">cur_time</span><span class="o">-</span><span class="n">prev_time</span><span class="o">-</span><span class="n">step_size_setting_duration</span><span class="p">,</span> <span class="s2">&quot; time spent setting step sizes: &quot;</span><span class="p">,</span> <span class="n">step_size_setting_duration</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">prev_time</span> <span class="o">=</span> <span class="n">cur_time</span>
            <span class="n">step_size_setting_duration</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">entries_for_this_rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cull_rank</span> <span class="o">==</span> <span class="n">rank</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cull_list</span> <span class="o">=</span> <span class="n">cull_ind</span><span class="p">[</span><span class="n">entries_for_this_rank</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cull_ind</span><span class="p">[</span><span class="n">entries_for_this_rank</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;INFO: 20 cull &quot;</span><span class="p">,</span> <span class="n">cull_ind</span><span class="p">[</span><span class="n">entries_for_this_rank</span><span class="p">],</span> <span class="s2">&quot; on &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span>

        <span class="c1"># record Emax walkers energies</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Emax</span><span class="p">,</span> <span class="n">Vmax</span><span class="p">):</span>
                <span class="n">energy_io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%.60f</span><span class="s2"> </span><span class="si">%.60f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i_ns_step</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">V</span><span class="p">))</span>
            <span class="n">energy_io</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="c1">## Save the energies and corresponding iteration numbers in a list then print(them out only when printing a snapshot)</span>
            <span class="c1">#Emax_save.extend(Emax)</span>
            <span class="c1">#i_ns_step_save.extend(n_cull*[i_ns_step])</span>
            <span class="c1">## if it is time to print((i.e. at the same iteration when a snapshot is written, or at every iter if no snapshots - for smooth restarts))</span>
            <span class="c1">#if ns_args[&#39;snapshot_interval&#39;] &lt; 0 or i_ns_step % ns_args[&#39;snapshot_interval&#39;] == ns_args[&#39;snapshot_interval&#39;]-1:</span>
            <span class="c1">#    for istep,E in zip(i_ns_step_save,Emax_save):</span>
            <span class="c1">#        energy_io.write(&quot;%d %.60f\n&quot; % (istep, E))</span>
            <span class="c1">#    energy_io.flush()</span>
            <span class="c1">#    #empty the save lists, so they are ready for the next bunch of saved energies</span>
            <span class="c1">#    Emax_save[:]=[]</span>
            <span class="c1">#    i_ns_step_save[:]=[]</span>

        <span class="c1"># record Emax walkers configurations</span>
        <span class="k">if</span> <span class="n">cull_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">global_n_offset</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cull_list</span><span class="p">,</span> <span class="n">entries_for_this_rank</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;walker killed at age &quot;</span><span class="p">,</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_walks&#39;</span><span class="p">])</span>
                <span class="c1"># store culled config in list to be written (when</span>
                <span class="c1"># snapshot_interval has passed) every traj_interval steps</span>
                <span class="n">global_n</span> <span class="o">=</span> <span class="n">i_ns_step</span><span class="o">*</span><span class="n">n_cull</span> <span class="o">+</span> <span class="n">global_n_offset</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;traj_interval&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">global_n</span> <span class="o">%</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;traj_interval&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;traj_interval&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">walker_copy</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">walker_copy</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">walker_copy</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span>
                    <span class="n">walker_copy</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_P&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_P&#39;</span><span class="p">]</span>
                    <span class="n">walker_copy</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_ns_step</span>
                    <span class="n">walker_copy</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_n_global&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_n</span>
                    <span class="k">if</span> <span class="n">walker_copy</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s1">&#39;masses&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">walker_copy</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s1">&#39;momenta&#39;</span><span class="p">):</span>
                        <span class="n">walker_copy</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_KE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">walker_copy</span><span class="o">.</span><span class="n">get_kinetic_energy</span><span class="p">()</span>

                    <span class="n">traj_walker_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">walker_copy</span><span class="p">)</span>

                <span class="c1"># if tracking all configs, save this one that has been culled</span>
                <span class="k">if</span> <span class="n">track_traj_io</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">at</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;culled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">track_traj_io</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;E_dump_interval&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_ns_step</span> <span class="o">%</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;E_dump_interval&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># ns_args[&#39;E_dump_interval&#39;]-1:</span>
            <span class="k">if</span> <span class="n">walkers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s1">&#39;masses&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">walkers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s1">&#39;momenta&#39;</span><span class="p">):</span>
                <span class="n">E_dump_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">w</span><span class="o">.</span><span class="n">get_kinetic_energy</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">E_dump_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
            <span class="n">E_dump_list_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_ns_step</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;traj_interval&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">traj_walker_list</span><span class="p">:</span>
                <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">traj_io</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">])</span>
            <span class="n">traj_io</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">traj_walker_list</span><span class="o">=</span><span class="p">[]</span>

        <span class="c1"># print(the recorded Emax walkers configurations to output file)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_interval&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i_ns_step</span> <span class="o">%</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_interval&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_interval&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_seq_pairs&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i_ns_step</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_ns_step</span><span class="o">%</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_interval&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
            <span class="c1">##NB if ns_args[&#39;traj_interval&#39;] &gt; 0:</span>
                <span class="c1">##NB for at in traj_walker_list:</span>
                    <span class="c1">##NB ase.io.write(traj_io, at, parallel=False, format=ns_args[&#39;config_file_format&#39;])</span>
                <span class="c1">##NB traj_io.flush()</span>
                <span class="c1">##NB traj_walker_list=[]</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;E_dump_interval&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">E_dump_list_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">allgather</span><span class="p">(</span><span class="n">E_dump_list</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">E_dump_list_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">E_dump_list</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">E_dump_list_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">E_dump_io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;step </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">E_dump_list_times</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_dump_list_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">E_dump_io</span><span class="p">,</span> <span class="n">E_dump_list_all</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">E_dump_io</span><span class="p">,</span> <span class="n">E_dump_list_all</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
                    <span class="n">E_dump_io</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">E_dump_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">E_dump_list_all</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">E_dump_list_times</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># calculate how many will be culled on each rank</span>
        <span class="n">n_cull_of_rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">sum</span><span class="p">(</span><span class="n">cull_rank</span> <span class="o">==</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)])</span>

        <span class="c1"># label configs to be culled</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">n_walkers</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">object_</span><span class="p">)</span>
        <span class="n">status</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="n">status</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">cull_ind</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cull_rank</span> <span class="o">==</span> <span class="n">r</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]]</span> <span class="o">=</span> <span class="s1">&#39;c_t&#39;</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">initial_PE_loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_KE</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">]</span>
            <span class="n">initial_E_loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">initial_PE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">allgather</span><span class="p">(</span><span class="n">initial_PE_loc</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">initial_E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">allgather</span><span class="p">(</span><span class="n">initial_E_loc</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">initial_PE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">initial_PE_loc</span><span class="p">)</span>
                <span class="n">initial_E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">initial_E_loc</span><span class="p">)</span>
            <span class="n">initial_changed</span> <span class="o">=</span> <span class="n">initial_PE</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;c_t&#39;</span><span class="p">)]</span>
            <span class="n">initial_unchanged</span> <span class="o">=</span> <span class="n">initial_PE</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;: initial status &quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span>
                      <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">status</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="p">:]])</span>

        <span class="c1"># find load balance by cloning on top of excess maxima</span>
        <span class="n">recv_ind</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">recv_rank</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">send_ind</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">send_rank</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cull_inds_to_remove</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">n_cull</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># send/recv for fixing load balance</span>
            <span class="c1"># CHECK FOR RANDOMNESS ISSUES AND WHICH NODES ARE USED FOR CLONES</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                <span class="c1"># maybe remote_r should be chosen completely randomly, rather</span>
                <span class="c1"># than close to task of extra culled configs</span>
                <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">)),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">)))))</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">n_cull_of_rank</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_n_cull_per_task</span><span class="p">:</span> <span class="c1"># not too many that need to be culled on this rank</span>
                        <span class="k">break</span>
                    <span class="c1"># this rank has too many to cull, must receive replacement from another node</span>
                    <span class="n">remote_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">dr</span><span class="p">)</span> <span class="o">%</span> <span class="n">size</span>
                    <span class="k">if</span> <span class="n">n_cull_of_rank</span><span class="p">[</span><span class="n">remote_r</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_n_cull_per_task</span><span class="p">:</span> <span class="c1"># send from r+dr to r</span>
                        <span class="n">n_transfer</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_cull_of_rank</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">-</span><span class="n">max_n_cull_per_task</span><span class="p">,</span> <span class="n">max_n_cull_per_task</span><span class="o">-</span><span class="n">n_cull_of_rank</span><span class="p">[</span><span class="n">remote_r</span><span class="p">])</span>
                        <span class="n">recv_rank</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">r</span><span class="p">]</span><span class="o">*</span><span class="n">n_transfer</span><span class="p">)</span>
                        <span class="n">send_rank</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">remote_r</span><span class="p">]</span><span class="o">*</span><span class="n">n_transfer</span><span class="p">)</span>
                        <span class="n">local_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;c_t&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">n_transfer</span><span class="p">]</span>
                        <span class="n">recv_ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">local_ind</span><span class="p">)</span>
                        <span class="n">remote_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="n">remote_r</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">n_transfer</span><span class="p">]</span>
                        <span class="n">send_ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">remote_ind</span><span class="p">)</span>
                        <span class="n">status</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">local_ind</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;c_s&#39;</span>
                        <span class="n">status</span><span class="p">[</span><span class="n">remote_r</span><span class="p">,</span> <span class="n">remote_ind</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;c_t_a&#39;</span>
                        <span class="n">n_cull_of_rank</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">-=</span> <span class="n">n_transfer</span>
                        <span class="n">n_cull_of_rank</span><span class="p">[</span><span class="n">remote_r</span><span class="p">]</span> <span class="o">+=</span> <span class="n">n_transfer</span>

        <span class="c1"># save local random state, and switch to common one</span>
        <span class="n">rng</span><span class="o">.</span><span class="n">switch_to_common</span><span class="p">()</span>

        <span class="c1"># select clones</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="n">list_clone_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;c_t&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># assign clones</span>
            <span class="n">n_remaining_clones</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_clone_target</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">n_remaining_clones</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">remote_r</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                <span class="n">n_avail_remote</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="n">remote_r</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_avail_remote</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># something is available on remote_r</span>
                    <span class="c1"># send from random avail walker on remote_r to clone_target on r</span>
                    <span class="n">n_transfer</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_remaining_clones</span><span class="p">,</span> <span class="n">n_avail_remote</span><span class="p">)</span>

                    <span class="c1"># set ranks</span>
                    <span class="n">send_rank</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">remote_r</span><span class="p">]</span><span class="o">*</span><span class="n">n_transfer</span><span class="p">)</span>
                    <span class="n">recv_rank</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">r</span><span class="p">]</span><span class="o">*</span><span class="n">n_transfer</span><span class="p">)</span>

                    <span class="c1"># set indices</span>
                    <span class="n">r_is</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_transfer</span><span class="p">):</span>
                        <span class="n">r_i</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_walkers</span><span class="p">)</span>
                        <span class="k">while</span> <span class="n">status</span><span class="p">[</span><span class="n">remote_r</span><span class="p">,</span> <span class="n">r_i</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">r_i</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_walkers</span><span class="p">)</span>
                        <span class="c1"># now r_i should be something with status &#39;&#39;</span>
                        <span class="n">status</span><span class="p">[</span><span class="n">remote_r</span><span class="p">,</span> <span class="n">r_i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;c_s&#39;</span>
                        <span class="n">r_is</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_i</span><span class="p">)</span>
                    <span class="n">send_ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">r_is</span><span class="p">)</span>

                    <span class="n">status</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">list_clone_target</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n_transfer</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;c_t_a&#39;</span>
                    <span class="n">recv_ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">list_clone_target</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n_transfer</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">n_transfer</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_clone_target</span><span class="p">):</span>
                        <span class="n">list_clone_target</span> <span class="o">=</span> <span class="n">list_clone_target</span><span class="p">[</span><span class="n">n_transfer</span><span class="p">:]</span>
                    <span class="n">n_remaining_clones</span> <span class="o">-=</span> <span class="n">n_transfer</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_TE POST_LOC_CLONE 15 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_PE POST_LOC_CLONE 16 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_KE</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_X POST_LOC_CLONE 17 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">at</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>

        <span class="c1"># make into numpy arrays so that mathematical operations will work</span>
        <span class="n">send_rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">send_rank</span><span class="p">)</span>
        <span class="n">send_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">send_ind</span><span class="p">)</span>
        <span class="n">recv_rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">recv_rank</span><span class="p">)</span>
        <span class="n">recv_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">recv_ind</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">send_rank</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;send from &quot;</span><span class="p">,</span> <span class="n">send_rank</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">send_ind</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                          <span class="s2">&quot; to &quot;</span><span class="p">,</span> <span class="n">recv_rank</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">recv_ind</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># save new common state, and restore to local state</span>
        <span class="n">rng</span><span class="o">.</span><span class="n">switch_to_local</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">n_cull</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">send_rank</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">recv_rank</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">send_rank</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">rank</span><span class="p">:</span>  <span class="c1"># local copy</span>
                <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_positions</span><span class="p">())</span>
                <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_cell</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_velocities</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_GMC&#39;</span><span class="p">]:</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">][:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;swap_atomic_numbers&#39;</span><span class="p">]:</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_atomic_numbers</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                        <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_masses</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_masses</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]:</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind&#39;</span><span class="p">]</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;from_config_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;from_config_ind&#39;</span><span class="p">]</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind_time&#39;</span><span class="p">]</span>
                <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_walks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># need send/recv</span>
                <span class="n">n_send</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">n_atoms</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                    <span class="n">n_send</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
                <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_GMC&#39;</span><span class="p">]:</span>
                    <span class="n">n_send</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">n_send</span> <span class="o">+=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">n_atoms</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;swap_atomic_numbers&#39;</span><span class="p">]:</span>
                    <span class="n">n_send</span> <span class="o">+=</span> <span class="n">n_atoms</span>  <span class="c1"># Z</span>
                    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                        <span class="n">n_send</span> <span class="o">+=</span> <span class="n">n_atoms</span>  <span class="c1"># mass</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]:</span>
                    <span class="n">n_send</span> <span class="o">+=</span> <span class="mi">3</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_send</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">send_rank</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">rank</span><span class="p">:</span>  <span class="c1"># only one config is sent/received</span>
                    <span class="n">buf_o</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">:</span><span class="n">buf_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">));</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
                    <span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">:</span><span class="n">buf_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">));</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="mi">3</span>
                    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                        <span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">:</span><span class="n">buf_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_velocities</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">));</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
                    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_GMC&#39;</span><span class="p">]:</span>
                        <span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">:</span><span class="n">buf_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">));</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
                    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">:</span><span class="n">buf_o</span><span class="o">+</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">));</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">n_atoms</span>
                    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;swap_atomic_numbers&#39;</span><span class="p">]:</span>
                        <span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">:</span><span class="n">buf_o</span><span class="o">+</span><span class="n">n_atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">();</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="n">n_atoms</span>
                        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                            <span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">:</span><span class="n">buf_o</span><span class="o">+</span><span class="n">n_atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_masses</span><span class="p">();</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="n">n_atoms</span>
                    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]:</span>
                        <span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind&#39;</span><span class="p">];</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;from_config_ind&#39;</span><span class="p">];</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">send_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind_time&#39;</span><span class="p">];</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">comm</span><span class="o">.</span><span class="n">Send</span><span class="p">([</span><span class="n">buf</span><span class="p">,</span>  <span class="n">MPI</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="n">recv_rank</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">recv_rank</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">rank</span><span class="p">:</span>
                    <span class="n">comm</span><span class="o">.</span><span class="n">Recv</span><span class="p">([</span><span class="n">buf</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">],</span> <span class="n">source</span><span class="o">=</span><span class="n">send_rank</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
                    <span class="n">buf_o</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">:</span><span class="n">buf_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)));</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">:</span><span class="n">buf_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)));</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="mi">3</span>
                    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                        <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">:</span><span class="n">buf_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)));</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
                    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_GMC&#39;</span><span class="p">]:</span>
                        <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">][:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">:</span><span class="n">buf_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
                    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">:</span><span class="n">buf_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">);</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">n_atoms</span>
                    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;swap_atomic_numbers&#39;</span><span class="p">]:</span>
                        <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_atomic_numbers</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">:</span><span class="n">buf_o</span><span class="o">+</span><span class="n">n_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">));</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="n">n_atoms</span>
                        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                            <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_masses</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">:</span><span class="n">buf_o</span><span class="o">+</span><span class="n">n_atoms</span><span class="p">]);</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="n">n_atoms</span>
                    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]:</span>
                        <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">]);</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;from_config_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">]);</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">buf_o</span><span class="p">]);</span> <span class="n">buf_o</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="n">recv_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># complicated construction of sending/receiving buffers</span>
            <span class="c1"># figure out how much is sent per config</span>
            <span class="n">n_data_per_config</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">n_atoms</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                <span class="n">n_data_per_config</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_GMC&#39;</span><span class="p">]:</span>
                <span class="n">n_data_per_config</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">n_data_per_config</span> <span class="o">+=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">n_atoms</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;swap_atomic_numbers&#39;</span><span class="p">]:</span>
                <span class="n">n_send</span> <span class="o">+=</span> <span class="n">n_atoms</span> <span class="c1"># Z</span>
                <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                    <span class="n">n_send</span> <span class="o">+=</span> <span class="n">n_atoms</span> <span class="c1"># mass</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]:</span>
                <span class="n">n_data_per_config</span> <span class="o">+=</span> <span class="mi">3</span>

            <span class="c1"># figure out send counts</span>
            <span class="n">send_count</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">size</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">send_rank</span> <span class="o">==</span> <span class="n">rank</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">r_recv</span> <span class="o">=</span> <span class="n">recv_rank</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">send_count</span><span class="p">[</span><span class="n">r_recv</span><span class="p">]</span> <span class="o">+=</span> <span class="n">n_data_per_config</span>

            <span class="c1"># figure out send displacements</span>
            <span class="n">send_displ</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">size</span>
            <span class="n">send_displ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
                <span class="n">send_displ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">send_displ</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">send_count</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># create empty buffer for sending</span>
            <span class="n">send_count_tot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">send_count</span><span class="p">)</span>
            <span class="n">send_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">send_count_tot</span><span class="p">)</span>

            <span class="c1"># copy data to be sent to buffer</span>
            <span class="n">send_displ_t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">send_displ</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">send_rank</span> <span class="o">==</span> <span class="n">rank</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">r_recv</span> <span class="o">=</span> <span class="n">recv_rank</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i_send</span> <span class="o">=</span> <span class="n">send_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">data_o</span> <span class="o">=</span> <span class="n">send_displ_t</span><span class="p">[</span><span class="n">r_recv</span><span class="p">]</span>
                <span class="n">send_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_send</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">];</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">send_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">:</span><span class="n">data_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_send</span><span class="p">]</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">)</span> <span class="p">);</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
                <span class="n">send_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">:</span><span class="n">data_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_send</span><span class="p">]</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span> <span class="p">);</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="mi">3</span>
                <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                    <span class="n">send_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">:</span><span class="n">data_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_send</span><span class="p">]</span><span class="o">.</span><span class="n">get_velocities</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">)</span> <span class="p">);</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
                <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_GMC&#39;</span><span class="p">]:</span>
                    <span class="n">send_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">:</span><span class="n">data_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_send</span><span class="p">]</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">)</span> <span class="p">);</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">send_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">:</span><span class="n">data_o</span><span class="o">+</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_send</span><span class="p">]</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">)</span> <span class="p">);</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">n_atoms</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;swap_atomic_numbers&#39;</span><span class="p">]:</span>
                    <span class="n">send_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">:</span><span class="n">data_o</span><span class="o">+</span><span class="n">n_atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_send</span><span class="p">]</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">();</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="n">n_atoms</span>
                    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                        <span class="n">send_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">:</span><span class="n">data_o</span><span class="o">+</span><span class="n">n_atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_send</span><span class="p">]</span><span class="o">.</span><span class="n">get_masses</span><span class="p">();</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="n">n_atoms</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]:</span>
                    <span class="n">send_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_send</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind&#39;</span><span class="p">];</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">send_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_send</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;from_config_ind&#39;</span><span class="p">];</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">send_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_send</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind_time&#39;</span><span class="p">];</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">send_displ_t</span><span class="p">[</span><span class="n">r_recv</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_o</span>

            <span class="c1"># figure out recv counts</span>
            <span class="n">recv_count</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">size</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">recv_rank</span> <span class="o">==</span> <span class="n">rank</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">r_send</span> <span class="o">=</span> <span class="n">send_rank</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">recv_count</span><span class="p">[</span><span class="n">r_send</span><span class="p">]</span> <span class="o">+=</span> <span class="n">n_data_per_config</span>

            <span class="c1"># figure out recv displacements</span>
            <span class="n">recv_displ</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">size</span>
            <span class="n">recv_displ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
                <span class="n">recv_displ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">recv_displ</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">recv_count</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># create empty buffer for receiving</span>
            <span class="n">recv_count_tot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">recv_count</span><span class="p">)</span>
            <span class="n">recv_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">recv_count_tot</span><span class="p">)</span>

            <span class="c1"># do communications</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">send_buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">send_data</span><span class="p">,</span> <span class="n">send_count</span><span class="p">,</span> <span class="n">send_displ</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">]</span>
                <span class="n">recv_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">recv_data</span><span class="p">,</span> <span class="n">recv_count</span><span class="p">,</span> <span class="n">recv_displ</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">)</span>
                <span class="n">comm</span><span class="o">.</span><span class="n">Alltoallv</span><span class="p">(</span><span class="n">send_buf</span><span class="p">,</span> <span class="n">recv_buf</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">recv_data</span> <span class="o">=</span> <span class="n">send_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># copy data from recv buffer to walkers</span>
            <span class="n">recv_displ_t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">recv_displ</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">recv_rank</span> <span class="o">==</span> <span class="n">rank</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">r_send</span> <span class="o">=</span> <span class="n">send_rank</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i_recv</span> <span class="o">=</span> <span class="n">recv_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">data_o</span> <span class="o">=</span> <span class="n">recv_displ_t</span><span class="p">[</span><span class="n">r_send</span><span class="p">]</span>
                <span class="n">walkers</span><span class="p">[</span><span class="n">i_recv</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recv_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">];</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">walkers</span><span class="p">[</span><span class="n">i_recv</span><span class="p">]</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span> <span class="n">recv_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">:</span><span class="n">data_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">(</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">));</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
                <span class="n">walkers</span><span class="p">[</span><span class="n">i_recv</span><span class="p">]</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span> <span class="n">recv_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">:</span><span class="n">data_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">));</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="mi">3</span>
                <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">i_recv</span><span class="p">]</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span> <span class="n">recv_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">:</span><span class="n">data_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">(</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">));</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
                <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_GMC&#39;</span><span class="p">]:</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">i_recv</span><span class="p">]</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">][:,:]</span> <span class="o">=</span> <span class="n">recv_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">:</span><span class="n">data_o</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">(</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">);</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">n_atoms</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">i_recv</span><span class="p">]</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">recv_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">:</span><span class="n">data_o</span><span class="o">+</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">n_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_recv</span><span class="p">]</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="p">);</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">n_atoms</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;swap_atomic_numbers&#39;</span><span class="p">]:</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">i_recv</span><span class="p">]</span><span class="o">.</span><span class="n">set_atomic_numbers</span><span class="p">(</span><span class="n">recv_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">:</span><span class="n">data_o</span><span class="o">+</span><span class="n">n_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">));</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="n">n_atoms</span>
                    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                        <span class="n">walkers</span><span class="p">[</span><span class="n">i_recv</span><span class="p">]</span><span class="o">.</span><span class="n">set_masses</span><span class="p">(</span><span class="n">recv_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">:</span><span class="n">data_o</span><span class="o">+</span><span class="n">n_atoms</span><span class="p">]);</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="n">n_masses</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]:</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">i_recv</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">recv_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">]);</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">i_recv</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;from_config_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">recv_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">]);</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">i_recv</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">recv_data</span><span class="p">[</span><span class="n">data_o</span><span class="p">]);</span> <span class="n">data_o</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">recv_displ_t</span><span class="p">[</span><span class="n">r_send</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_o</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_TE POST_CLONE 20 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_PE POST_CLONE 21 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_KE</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_X POST_CLONE 22 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">at</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]:</span>
            <span class="c1"># loop over _all_ clone targets and increment cur_config_ind,</span>
            <span class="c1"># setting appropriate configs&#39; new config_ind as needed</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                <span class="n">clone_walk_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;c_t_a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i_at</span> <span class="ow">in</span> <span class="n">clone_walk_ind</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">rank</span><span class="p">:</span>
                        <span class="n">walkers</span><span class="p">[</span><span class="n">i_at</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;from_config_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_at</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind&#39;</span><span class="p">]</span>
                        <span class="n">walkers</span><span class="p">[</span><span class="n">i_at</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_config_ind</span>
                        <span class="n">walkers</span><span class="p">[</span><span class="n">i_at</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_ns_step</span>
                    <span class="n">cur_config_ind</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># move cloned walkers</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">i_ns_step</span> <span class="o">==</span> <span class="n">start_first_iter</span> <span class="ow">and</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;full_auto_step_sizes&#39;</span><span class="p">]):</span>
            <span class="c1"># set initial step sizes. Performed here since this is the first time all the arrays are in place</span>
            <span class="n">conf_pre</span><span class="o">=</span><span class="n">walkers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">conf_pre</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">calc</span>
            <span class="n">move_args_pre</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">movement_args</span><span class="p">)</span>
            <span class="n">walk_stats_pre</span><span class="o">=</span><span class="n">walk_single_walker</span><span class="p">(</span><span class="n">conf_pre</span><span class="p">,</span> <span class="n">move_args_pre</span><span class="p">,</span> <span class="n">Emax_of_step</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">)</span>
            <span class="n">delta_step_size_setting_duration</span> <span class="o">=</span> <span class="n">full_auto_set_stepsizes</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="n">walk_stats_pre</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">Emax_of_step</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="n">total_step_size_setting_duration</span> <span class="o">+=</span> <span class="n">delta_step_size_setting_duration</span>
            <span class="n">step_size_setting_duration</span> <span class="o">+=</span> <span class="n">delta_step_size_setting_duration</span>
            <span class="k">del</span><span class="p">(</span><span class="n">walk_stats_pre</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">move_args_pre</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">conf_pre</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="c1"># walk clone targets</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="n">rank</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;c_s&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;INFO: 30 clone source &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">clone_walk_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="n">rank</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;c_t_a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i_at</span> <span class="ow">in</span> <span class="n">clone_walk_ind</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;INFO: 40 WALK clone_target &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">i_at</span><span class="p">)</span>
            <span class="n">walk_stats</span> <span class="o">=</span> <span class="n">walk_single_walker</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="n">i_at</span><span class="p">],</span> <span class="n">movement_args</span><span class="p">,</span>
                                            <span class="n">Emax_of_step</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">)</span>
            <span class="n">walkers</span><span class="p">[</span><span class="n">i_at</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;last_walked_iter_clone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_ns_step</span>
            <span class="c1"># if tracking all configs, save this one that has been walked</span>
            <span class="k">if</span> <span class="n">track_traj_io</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">walkers</span><span class="p">[</span><span class="n">i_at</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_ns_step</span>
                <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">track_traj_io</span><span class="p">,</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_at</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">])</span>
            <span class="c1">#print(&quot;WALK on rank &quot;, rank, &quot;at iteration &quot;, i_ns_step, &quot; walker &quot;, i_at )</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">walkers</span><span class="p">[</span><span class="n">i_at</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_walks&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">]</span>
            <span class="n">accumulate_stats</span><span class="p">(</span><span class="n">walk_stats_adjust</span><span class="p">,</span> <span class="n">walk_stats</span><span class="p">)</span>
            <span class="n">accumulate_stats</span><span class="p">(</span><span class="n">walk_stats_monitor</span><span class="p">,</span> <span class="n">walk_stats</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_TE POST_CLONE_WALK 25 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_PE POST_CLONE_WALK 26 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_KE</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_X POST_CLONE_WALK 27 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">at</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>

        <span class="c1"># check that everything that should have been changed has, and things</span>
        <span class="c1"># that shouldn&#39;t have, haven&#39;t</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">final_PE_loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_KE</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">]</span>
            <span class="n">final_E_loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">final_PE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">allgather</span><span class="p">(</span><span class="n">final_PE_loc</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">final_E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">allgather</span><span class="p">(</span><span class="n">final_E_loc</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">final_PE</span> <span class="o">=</span> <span class="n">final_PE_loc</span>
                <span class="n">final_E</span> <span class="o">=</span> <span class="n">final_E_loc</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">final_status</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">initial_unchanged</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_PE</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;initial_PE &quot;</span><span class="p">,</span> <span class="n">initial_PE</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;final_PE &quot;</span><span class="p">,</span> <span class="n">final_PE</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;initial_E &quot;</span><span class="p">,</span> <span class="n">initial_E</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;final_E &quot;</span><span class="p">,</span> <span class="n">final_E</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;final_status &quot;</span><span class="p">,</span> <span class="n">final_status</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: energy that should have been unchanged &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span><span class="s2">&quot; missing from final energies&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">initial_changed</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">final_PE</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;initial_PE &quot;</span><span class="p">,</span> <span class="n">initial_PE</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;final_PE &quot;</span><span class="p">,</span> <span class="n">final_PE</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;initial_E &quot;</span><span class="p">,</span> <span class="n">initial_E</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;final_E &quot;</span><span class="p">,</span> <span class="n">final_E</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;final_status &quot;</span><span class="p">,</span> <span class="n">final_status</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: energy that should have been changed &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span><span class="s2">&quot; still there in final energies&quot;</span><span class="p">)</span>

        <span class="c1"># walk extras</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;no_extra_walks_at_all&#39;</span><span class="p">]:</span>
                <span class="n">r_i</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_walkers</span><span class="p">)</span>
                <span class="c1"># WARNING: this may select walkers for extra walks multiple</span>
                <span class="c1"># times, yet never re-walk ones that were walked as clone</span>
                <span class="c1"># targets</span>
                <span class="k">while</span> <span class="n">status</span><span class="p">[</span><span class="n">rank</span><span class="p">,</span> <span class="n">r_i</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">status</span><span class="p">[</span><span class="n">rank</span><span class="p">,</span> <span class="n">r_i</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;c_s&#39;</span><span class="p">:</span>
                    <span class="n">r_i</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_walkers</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;INFO: 50 WALK extra &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">r_i</span><span class="p">)</span>
                <span class="n">walk_stats</span> <span class="o">=</span> <span class="n">walk_single_walker</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="n">r_i</span><span class="p">],</span> <span class="n">movement_args</span><span class="p">,</span>
                                                <span class="n">Emax_of_step</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">)</span>
                <span class="n">walkers</span><span class="p">[</span><span class="n">r_i</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;last_walked_iter_extra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_ns_step</span>
                <span class="c1"># if tracking all configs, save this one that has been walked</span>
                <span class="k">if</span> <span class="n">track_traj_io</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">i_at</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_ns_step</span>
                    <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">track_traj_io</span><span class="p">,</span> <span class="n">walkers</span><span class="p">[</span><span class="n">i_at</span><span class="p">],</span>
                                 <span class="nb">format</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">])</span>
                <span class="c1"># print(&quot;WALK EXTRA on rank &quot;, rank, &quot;at iteration &quot;, i_ns_step,</span>
                <span class="c1"># &quot; walker &quot;, r_i)</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1">#walkers[r_i].info[&#39;n_walks&#39;] += movement_args[&#39;n_steps&#39;] # LIVIA-this gives error, does not exist</span>
                    <span class="n">walkers</span><span class="p">[</span><span class="n">r_i</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_walks&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len&#39;</span><span class="p">]</span>
                <span class="n">accumulate_stats</span><span class="p">(</span><span class="n">walk_stats_adjust</span><span class="p">,</span> <span class="n">walk_stats</span><span class="p">)</span>
                <span class="n">accumulate_stats</span><span class="p">(</span><span class="n">walk_stats_monitor</span><span class="p">,</span> <span class="n">walk_stats</span><span class="p">)</span>

        <span class="n">monitored_this_step</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;monitor_step_interval&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_ns_step</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;monitor_step_interval&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">abs</span><span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;monitor_step_interval&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">adjust_step_sizes</span><span class="p">(</span><span class="n">walk_stats_monitor</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">monitor_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">zero_stats</span><span class="p">(</span><span class="n">walk_stats_monitor</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">)</span>
            <span class="n">monitored_this_step</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;adjust_step_interval&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_ns_step</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;adjust_step_interval&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">abs</span><span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;adjust_step_interval&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>

            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;full_auto_step_sizes&#39;</span><span class="p">]):</span>
                <span class="n">adjust_step_sizes</span><span class="p">(</span><span class="n">walk_stats_adjust</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">do_print_rate</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">monitored_this_step</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delta_step_size_setting_duration</span> <span class="o">=</span> <span class="n">full_auto_set_stepsizes</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="n">walk_stats_adjust</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">Emax_of_step</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                <span class="n">total_step_size_setting_duration</span> <span class="o">+=</span> <span class="n">delta_step_size_setting_duration</span>
                <span class="n">step_size_setting_duration</span> <span class="o">+=</span> <span class="n">delta_step_size_setting_duration</span>
            <span class="n">zero_stats</span><span class="p">(</span><span class="n">walk_stats_adjust</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_TE END 30 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_PE END 31 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">do_KE</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%30s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;: LOOP_X END 32 &quot;</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">at</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">print_prefix</span><span class="p">,</span> <span class="s2">&quot;: final status &quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">status</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="p">:]])</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_interval&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_ns_step</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_ns_step</span> <span class="o">%</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_interval&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span>
                            <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_seq_pairs&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i_ns_step</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">i_ns_step</span><span class="o">%</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_interval&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span>
                            <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_time&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">last_snapshot_time</span> <span class="o">&gt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_time&#39;</span><span class="p">])):</span>
            <span class="n">do_snapshot</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_snapshot</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">do_snapshot</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">do_snapshot</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_snapshot</span><span class="p">:</span>
            <span class="n">save_snapshot</span><span class="p">(</span><span class="n">i_ns_step</span><span class="p">)</span>
            <span class="n">last_snapshot_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">clean_prev_snapshot</span><span class="p">(</span><span class="n">pprev_snapshot_iter</span><span class="p">)</span>
            <span class="n">pprev_snapshot_iter</span> <span class="o">=</span> <span class="n">prev_snapshot_iter</span>
            <span class="n">prev_snapshot_iter</span> <span class="o">=</span> <span class="n">i_ns_step</span>

        <span class="k">if</span> <span class="n">ns_analyzers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ns_analyzer</span><span class="p">,</span> <span class="n">ns_analyzer_interval</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ns_analyzers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ns_analyzer_interval</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i_ns_step</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">ns_analyzer_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ns_analyzer</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="n">i_ns_step</span><span class="p">,</span> <span class="s2">&quot;NS_loop </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i_ns_step</span><span class="p">)</span>
        <span class="n">i_ns_step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1">### END OF MAIN LOOP</span>

    <span class="c1"># flush remaining traj configs</span>
    <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">traj_walker_list</span><span class="p">:</span>
        <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">traj_io</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">])</span>
    <span class="n">traj_io</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">traj_walker_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;E_dump_interval&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">E_dump_list_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">allgather</span><span class="p">(</span><span class="n">E_dump_list</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">E_dump_list_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">E_dump_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">E_dump_list_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">E_dump_io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;step </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">E_dump_list_times</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_dump_list_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">E_dump_io</span><span class="p">,</span> <span class="n">E_dump_list_all</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">E_dump_io</span><span class="p">,</span> <span class="n">E_dump_list_all</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
            <span class="n">E_dump_io</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;LOOP TIME total &quot;</span><span class="p">,</span><span class="n">cur_time</span><span class="o">-</span><span class="n">initial_time</span><span class="o">-</span><span class="n">total_step_size_setting_duration</span><span class="p">,</span> <span class="s2">&quot; per iter &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cur_time</span><span class="o">-</span><span class="n">initial_time</span><span class="o">-</span><span class="n">total_step_size_setting_duration</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">i_ns_step</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;TIME SPENT SETTING STEP SIZES total &quot;</span><span class="p">,</span><span class="n">total_step_size_setting_duration</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">i_ns_step</span><span class="o">-</span><span class="mi">1</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../ns_run.html#ns_run.main">[docs]</a>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Main function &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">movement_args</span>
        <span class="k">global</span> <span class="n">ns_args</span><span class="p">,</span> <span class="n">start_first_iter</span>
        <span class="k">global</span> <span class="n">max_n_cull_per_task</span>
        <span class="k">global</span> <span class="n">size</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">ns_analyzers</span>
        <span class="k">global</span> <span class="n">n_cull</span><span class="p">,</span> <span class="n">n_walkers</span><span class="p">,</span> <span class="n">n_walkers_per_task</span>
        <span class="k">global</span> <span class="n">n_extra_walk_per_task</span>
        <span class="k">global</span> <span class="n">do_calc_ASE</span><span class="p">,</span> <span class="n">do_calc_lammps</span><span class="p">,</span> <span class="n">do_calc_internal</span><span class="p">,</span> <span class="n">do_calc_fortran</span>
        <span class="k">global</span> <span class="n">energy_io</span><span class="p">,</span> <span class="n">traj_io</span><span class="p">,</span> <span class="n">walkers</span>
        <span class="k">global</span> <span class="n">n_atoms</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">,</span> <span class="n">pot</span>
        <span class="k">global</span> <span class="n">MPI</span><span class="p">,</span> <span class="n">f_MC_MD</span>
        <span class="k">global</span> <span class="n">track_traj_io</span><span class="p">,</span> <span class="n">cur_config_ind</span>
        <span class="k">global</span> <span class="n">E_dump_io</span>
        <span class="k">global</span> <span class="n">print_prefix</span>
        <span class="k">global</span> <span class="n">Z_list</span>

        <span class="kn">import</span> <span class="nn">sys</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">excepthook_mpi_abort</span>

        <span class="n">stacktrace</span><span class="o">.</span><span class="n">listen</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">usage</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">use_mpi</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-no_mpi&quot;</span><span class="p">:</span>
                <span class="n">use_mpi</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">usage</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># initialize mpi</span>
        <span class="n">comm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">calculator_comm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">use_mpi</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;INFO: use_mpi true, importing mpi4py module&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Failed to import mpi4py</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
            <span class="n">calculator_comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_SELF</span>

        <span class="k">if</span> <span class="n">use_mpi</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>  <span class="c1"># id of process</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>  <span class="c1"># number of processes</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Failed to get rank or size</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;comm &quot;</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="s2">&quot; size &quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s2">&quot; rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span>

        <span class="c1"># read inputs on root, then bcast</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;ns_inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Failed to read ns_inputs file</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;\s*(#.*)?$&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;\s*(\S+)\s*=\s*(.*\S)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">matches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Failed to parse line &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">args</span><span class="p">[</span><span class="n">matches</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># send args to other processes</span>

<span class="c1">#DOC ``main``: parse arguments</span>
        <span class="c1"># parse args</span>
        <span class="n">ns_args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;check_memory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;check_memory&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;check_memory&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">check_memory</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># convert from strings to actual args</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;need number of walkers n_walkers</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_cull&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_cull&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_iter_times_fraction_killed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_iter_times_fraction_killed&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_iter_times_fraction_killed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_iter_times_fraction_killed&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_cull&#39;</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;converge_down_to_T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;converge_down_to_T&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_iter&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;converge_down_to_T&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;need either n_iter_times_fraction_killed or converge_down_to_T&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;T_estimate_finite_diff_lag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;T_estimate_finite_diff_lag&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;min_Emax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;min_Emax&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;min_Emax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_species&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start_species&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_config_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start_config_file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_species&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_config_file&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;always need start_species or start_config_file, even if restart_file is specified</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_species&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_config_file&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;can&#39;t specify both start_species and start_config_file</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;restart_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;restart_file&#39;</span><span class="p">,</span> <span class="s1">&#39;AUTO&#39;</span><span class="p">)</span>

        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;max_volume_per_atom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_volume_per_atom&#39;</span><span class="p">,</span> <span class="mf">1.0e3</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;min_volume_per_atom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;min_volume_per_atom&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;snapshot_interval&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;snapshot_time&#39;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_per_parallel_task&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;snapshot_per_parallel_task&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_seq_pairs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;snapshot_seq_pairs&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_clean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;snapshot_clean&#39;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_initialise_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;random_initialise_pos&#39;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_initialise_cell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;random_initialise_cell&#39;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_molecular_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;LAMMPS_molecular_info&#39;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;initial_walk_N_walks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;initial_walk_N_walks&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;initial_walk_adjust_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;initial_walk_adjust_interval&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;initial_walk_Emax_offset_per_atom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;initial_walk_Emax_offset_per_atom&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;initial_walk_only&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;initial_walk_only&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;traj_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;traj_interval&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;E_dump_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;E_dump_interval&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;delta_random_seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;delta_random_seed&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_walk_per_task&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_extra_walk_per_task&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_energy_perturbation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;random_energy_perturbation&#39;</span><span class="p">,</span> <span class="mf">1.0e-12</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;Z_cell_axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Z_cell_axis&#39;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">))</span>

        <span class="c1"># surely there&#39;s a cleaner way of doing this?</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling_per_atom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start_energy_ceiling_per_atom&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling_per_atom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling_per_atom&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># conflict</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;got both start_energy_ceiling and start_energy_ceiling_per_atom</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling_per_atom&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># neither specified, use default</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling_per_atom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0e9</span>
        <span class="k">elif</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># warn on deprecated feature</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;WARNING: got DEPRECATED start_energy_ceiling</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_init_max_n_tries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;random_init_max_n_tries&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>

        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;KEmax_max_T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;KEmax_max_T&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;kB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;kB&#39;</span><span class="p">,</span> <span class="mf">8.6173324e-5</span><span class="p">))</span>  <span class="c1"># eV/K</span>

        <span class="c1"># parse energy_calculator</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;energy_calculator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;energy_calculator&#39;</span><span class="p">,</span> <span class="s1">&#39;fortran&#39;</span><span class="p">)</span>
        <span class="n">do_calc_ASE</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">do_calc_lammps</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">do_calc_internal</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">do_calc_fortran</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;energy_calculator&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ASE&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;ASE_calc_module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ASE_calc_module&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;need ASE calculator module name ASE_calc_module</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">do_calc_ASE</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">elif</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;energy_calculator&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lammps&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">lammpslib</span> <span class="kn">import</span> <span class="n">LAMMPSlib</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;energy_calculator=lammps and failed to import lammpslib module</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">do_calc_lammps</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_init_cmds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;LAMMPS_init_cmds&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;need LAMMPS initialization commands LAMMPS_init_cmds</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;LAMMPS_name&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LAMMPS_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_serial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;LAMMPS_serial&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">))</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;LAMMPS_header&#39;</span><span class="p">,</span> <span class="s1">&#39;units metal; atom_style atomic; atom_modify map array sort 0 0&#39;</span><span class="p">)</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_header_extra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;LAMMPS_header_extra&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_atom_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_fix_gmc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;LAMMPS_fix_gmc&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
            <span class="n">LAMMPS_atom_types</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;LAMMPS_atom_types&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">LAMMPS_atom_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">LAMMPS_atom_types</span> <span class="o">==</span> <span class="s1">&#39;TYPE_EQUALS_Z&#39;</span><span class="p">:</span>
                    <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_atom_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LAMMPS_atom_types</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_atom_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">type_pair</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">LAMMPS_atom_types</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">type_pair</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_atom_types&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;LAMMPS_atom_types is mandatory if calculator type is LAMMPS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;energy_calculator&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;internal&#39;</span><span class="p">:</span>
            <span class="n">do_calc_internal</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">elif</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;energy_calculator&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fortran&#39;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">fortranMCMDpy</span>
            <span class="n">do_calc_fortran</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;FORTRAN_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;FORTRAN_model&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;need FORTRAN model FORTRAN_model</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;FORTRAN_model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;FORTRAN_model_params&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
            <span class="n">f_MC_MD</span> <span class="o">=</span> <span class="n">fortranMCMDpy</span><span class="o">.</span><span class="n">fortran_MC_MD</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;FORTRAN_model&#39;</span><span class="p">])</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;FORTRAN_model_params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
            <span class="n">f_MC_MD</span><span class="o">.</span><span class="n">init_model</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;energy_calculator=</span><span class="si">%s</span><span class="s2"> unknown</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;energy_calculator&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;no_extra_walks_at_all&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;no_extra_walks_at_all&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>

        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;track_configs&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs_write&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;track_configs_write&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>

        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">,</span> <span class="s1">&#39;extxyz&#39;</span><span class="p">)</span>

        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;rng&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;rng&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>

        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;ns_run_analyzers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ns_run_analyzers&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;rng&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">ns_rng</span><span class="o">.</span><span class="n">NsRngNumpy</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;delta_random_seed&#39;</span><span class="p">],</span> <span class="n">comm</span><span class="p">)</span>
        <span class="c1"># elif ns_args[&#39;rng&#39;] == &#39;julia&#39;:</span>
        <span class="c1">#    import julia</span>
        <span class="c1">#    j = julia.Julia()</span>
        <span class="c1">#    rng = ns_rng.NsRngJulia(j)</span>
        <span class="k">elif</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;rng&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rngstream&#39;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">rngstream</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">ns_rng</span><span class="o">.</span><span class="n">NsRngStream</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;delta_random_seed&#39;</span><span class="p">],</span> <span class="n">comm</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;rng&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;internal&#39;</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">ns_rng</span><span class="o">.</span><span class="n">NsRngInternal</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;delta_random_seed&#39;</span><span class="p">],</span> <span class="n">comm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;rng=</span><span class="si">%s</span><span class="s2"> unknown</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;rng&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_calc_fortran</span><span class="p">:</span>
            <span class="n">l_seed</span> <span class="o">=</span> <span class="n">f_MC_MD</span><span class="o">.</span><span class="n">seed_size</span><span class="p">()</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">l_seed</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l_seed</span><span class="p">):</span>
                <span class="c1"># maybe we need a better way of getting max possible int</span>
                <span class="n">seed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">int_uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
            <span class="n">f_MC_MD</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;reproducible&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;reproducible&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;reproducible&#39;</span><span class="p">]:</span>
            <span class="c1"># reset seed after using some random numbers to generate fortran</span>
            <span class="c1"># seed, so that fortran and non-fortran have the same seed</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;rng&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
                <span class="n">rng</span> <span class="o">=</span> <span class="n">ns_rng</span><span class="o">.</span><span class="n">NsRngNumpy</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;delta_random_seed&#39;</span><span class="p">],</span> <span class="n">comm</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;rng&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rngstream&#39;</span><span class="p">:</span>
                <span class="n">rng</span> <span class="o">=</span> <span class="n">ns_rng</span><span class="o">.</span><span class="n">NsRngStream</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;delta_random_seed&#39;</span><span class="p">],</span> <span class="n">comm</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;rng&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;internal&#39;</span><span class="p">:</span>
                <span class="n">rng</span> <span class="o">=</span> <span class="n">ns_rng</span><span class="o">.</span><span class="n">NsRngInternal</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;delta_random_seed&#39;</span><span class="p">],</span> <span class="n">comm</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;rng=</span><span class="si">%s</span><span class="s2"> unknown</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;rng&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">movement_args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls_expected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_model_calls_expected&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_good_load_balance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;do_good_load_balance&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>

        <span class="c1">#DOC \item process n\_atom\_steps</span>
            <span class="c1">#DOC \item If break\_up\_atom\_traj</span>
                <span class="c1">#DOC \item n\_atom\_steps\_per\_call = 1</span>
                <span class="c1">#DOC \item n\_atom\_steps\_n\_calls = n\_atom\_steps</span>
            <span class="c1">#DOC \item else</span>
                <span class="c1">#DOC \item n\_atom\_steps\_per\_call = n\_atom\_steps</span>
                <span class="c1">#DOC \item n\_atom\_steps\_n\_calls = 1</span>

        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_atom_steps&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;atom_traj_len&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len_cost_multiplier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;atom_traj_len_cost_multiplier&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;break_up_atom_traj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;break_up_atom_traj&#39;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps_per_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps_n_calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;break_up_atom_traj&#39;</span><span class="p">]:</span>
                <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps_per_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps_n_calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps_per_call&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps&#39;</span><span class="p">]</span>
                <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps_n_calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_volume_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_cell_volume_steps&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_shear_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_cell_shear_steps&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_stretch_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_cell_stretch_steps&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_swap_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_swap_steps&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_max_cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;swap_max_cluster&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_r_cut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;swap_r_cut&#39;</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_cluster_probability_increment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cluster_probability_increment&#39;</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_velo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;swap_velo&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;no_swap_velo_fix_mag_alt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;no_swap_velo_fix_mag_alt&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>

        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_semi_grand_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_semi_grand_steps&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_semi_grand_steps&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*{([^}]*)}\s*$&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;semi_grand_potentials&#39;</span><span class="p">))</span>
                <span class="n">semi_grand_potentials</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">exit_error</span><span class="p">(</span><span class="s1">&#39;Got n_semi_grand_steps &gt; 0 but no valid semi_grand_potentials</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;semi_grand_potentials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">semi_grand_item</span> <span class="ow">in</span> <span class="n">semi_grand_potentials</span><span class="p">:</span>
                <span class="p">(</span><span class="n">Z_s</span><span class="p">,</span> <span class="n">mu_s</span><span class="p">)</span> <span class="o">=</span> <span class="n">semi_grand_item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;semi_grand_potentials&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">Z_s</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mu_s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;semi_grand_potentials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls_expected&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls_expected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_traj_len_cost_multiplier&#39;</span><span class="p">]</span> <span class="o">+</span>
                                                       <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_volume_steps&#39;</span><span class="p">]</span> <span class="o">+</span>
                                                       <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_shear_steps&#39;</span><span class="p">]</span> <span class="o">+</span>
                                                       <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_stretch_steps&#39;</span><span class="p">]</span> <span class="o">+</span>
                                                       <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_swap_steps&#39;</span><span class="p">])</span>

        <span class="c1"># initialize swap cluster size probabilities</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_probs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_max_cluster&#39;</span><span class="p">]))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_probs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_max_cluster&#39;</span><span class="p">]):</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_probs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_probs&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_cluster_probability_increment&#39;</span><span class="p">]</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_probs&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_probs&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_max_cluster&#39;</span><span class="p">]):</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_probs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_probs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;swap_probs&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls_expected&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Got all of n_model_calls* == 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_atom_steps&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_volume_steps&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_shear_steps&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_cell_stretch_steps&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_swap_steps&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_semi_grand_steps&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Got all of n_steps_* == 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;velo_traj_len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;velo_traj_len&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;atom_algorithm&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Failed to read algorithm for atom motion atom_algorithm&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_algorithm&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;MC&#39;</span> <span class="ow">and</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_algorithm&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;MD&#39;</span> <span class="ow">and</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_algorithm&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;GMC&#39;</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Got unknown atom_algorithm &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_algorithm&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velocities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_atom_velocities&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velocities_pre_perturb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_atom_velocities_pre_perturb&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_step_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_atom_step_size&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_step_size_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_atom_step_size_max&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velo_step_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_atom_velo_step_size&#39;</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velo_step_size_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_atom_velo_step_size_max&#39;</span><span class="p">,</span> <span class="mf">10000.0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_uniform_rv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_atom_uniform_rv&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_Galilean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_atom_Galilean&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_no_reverse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;GMC_no_reverse&#39;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MD&#39;</span> <span class="ow">or</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velocities&#39;</span><span class="p">])</span>
        <span class="c1"># atom_algorithm == GMC is just an alias for atom_algorithm = MC, MC_atom_Galilean = True</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GMC&#39;</span><span class="p">:</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MC&#39;</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_Galilean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;python_MD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;python_MD&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>

        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_velo_pre_perturb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MD_atom_velo_pre_perturb&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_velo_post_perturb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MD_atom_velo_post_perturb&#39;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_velo_flip_accept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MD_atom_velo_flip_accept&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_velo_rej_free_fully_randomize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;atom_velo_rej_free_fully_randomize&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_velo_rej_free_perturb_angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;atom_velo_rej_free_perturb_angle&#39;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_velo_walk_rej_free&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_atom_velo_walk_rej_free&#39;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">))</span>

        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_timestep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MD_atom_timestep&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_timestep_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MD_atom_timestep_max&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_energy_fuzz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MD_atom_energy_fuzz&#39;</span><span class="p">,</span> <span class="mf">1.0e-2</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_atom_reject_energy_violation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MD_atom_reject_energy_violation&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>

        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_P&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_cell_P&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_flat_V_prior&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_cell_flat_V_prior&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>

        <span class="n">default_value</span> <span class="o">=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;max_volume_per_atom&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">20.0</span>  <span class="c1"># 5% of maximum allowed volume per atom</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_volume_per_atom_step_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_cell_volume_per_atom_step_size&#39;</span><span class="p">,</span> <span class="n">default_value</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_volume_per_atom_step_size_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_cell_volume_per_atom_step_size_max&#39;</span><span class="p">,</span> <span class="mf">10.0</span><span class="o">*</span><span class="n">default_value</span><span class="p">))</span>  <span class="c1"># 50% of maximum allowed volume per atom</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_volume_per_atom_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_cell_volume_per_atom_prob&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_stretch_step_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_cell_stretch_step_size&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_stretch_step_size_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_cell_stretch_step_size_max&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_stretch_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_cell_stretch_prob&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_shear_step_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_cell_shear_step_size&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_shear_step_size_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_cell_shear_step_size_max&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_shear_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_cell_shear_prob&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_min_aspect_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_cell_min_aspect_ratio&#39;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;cell_shape_equil_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cell_shape_equil_steps&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;monitor_step_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;monitor_step_interval&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;monitor_step_interval_times_fraction_killed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;monitor_step_interval_times_fraction_killed&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;monitor_step_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;monitor_step_interval_times_fraction_killed&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_cull&#39;</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]))))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;adjust_step_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;adjust_step_interval&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;adjust_step_interval_times_fraction_killed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;adjust_step_interval_times_fraction_killed&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;adjust_step_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;adjust_step_interval_times_fraction_killed&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_cull&#39;</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]))))</span>
<span class="c1">#       if movement_args[&#39;adjust_step_interval&#39;] &lt; 20:</span>
<span class="c1">#           print(&quot;WARNING: step size adjustment would be done too often, at every &quot;, movement_args[&#39;adjust_step_interval&#39;], &quot; iteration&quot;)</span>
<span class="c1">#           print(&quot;WARNING: adjust_step_interval is increased to 20&quot;)</span>
<span class="c1">#           movement_args[&#39;adjust_step_interval&#39;] = 20</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;full_auto_step_sizes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;full_auto_step_sizes&#39;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">))</span>

        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_adjust_step_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_adjust_step_factor&#39;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_adjust_min_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_adjust_min_rate&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_adjust_max_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MC_adjust_max_rate&#39;</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_adjust_min_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;GMC_adjust_min_rate&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_adjust_max_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;GMC_adjust_max_rate&#39;</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_dir_perturb_angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;GMC_dir_perturb_angle&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;GMC_dir_perturb_angle_during&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;GMC_dir_perturb_angle_during&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_adjust_step_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MD_adjust_step_factor&#39;</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_adjust_min_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MD_adjust_min_rate&#39;</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MD_adjust_max_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MD_adjust_max_rate&#39;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">))</span>

        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;2D&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;apply_Z_wall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_to_logical</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;apply_Z_wall&#39;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;apply_Z_wall&#39;</span><span class="p">]:</span>
            <span class="c1"># TODO: RY - the wall_dist should be a parameter and should allow user to change its value</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;wall_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.00</span> <span class="c1"># LIVIA - review this hard coded value </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;wall_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Unknown arguments read in</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ns_args &quot;</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">ns_args</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;movement_args &quot;</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">movement_args</span><span class="p">))</span>

        <span class="c1"># initialize in-situ analyzers</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ns_analyzers</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">analyzer_str</span> <span class="ow">in</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;ns_run_analyzers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">analyzer_name</span><span class="p">,</span> <span class="n">ns_analyzer_interval</span><span class="p">)</span> <span class="o">=</span> <span class="n">analyzer_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">ns_analyzer_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ns_analyzer_interval</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">analyzer_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">analyzer_name</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">analyzer_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;ns_run_analyzers.&quot;</span><span class="o">+</span><span class="n">analyzer_name</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">ns_analyzers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">analyzer_module</span><span class="o">.</span><span class="n">NSAnalyzer</span><span class="p">(</span><span class="n">comm</span><span class="p">),</span> <span class="n">ns_analyzer_interval</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Got NSAnalyzer from&quot;</span><span class="p">,</span> <span class="n">analyzer_name</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s2">&quot;ns_analyzer_interval&quot;</span><span class="p">,</span> <span class="n">ns_analyzer_interval</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to get NSAnalyzer from&quot;</span><span class="p">,</span> <span class="n">analyzer_name</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no ns_run_analyzers set&quot;</span><span class="p">)</span>
            <span class="n">ns_analyzers</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># initialise potential</span>
        <span class="k">if</span> <span class="n">do_calc_ASE</span><span class="p">:</span>
            <span class="n">pot</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;ASE_calc_module&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">calc</span>
        <span class="k">elif</span> <span class="n">do_calc_internal</span> <span class="ow">or</span> <span class="n">do_calc_fortran</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">do_calc_lammps</span><span class="p">:</span>
            <span class="n">init_cmds</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_init_cmds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)]</span>
            <span class="n">header_cmds</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)]</span>
            <span class="n">header_extra_cmds</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_header_extra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_serial&#39;</span><span class="p">]:</span>
                <span class="n">lammps_comm</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lammps_comm</span> <span class="o">=</span> <span class="n">calculator_comm</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">pot</span> <span class="o">=</span> <span class="n">LAMMPSlib</span><span class="p">(</span><span class="n">lmpcmds</span><span class="o">=</span><span class="n">init_cmds</span><span class="p">,</span> <span class="n">atom_types</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_atom_types&#39;</span><span class="p">],</span> <span class="n">log_file</span><span class="o">=</span><span class="s1">&#39;lammps.</span><span class="si">%d</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="n">rank</span><span class="p">,</span> <span class="n">keep_alive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lammps_name</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_name&#39;</span><span class="p">],</span>
                                <span class="n">lammps_header</span><span class="o">=</span><span class="n">header_cmds</span><span class="p">,</span> <span class="n">lammps_header_extra</span><span class="o">=</span><span class="n">header_extra_cmds</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">lammps_comm</span><span class="p">,</span> <span class="n">read_molecular_info</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_molecular_info&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pot</span> <span class="o">=</span> <span class="n">LAMMPSlib</span><span class="p">(</span><span class="n">lmpcmds</span><span class="o">=</span><span class="n">init_cmds</span><span class="p">,</span> <span class="n">atom_types</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_atom_types&#39;</span><span class="p">],</span> <span class="n">keep_alive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lammps_name</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_name&#39;</span><span class="p">],</span>
                                <span class="n">lammps_header</span><span class="o">=</span><span class="n">header_cmds</span><span class="p">,</span> <span class="n">lammps_header_extra</span><span class="o">=</span><span class="n">header_extra_cmds</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">lammps_comm</span><span class="p">,</span> <span class="n">read_molecular_info</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_molecular_info&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PRE START_LAMMPS&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">pot</span><span class="o">.</span><span class="n">start_lammps</span><span class="p">()</span>  <span class="c1"># so top level things like units will be set</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;POST START_LAMMPS&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">pot</span><span class="o">.</span><span class="n">first_propagate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Need some way of initializing calculator</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># figure out numbers of local walkers</span>
        <span class="n">rank_of_walker</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">n_walkers</span> <span class="o">=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_walkers_per_task</span> <span class="o">=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]</span><span class="o">//</span><span class="n">size</span>  <span class="c1"># using // ensures division gives an integer value</span>
            <span class="k">if</span> <span class="n">n_walkers_per_task</span><span class="o">*</span><span class="n">size</span> <span class="o">!=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]:</span>
                <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;number of walkers </span><span class="si">%d</span><span class="s2"> not divisible by number of MPI processes </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">],</span> <span class="n">size</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">last_walker</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i_rank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                <span class="n">first_walker</span> <span class="o">=</span> <span class="n">last_walker</span>
                <span class="n">last_walker</span> <span class="o">=</span> <span class="n">last_walker</span> <span class="o">+</span> <span class="n">n_walkers_per_task</span>
                <span class="k">if</span> <span class="n">last_walker</span> <span class="o">&gt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]:</span>
                    <span class="n">last_walker</span> <span class="o">=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i_rank</span> <span class="o">==</span> <span class="n">rank</span><span class="p">:</span>
                    <span class="n">n_walkers</span> <span class="o">=</span> <span class="n">last_walker</span><span class="o">-</span><span class="n">first_walker</span>
                    <span class="n">my_first_walker</span> <span class="o">=</span> <span class="n">first_walker</span>
                    <span class="n">my_last_walker</span> <span class="o">=</span> <span class="n">last_walker</span>
                <span class="k">if</span> <span class="n">last_walker</span> <span class="o">&gt;</span> <span class="n">first_walker</span><span class="p">:</span>
                    <span class="n">rank_of_walker</span><span class="p">[</span><span class="n">first_walker</span><span class="p">:</span><span class="n">last_walker</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i_rank</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">last_walker</span><span class="o">-</span><span class="n">first_walker</span><span class="p">)</span>

        <span class="c1"># figure out number of configs that will be culled on each task</span>
        <span class="n">n_cull</span> <span class="o">=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_cull&#39;</span><span class="p">]</span>
        <span class="n">n_extra_walk_per_task</span> <span class="o">=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_walk_per_task&#39;</span><span class="p">]</span>
        <span class="n">max_n_cull_per_task</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_cull</span><span class="o">/</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_n_cull_per_task</span> <span class="o">*</span> <span class="n">size</span> <span class="o">!=</span> <span class="n">n_cull</span><span class="p">:</span>
            <span class="n">max_n_cull_per_task</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># internal model, LJ eps=1, sigma=1, cutoff=3, with PBC cube l=pbc[0,0]</span>
        <span class="n">internal_cutoff</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="n">Eshift</span> <span class="o">=</span> <span class="n">internal_cutoff</span><span class="o">**-</span><span class="mi">12</span> <span class="o">-</span> <span class="n">internal_cutoff</span><span class="o">**-</span><span class="mi">6</span>

        <span class="n">set_n_from_expected</span><span class="p">(</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using n_model_calls = &quot;</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">])</span>

        <span class="c1"># create list of species, and check for possible problems</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">species_list</span> <span class="o">=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">species_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">init_atoms</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_config_file&#39;</span><span class="p">],</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">atomic_numbers</span> <span class="o">=</span> <span class="n">init_atoms</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">Z</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">atomic_numbers</span><span class="p">):</span>
                    <span class="n">n_of_Z</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">atomic_numbers</span> <span class="o">==</span> <span class="n">Z</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;masses&#39;</span> <span class="ow">in</span> <span class="n">init_atoms</span><span class="o">.</span><span class="n">arrays</span><span class="p">:</span>
                        <span class="n">mass_of_Z</span> <span class="o">=</span> <span class="n">init_atoms</span><span class="o">.</span><span class="n">get_masses</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">atomic_numbers</span> <span class="o">==</span> <span class="n">Z</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">species_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">n_of_Z</span><span class="p">,</span> <span class="n">mass_of_Z</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">species_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">n_of_Z</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">species_list</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">species_list</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">do_calc_lammps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_atom_types&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TYPE_EQUALS_Z&#39;</span><span class="p">:</span>
                <span class="n">used_chem_symbols</span> <span class="o">=</span> <span class="p">{</span><span class="n">ase</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chemical_symbols</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_list</span><span class="p">}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">used_chem_symbols</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;LAMMPS_atom_types&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;species in start_species must correspond to those in LAMMPS_atom_types</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">mass_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Z_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">warned_explicit_mass</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_list</span><span class="p">:</span>
            <span class="n">species_fields</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">Z_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">species_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">warned_explicit_mass</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;WARNING: setting masses explicitly. Not recommended, do only if you&#39;re sure it&#39;s necessary</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">warned_explicit_mass</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">type_mass</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">species_fields</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">mass_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_mass</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mass_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mass_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mass_list</span> <span class="o">!=</span> <span class="n">mass_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_velo_rej_free_fully_randomize&#39;</span><span class="p">]:</span>
                <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;ERROR: Masses are not all equal, and atom_velo_rej_free_fully_randomize is false. Refusing to produce incorrect results</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">created_temp_restart_file</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;restart_file&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DOING restart_file=AUTO&quot;</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">glob</span>
                <span class="n">sfx</span> <span class="o">=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">]</span>

                <span class="c1"># try to match .0. or .ALL., but using sloppy regexp</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;checking snapshots glob&quot;</span><span class="p">,</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">snapshot.[0-9]*.[0A]*.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">],</span> <span class="n">sfx</span><span class="p">)))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">newest_snapshot</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">snapshot.[0-9]*.[0A]*.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">],</span> <span class="n">sfx</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;restarting from &quot;</span><span class="p">,</span> <span class="n">newest_snapshot</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;\.ALL\.</span><span class="si">%s</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="n">sfx</span><span class="p">,</span> <span class="n">newest_snapshot</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># latest snapshot is a combined one for all nodes</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;snapshot is combined for all nodes&quot;</span><span class="p">)</span>
                        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;restart_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newest_snapshot</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">snapshot_root</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;\.0\.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sfx</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">newest_snapshot</span><span class="p">)</span>
                        <span class="n">restart_file</span> <span class="o">=</span> <span class="n">snapshot_root</span><span class="o">+</span><span class="s2">&quot;.ALL.&quot;</span><span class="o">+</span><span class="n">sfx</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;creating combined snapshot file&quot;</span><span class="p">,</span> <span class="n">restart_file</span><span class="p">,</span> <span class="s2">&quot;from&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">tf</span> <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.[0-9]*.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">snapshot_root</span><span class="p">,</span> <span class="n">sfx</span><span class="p">))])</span>
                        <span class="n">created_temp_restart_file</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">restart_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">snapshot_out</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">snapshot_file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.[0-9]*.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">snapshot_root</span><span class="p">,</span> <span class="n">sfx</span><span class="p">)):</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">snapshot_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">snapshot_in</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">snapshot_in</span><span class="p">:</span>
                                        <span class="n">snapshot_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;restart_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">restart_file</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no snapshot files found&quot;</span><span class="p">)</span>
                    <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;restart_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;restart_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;restart_file&#39;</span><span class="p">],</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># set up walkers</span>
        <span class="n">walkers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;restart_file&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># start from scratch</span>
            <span class="n">start_first_iter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># create initial config</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_config_file&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">init_atoms</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_config_file&#39;</span><span class="p">],</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;masses&#39;</span> <span class="ow">in</span> <span class="n">init_atoms</span><span class="o">.</span><span class="n">arrays</span><span class="p">:</span>
                        <span class="n">init_atoms</span><span class="o">.</span><span class="n">set_masses</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">init_atoms</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># create atoms structs from a list of atomic numbers and numbers of atoms</span>
                    <span class="c1"># always create it slightly smaller than the max to avoid numerical instability with nearly identical volumes</span>
                    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
                        <span class="n">lc</span> <span class="o">=</span> <span class="mf">0.999</span><span class="o">*</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;max_volume_per_atom&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;Z_cell_axis&#39;</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
                        <span class="n">init_atoms</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">Atoms</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;Z_cell_axis&#39;</span><span class="p">]),</span> <span class="n">pbc</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lc</span> <span class="o">=</span> <span class="mf">0.999</span><span class="o">*</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;max_volume_per_atom&#39;</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
                        <span class="n">init_atoms</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">Atoms</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">lc</span><span class="p">),</span> <span class="n">pbc</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_list</span><span class="p">:</span>
                        <span class="n">species_fields</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">type_Z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">species_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">type_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">species_fields</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">init_atoms</span> <span class="o">+=</span> <span class="n">ase</span><span class="o">.</span><span class="n">Atoms</span><span class="p">([</span><span class="n">type_Z</span><span class="p">]</span> <span class="o">*</span> <span class="n">type_n</span><span class="p">,</span> <span class="n">masses</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">type_n</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">type_mass</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">species_fields</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">init_atoms</span> <span class="o">+=</span> <span class="n">ase</span><span class="o">.</span><span class="n">Atoms</span><span class="p">([</span><span class="n">type_Z</span><span class="p">]</span> <span class="o">*</span> <span class="n">type_n</span><span class="p">,</span> <span class="n">masses</span><span class="o">=</span><span class="p">[</span><span class="n">type_mass</span><span class="p">]</span> <span class="o">*</span> <span class="n">type_n</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Each entry in start_species must include atomic number, multiplicity, and optionally mass&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

                    <span class="n">init_atoms</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">init_atoms</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">init_atoms</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">),</span> <span class="n">scale_atoms</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">init_atoms</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">])</span>
                <span class="c1"># ase.io.write(sys.stdout, init_atoms, format=ns_args[&#39;config_file_format&#39;])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># rank != 0</span>
                <span class="n">init_atoms</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># bcast atoms created on rank == 0</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">init_atoms</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">init_atoms</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># create extra data arrays if needed</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">init_atoms</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">init_atoms</span><span class="p">),</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">])</span> <span class="p">)</span>

            <span class="c1"># clone initial config into array of walkers</span>
            <span class="k">for</span> <span class="n">i_walker</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">):</span>
                <span class="n">walkers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">init_atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

            <span class="c1"># set up data structures to track configs as they are cloned and evolve</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">config_ind</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">config_ind</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="o">*</span><span class="n">n_walkers</span>
            <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_ind</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;from_config_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">config_ind</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">do_calc_ASE</span> <span class="ow">or</span> <span class="n">do_calc_lammps</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">pot</span>

            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cur_config_ind</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="n">n_walkers</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_config_ind</span> <span class="o">=</span> <span class="n">n_walkers</span>

            <span class="c1"># V should have prob distrib p(V) = V^N.</span>
            <span class="c1"># Using transformation rule p(y) = p(x) |dx/dy|, with p(y) = y^N and p(x) = 1,</span>
            <span class="c1">#       one gets dx/dy = y^N</span>
            <span class="c1">#                x = y^{N+1}</span>
            <span class="c1">#                y = x^{1/(N+1)}</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling_per_atom&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling_per_atom&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">init_atoms</span><span class="p">)</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_P&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;max_volume_per_atom&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">init_atoms</span><span class="p">)</span>
            <span class="c1"># initial positions are just random, up to an energy ceiling</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i_at</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">walkers</span><span class="p">):</span>
                <span class="c1"># randomize cell if P is set, both volume (from appropriate distribution) and shape (from uniform distribution with min aspect ratio limit)</span>

                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_initialise_cell&#39;</span><span class="p">]:</span>
                    <span class="n">energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_P&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
                            <span class="n">lc</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">)</span><span class="o">*</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;max_volume_per_atom&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;Z_cell_axis&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
                            <span class="n">temp_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">lc</span>
                            <span class="n">temp_cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;Z_cell_axis&#39;</span><span class="p">]</span>
                            <span class="n">at</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span> <span class="n">temp_cell</span> <span class="p">)</span>
                            <span class="n">do_cell_shape_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lc</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">)</span><span class="o">*</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;max_volume_per_atom&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
                            <span class="n">at</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">lc</span> <span class="p">)</span>
                            <span class="n">do_cell_shape_walk</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_initialise_pos&#39;</span><span class="p">]:</span>
                    <span class="c1"># random initial positions</span>
                    <span class="n">energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
                    <span class="n">n_try</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">n_try</span> <span class="o">&lt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_init_max_n_tries&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="ow">or</span> <span class="n">energy</span> <span class="o">&gt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">]):</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">set_scaled_positions</span><span class="p">(</span> <span class="n">rng</span><span class="o">.</span><span class="n">float_uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]:</span>  <span class="c1"># zero the Z coordiates in a 2D simulation</span>
                            <span class="n">temp_at</span><span class="o">=</span><span class="n">at</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
                            <span class="n">temp_at</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                            <span class="n">at</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">temp_at</span><span class="p">)</span>
                        <span class="n">energy</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
                        <span class="n">n_try</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="ow">or</span> <span class="n">energy</span> <span class="o">&gt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">]:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;WARNING: rank </span><span class="si">%d</span><span class="s2"> failed to generate initial config by random positions under max energy </span><span class="si">%f</span><span class="s2"> in </span><span class="si">%d</span><span class="s2"> tries</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">],</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_init_max_n_tries&#39;</span><span class="p">]))</span>

                    <span class="c1"># try FORTRAN config initializer</span>
                    <span class="n">n_try</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">do_calc_fortran</span><span class="p">:</span>
                        <span class="k">while</span> <span class="n">n_try</span> <span class="o">&lt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_init_max_n_tries&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="ow">or</span> <span class="n">energy</span> <span class="o">&gt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">]):</span>
                            <span class="n">f_MC_MD</span><span class="o">.</span><span class="n">init_config</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_P&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;max_volume_per_atom&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">init_atoms</span><span class="p">))</span>
                            <span class="n">energy</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
                            <span class="n">n_try</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="ow">or</span> <span class="n">energy</span> <span class="o">&gt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">]:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;WARNING: rank </span><span class="si">%d</span><span class="s2"> failed to generate initial config by fortran config initializer under max energy </span><span class="si">%f</span><span class="s2"> in </span><span class="si">%d</span><span class="s2"> tries</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">],</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_init_max_n_tries&#39;</span><span class="p">]))</span>

                    <span class="c1"># try python config initializer</span>
                    <span class="n">n_try</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">n_try</span> <span class="o">&lt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_init_max_n_tries&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="ow">or</span> <span class="n">energy</span> <span class="o">&gt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">]):</span>
                        <span class="n">energy</span> <span class="o">=</span> <span class="n">additive_init_config</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">])</span>
                        <span class="n">n_try</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># quit if failed to generate acceptable config</span>
                    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="ow">or</span> <span class="n">energy</span> <span class="o">&gt;</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">]:</span>
                        <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;Rank </span><span class="si">%d</span><span class="s2"> failed to generate initial config by random, fortran, or (atom by atom addition) python initializer under max energy </span><span class="si">%f</span><span class="s2"> in </span><span class="si">%d</span><span class="s2"> tries each</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;start_energy_ceiling&#39;</span><span class="p">],</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_init_max_n_tries&#39;</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>

                <span class="n">energy</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand_perturb_energy</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_energy_perturbation&#39;</span><span class="p">])</span>
                <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span>

            <span class="c1"># Done initialising atomic positions. Now initialise momenta</span>

            <span class="c1"># set KEmax from P and Vmax</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;KEmax_max_T&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">KEmax</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;kB&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;KEmax_max_T&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_P&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">KEmax</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_P&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;max_volume_per_atom&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;do_velocities is set, but neither KEmax_max_T nor MC_cell_P are &gt; 0, so no heuristic for setting KEmax&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;KEmax&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">KEmax</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">KEmax</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

            <span class="c1"># set initial velocities, rejection free</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">:</span>
                    <span class="n">rej_free_perturb_velo</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">)</span> <span class="c1"># adds KE to at.info[&#39;ns_energy&#39;]</span>

            <span class="c1"># swap atomic numbers if doing semi-grand canonical ensemble</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;swap_atomic_numbers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_semi_grand_steps&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># set up walkers with a restart</span>
            <span class="c1"># swap atomic numbers if doing semi-grand canonical ensemble</span>
            <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;swap_atomic_numbers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_semi_grand_steps&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">at_list</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;restart_file&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>  <span class="c1"># LIVIA</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="n">r</span><span class="p">:</span>
                    <span class="n">walkers</span> <span class="o">=</span> <span class="n">at_list</span><span class="p">[</span><span class="n">r</span><span class="o">*</span><span class="n">n_walkers</span><span class="p">:(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n_walkers</span><span class="p">]</span>  <span class="c1"># TODO: RBW – split walkers on different processes? maybe we need to set things up (energies?) before splitting?</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">walkers</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">()</span>
                          <span class="o">!=</span> <span class="n">walkers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">()):</span>
                    <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;swap_atomic_numbers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># broadcast swap_atomic_numbers in case it was overridden to True</span>
            <span class="c1"># by presence of configurations with different atomic number lists</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;swap_atomic_numbers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span>
                    <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;swap_atomic_numbers&#39;</span><span class="p">],</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cur_config_ind</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="n">n_walkers</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_config_ind</span> <span class="o">=</span> <span class="n">n_walkers</span>
                <span class="k">if</span> <span class="s1">&#39;config_ind&#39;</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                    <span class="n">max_config_ind</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;config_ind&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">max_config_ind</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">MAX</span><span class="p">)</span>
                    <span class="n">cur_config_ind</span> <span class="o">=</span> <span class="n">max_config_ind</span><span class="o">+</span><span class="mi">1</span>

            <span class="c1"># Calculate ns_energy for manual surface configurations from restart</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># print(&quot;RBW: calc ns_energy for man surf configs from restart&quot;) # debug</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">i_at</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">walkers</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">do_calc_ASE</span> <span class="ow">or</span> <span class="n">do_calc_lammps</span><span class="p">:</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">set_calculator</span><span class="p">(</span><span class="n">pot</span><span class="p">)</span>
                    <span class="n">energy</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand_perturb_energy</span><span class="p">(</span>
                        <span class="n">energy</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_energy_perturbation&#39;</span><span class="p">])</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                <span class="n">KEmax</span> <span class="o">=</span> <span class="n">walkers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;KEmax&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">KEmax</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

            <span class="c1"># Set init velocities for manual surface configurations from restart</span>
            <span class="c1"># RBW checked this and seed-averaged initial total energies are ~</span>
            <span class="c1"># the same, which means velocities *seem* to be set properly</span>
            <span class="c1"># LBP: only perturb if this is a &quot;fake&quot; restart to start a surface sim.</span>
            <span class="c1">#       proper restart does not need perturbation as that messes up KE</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">walkers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;iter&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># print(&quot;RBW: set init vels for man surf configs from restart&quot;) # debug</span>
                <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_velocities&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">:</span>
                        <span class="c1"># TODO: RBW – make sure surface restart files contain KEmax calculated from number of free atoms, otherwise, their kinetic energy can be inefficiently high</span>
                        <span class="n">energy</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
                        <span class="n">rej_free_perturb_velo</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">KEmax</span><span class="p">)</span>
                        <span class="c1"># adds KE to at.info[&#39;ns_energy&#39;]</span>
                        <span class="n">energy</span> <span class="o">=</span> <span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="s1">&#39;ns_extra_data&#39;</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">arrays</span> <span class="ow">or</span> <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">]):</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;ns_extra_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_extra_data&#39;</span><span class="p">])</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">do_calc_ASE</span> <span class="ow">or</span> <span class="n">do_calc_lammps</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">pot</span>
                <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand_perturb_energy</span><span class="p">(</span><span class="n">eval_energy</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;random_energy_perturbation&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="s1">&#39;iter&#39;</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                    <span class="n">start_first_iter</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;iter&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: no iteration number information was found &quot;</span>
                          <span class="s2">&quot;in the restart file&quot;</span><span class="p">)</span>
                    <span class="n">exit_error</span><span class="p">(</span><span class="s2">&quot;no iteration number information was found in &quot;</span>
                               <span class="s2">&quot;the restart file</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

                <span class="n">key_found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                    <span class="c1"># check if &#39;volume=&#39; info is present in the file used for</span>
                    <span class="c1"># restart</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;volume&#39;</span><span class="p">:</span>
                        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_volume_per_atom_step_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">10.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">))</span>
                        <span class="n">key_found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">key_found</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;WARNING: no volume information was found in the restart file. If volume changes will be done, the starting stepsize will be the default&quot;</span><span class="p">)</span>
                    
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># add GMC direction if needed</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_GMC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;atom_algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MC&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_Galilean&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;do_GMC&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;GMC_direction&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;GMC_direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>

        <span class="c1"># scale initial MC_atom_step_size by max_vol^(1/3)</span>
        <span class="n">max_lc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;max_volume_per_atom&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_step_size&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">max_lc</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_atom_step_size_max&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">max_lc</span>
        <span class="c1"># scale MC_cell_shear_step_size by max_vol^1.0)</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_shear_step_size&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">max_lc</span>
        <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;MC_cell_shear_step_size_max&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">max_lc</span>

        <span class="k">if</span> <span class="n">ns_analyzers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ns_analyzer</span><span class="p">,</span> <span class="n">ns_analyzer_interval</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ns_analyzers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ns_analyzer_interval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ns_analyzer</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;initial_walk start&quot;</span><span class="p">)</span>
        <span class="c1"># do initial walks if needed</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;initial_walk_N_walks&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;restart_file&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;doing initial_walks&quot;</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;initial_walk_N_walks&#39;</span><span class="p">])</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="p">(</span><span class="n">Emax</span><span class="p">,</span> <span class="n">Vmax</span><span class="p">,</span> <span class="n">cull_rank</span><span class="p">,</span> <span class="n">cull_ind</span><span class="p">)</span> <span class="o">=</span> <span class="n">max_energy</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># WARNING: this assumes that all walkers have same numbers of atoms</span>
            <span class="n">Emax</span> <span class="o">=</span> <span class="n">Emax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;initial_walk_Emax_offset_per_atom&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># do full walks, not shortened walks that account for NS algorithm</span>
            <span class="c1"># parallelization</span>
            <span class="n">save_n_model_calls</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">]</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls_expected&#39;</span><span class="p">]</span>

            <span class="n">walk_stats_adjust</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">zero_stats</span><span class="p">(</span><span class="n">walk_stats_adjust</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i_initial_walk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;initial_walk_N_walks&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;initial walk start iter &quot;</span><span class="p">,</span> <span class="n">i_initial_walk</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span>
                          <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span>
                <span class="n">print_prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> initial_walk </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">i_initial_walk</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">i_initial_walk</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i_initial_walk</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;initial_walk_adjust_interval&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># first adjust is after first walk</span>
                    <span class="c1"># could be done before first walk if full_auto_set_stepsize</span>
                    <span class="c1"># didn&#39;t need walk_stats</span>
                    <span class="n">full_auto_set_stepsizes</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="n">walk_stats_adjust</span><span class="p">,</span>
                                            <span class="n">movement_args</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                    <span class="n">walk_stats_adjust</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">zero_stats</span><span class="p">(</span><span class="n">walk_stats_adjust</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">)</span>

                <span class="k">for</span> <span class="p">(</span><span class="n">i_at</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">walkers</span><span class="p">):</span>
                    <span class="n">print_prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> initial_walk </span><span class="si">%d</span><span class="s2"> at </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">i_initial_walk</span><span class="p">,</span> <span class="n">i_at</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rank</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">cProfile</span>
                        <span class="n">pr</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
                        <span class="n">walk_stats</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">runcall</span><span class="p">(</span><span class="n">walk_single_walker</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="o">=</span><span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="o">=</span><span class="n">Emax</span><span class="p">,</span> <span class="n">KEmax</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">pr</span><span class="o">.</span><span class="n">dump_stats</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;initial_walk.profile.stats&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">walk_stats</span> <span class="o">=</span> <span class="n">walk_single_walker</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">movement_args</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">accumulate_stats</span><span class="p">(</span><span class="n">walk_stats_adjust</span><span class="p">,</span> <span class="n">walk_stats</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ns_analyzers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">ns_analyzer</span><span class="p">,</span> <span class="n">ns_analyzer_interval</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ns_analyzers</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ns_analyzer_interval</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ns_analyzer_interval</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i_initial_walk</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">ns_analyzer_interval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">ns_analyzer</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;initial_walk </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i_initial_walk</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_interval&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i_initial_walk</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;snapshot_interval&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">save_snapshot</span><span class="p">(</span><span class="n">i_initial_walk</span><span class="o">-</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;initial_walk_N_walks&#39;</span><span class="p">])</span>

            <span class="c1"># restore walk lengths for rest of NS run</span>
            <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;n_model_calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_n_model_calls</span>

            <span class="p">(</span><span class="n">KEmax</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">max_energy</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kinetic_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;initial_walk_only&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">MPI</span><span class="o">.</span><span class="n">Finalize</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">walkers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># do NS</span>

        <span class="c1"># open the file where the trajectory will be printed</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;restart_file&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># start from scratch, so if this file exists, overwrite it</span>
            <span class="n">traj_io</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;traj.</span><span class="si">%d</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">]),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs_write&#39;</span><span class="p">]:</span>
                <span class="n">track_traj_io</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;track_traj.</span><span class="si">%d</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">]),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">track_traj_io</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># restart, so the existing file should be appended</span>
            <span class="c1"># concatenate existing traj file to before restart</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;truncating traj file to start_first_iter&quot;</span><span class="p">,</span>
                  <span class="n">start_first_iter</span><span class="p">)</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;r+&quot;</span>
            <span class="k">if</span> <span class="n">movement_args</span><span class="p">[</span><span class="s1">&#39;keep_atoms_fixed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;a+&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;traj.</span><span class="si">%d</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">]),</span> <span class="n">mode</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">prev_pos</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># loop this way with &quot;while True&quot; and &quot;f.readline()&quot; because directly looping over f does not </span>
                <span class="c1"># set position reported by f.tell() to end of line</span>
                <span class="c1"># make sure there&#39;s somplace to truncate to if traj file has only one config and it&#39;s already too late</span>
                <span class="n">prev_pos</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">prev_prev_pos</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\biter=(\d+)\b&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cur_iter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">cur_iter</span> <span class="o">&gt;=</span> <span class="n">start_first_iter</span><span class="p">:</span>
                            <span class="c1"># rewind back to two lines back, before start of this config</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">prev_prev_pos</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
                            <span class="k">break</span>
                    <span class="n">prev_prev_pos</span> <span class="o">=</span> <span class="n">prev_pos</span>
                    <span class="n">prev_pos</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">traj_io</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;traj.</span><span class="si">%d</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">]),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;track_configs_write&#39;</span><span class="p">]:</span>
                <span class="n">track_traj_io</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;track_traj.</span><span class="si">%d</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;config_file_format&#39;</span><span class="p">]),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">track_traj_io</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Read the existing traj file and look for the point where we restart from. Truncate the rest.</span>
            <span class="c1"># This part is not used because the ASE.io.read takes soooo long, that it makes a restart impossible.</span>
            <span class="c1">#traj_io = open(ns_args[&#39;out_file_prefix&#39;]+&#39;traj.%d.%s&#39; % (rank, ns_args[&#39;config_file_format&#39;]), &quot;r+&quot;)</span>
            <span class="c1">#i = 0</span>
            <span class="c1">#while True:</span>
            <span class="c1">#    at=(ase.io.read(traj_io, format=ns_args[&#39;config_file_format&#39;],index=i))</span>
            <span class="c1">#   print(&quot;ASE.io.read trajectory&quot;, rank, i, at.info[&#39;iter&#39;])</span>
            <span class="c1">#    if at.info[&#39;iter&#39;] &gt;= start_first_iter:</span>
            <span class="c1">#         at=(ase.io.read(traj_io, format=ns_args[&#39;config_file_format&#39;],index=i-1))</span>
            <span class="c1">#         traj_io.truncate()</span>
            <span class="c1">#         break</span>
            <span class="c1">#    i += 1</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;E_dump_interval&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">E_dump_io</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;E_dump&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">E_dump_io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;n_walkers </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;n_walkers&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">E_dump_io</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># open the file where the energies will be printed</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;restart_file&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># start from scratch, so if this file exists, overwrite it</span>
                <span class="n">energy_io</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;energies&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># restart, so the existing file should be appended</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">energy_io</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;energies&#39;</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span>
                    <span class="n">tmp_iter</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">energy_io</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>  <span class="c1"># read the first line of nwalker,ncull..etc information</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># we do create an infinite loop here :(</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">energy_io</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>            <span class="c1"># read lines one by one</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>                           <span class="c1"># something went wrong, exit the infinit loop</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: end of .energies file reached without finding the iteration number&quot;</span><span class="p">,</span> <span class="n">start_first_iter</span><span class="p">)</span>
                            <span class="k">break</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;reading .energies file line </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">n_cull</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                    <span class="c1"># if this is n_cull-th line, examine the stored iteration</span>
                            <span class="n">tmp_split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                            <span class="n">tmp_iter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp_split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>       <span class="c1"># tmp_iter contains the iteration number of the line as an integer number</span>
                        <span class="k">if</span> <span class="n">tmp_iter</span> <span class="o">==</span> <span class="n">start_first_iter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>   <span class="c1"># if this is the iteration same as in the snapshot,</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;truncating energy file at line &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                            <span class="n">energy_io</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>                <span class="c1">#delete the rest of the file, as we are restarting from here</span>
                            <span class="k">break</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: got restart file, but no corresponding energies file, so creating new one from scratch&quot;</span><span class="p">)</span>
                    <span class="n">energy_io</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;energies&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rank</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;if&quot;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">cProfile</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
            <span class="n">final_iter</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">runcall</span><span class="p">(</span><span class="n">do_ns_loop</span><span class="p">)</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">dump_stats</span><span class="p">(</span><span class="n">ns_args</span><span class="p">[</span><span class="s1">&#39;out_file_prefix&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;profile.stats&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;else&quot;</span><span class="p">)</span>
            <span class="n">final_iter</span> <span class="o">=</span> <span class="n">do_ns_loop</span><span class="p">()</span>

        <span class="c1"># cleanup post loop</span>
        <span class="n">save_snapshot</span><span class="p">(</span><span class="n">final_iter</span><span class="p">)</span>  <span class="c1"># this is the final configuration</span>

        <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">walkers</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: final energy &quot;</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ns_energy&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">energy_io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">traj_io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">track_traj_io</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">track_traj_io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">E_dump_io</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">E_dump_io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">MPI</span><span class="o">.</span><span class="n">Finalize</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Nested sampling method</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation and quick start guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getstart.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ns_run.html"><cite>pymatnest</cite> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ns_rng.html"><cite>ns_rng</cite> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rngstream.html"><cite>rngstream</cite> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lammpslib.html"><cite>lammpslib</cite> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stacktrace.html"><cite>stacktrace</cite> module</a></li>
</ul>

  </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">ns_doc 1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ns_run</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2015, livia.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    </div>
  </body>
</html>